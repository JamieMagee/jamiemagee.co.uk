<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.152.2"><meta charset=utf-8><link href=https://gmpg.org/xfn/11 rel=profile><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Jamie Magee &#183; Programmer, Engineer, Problem Solver</title><link rel=preload href=/css/poole.css as=style><link rel=preload href=/css/hyde.css as=style><link rel=preload href=/css/poole-overrides.css as=style><link rel=preload href=/css/hyde-overrides.css as=style><link rel=preload href=/css/hyde-x.css as=style><link rel=preload href=/fonts/BerkeleyMono-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" as=style crossorigin><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css as=style crossorigin><link rel=preload href=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js as=script crossorigin><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/poole-overrides.css><link rel=stylesheet href=/css/hyde-overrides.css><link rel=stylesheet href=/css/hyde-x.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" crossorigin><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css crossorigin><style>@font-face{font-family:berkeley mono;src:url(/fonts/BerkeleyMono-Regular.woff2)format('woff2');font-display:swap}.lite-youtube-fallback{aspect-ratio:16/9;display:flex;justify-content:center;align-items:center;flex-direction:column;gap:1em;padding:1em;background-color:#000;color:#fff;text-decoration:none;border-radius:8px;transition:background-color .2s ease}.lite-youtube-fallback:hover{background-color:#333;color:#fff}.lite-youtube-fallback::before{display:block;content:'';border:solid transparent;border-width:2em 0 2em 3em;border-left-color:red;transition:border-left-color .2s ease}.lite-youtube-fallback:hover::before{border-left-color:#fff}.lite-youtube-fallback:focus{outline:2px solid red;outline-offset:2px}</style><link rel=stylesheet href=/css/jamie.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><link rel=alternate type=application/rss+xml href=/index.xml title="Jamie Magee"><meta name=description content><meta name=keywords content><meta name=author content="Jamie Magee"><meta name=robots content="index, follow"><link rel=canonical href=/><meta property="og:url" content="/"><meta property="og:site_name" content="Jamie Magee"><meta property="og:title" content="Jamie Magee"><meta property="og:locale" content="en_gb"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jamie Magee"><script type=module src=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js></script></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><div class=sidebar-head><h1><a href=/>Jamie Magee</a></h1></div><p class=lead>Programmer, Engineer, Problem Solver</p></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a></li><li class=sidebar-nav-item><a href=/about>About</a></li><li class=sidebar-nav-item><a href=/blog>Archive</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/JamieMagee><i class="fa-brands fa-github-square fa-3x"></i></a>
<a href=https://bsky.app/profile/jamiemagee.bsky.social><i class="fa-brands fa-square-bluesky fa-3x"></i></a>
<a href=https://www.linkedin.com/in/jamiemagee1/><i class="fa-brands fa-linkedin fa-3x"></i></a>
<a href=/index.xml type=application/rss+xml><i class="fa-solid fa-rss-square fa-3x"></i></a></li></ul><p>&copy; 2025. <a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></p></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=/blog/maintaining-aur-packages-with-renovate/>Maintaining AUR packages with Renovate</a></h1><span class=post-date>Mar 16, 2023 &#183; 5 minute read</span><p>One big advantage that Arch Linux has over other distributions, apart from being able to say “BTW I use Arch.”, is the Arch User Repository (AUR). It’s a community-driven repository with over 80,000 packages. If you’re looking for a package, chances are you&rsquo;ll find it in the AUR.</p><p>Keeping all those packages up to date, takes a lot of manual effort by a lot of volunteers. People have created and used tools, like <a href=https://github.com/thp/urlwatch><code>urlwatch</code></a> and <a href=https://github.com/eli-schwartz/aurpublish><code>aurpublish</code></a>, to let them know when upstream releases are cut and automate some parts of the process. I know I do. But I wanted to automate the entire process. I think <a href=https://github.com/renovatebot/renovate/>Renovate</a> can help here.</p><h2 id=updating-versions-with-renovate>Updating versions with Renovate</h2><p>Renovate is an automated dependency update tool. You might have seen it opening pull requests on GitHub and making updates for npm or other package managers, but it’s a lot more powerful than just that.</p><p>Renovate has a couple of concepts that I need to explain first: <a href=https://docs.renovatebot.com/modules/datasource>datasources</a> and <a href=https://docs.renovatebot.com/modules/manager/>managers</a>. Datasources define where to look for new versions of a dependency. Renovate comes with over 50 different datasources, but the one that is important for AUR packages is the <a href=https://docs.renovatebot.com/modules/datasource/#git-tags-datasource><code>git-tags</code> datasource</a>. Managers are the Renovate concept for package managers. There isn’t an AUR or <code>PKGBUILD</code> manager, but there is a <a href=https://docs.renovatebot.com/modules/manager/regex/>regex manager</a> that I can use.</p><p>I can create a <code>renovate.json</code> configuration with the following regex manager configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#0550ae>&#34;regexManagers&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      <span style=color:#0550ae>&#34;fileMatch&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span><span style=color:#0a3069>&#34;(^|/)PKGBUILD$&#34;</span><span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#0550ae>&#34;matchStrings&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#0a3069>&#34;pkgver=(?&lt;currentValue&gt;.*) # renovate: datasource=(?&lt;datasource&gt;.*) depName=(?&lt;depName&gt;.*)&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#0550ae>&#34;extractVersionTemplate&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;^v?(?&lt;version&gt;.*)$&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>Breaking that down:</p><ul><li>The <code>fileMatch</code> setting tells Renovate to look for any <code>PKGBUILD</code> files in a repository</li><li>The <code>matchStrings</code> is the regex format to extract the version, datasource, and dependency name from the <code>PKGBUILD</code></li><li>The <code>extractVersionTemplate</code> is to handle a “v” in front of any version number that is sometimes added to Git tags</li></ul><p>And here’s an extract from the PKGBUILD for the <a href=https://aur.archlinux.org/packages/bicep-bin>bicep-bin</a> AUR package that I maintain:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#953800>pkgver</span><span style=color:#0550ae>=</span>0.15.31 <span style=color:#57606a># renovate: datasource=github-tags depName=Azure/bicep</span>
</span></span></code></pre></div><p>Here I’m configuring Renovate to use the <a href=https://docs.renovatebot.com/modules/datasource/github-tags/><code>github-tags</code></a> datasource and to look in the <a href=https://github.com/Azure/bicep><code>Azure/bicep</code> GitHub repository</a> for new versions. That means it’ll look in the <a href=https://github.com/Azure/bicep/tags>list of tags for the <code>Azure/bicep</code> repository</a> for any new versions. If Renovate finds any new versions, it’ll automatically update the <code>PKGBUILD</code> and open a pull request with the updated version.</p><p>So I’ve automated the <code>PKGBUILD</code> update, but that’s only half of the work. The checksums and <code>.SRCINFO</code> must be updated before pushing to the AUR. Unfortunately, Renovate can’t do that (yet, see <a href=https://github.com/renovatebot/renovate/issues/16923>Renovate issue #16923</a>), but GitHub Actions can!</p><h2 id=updating-checksums-and-srcinfo-with-github-actions>Updating checksums and <code>.SRCINFO</code> with GitHub Actions</h2><p>Updating the checksums with <code>updpkgsums</code> is easy, and generating an updated <code>.SRCINFO</code> with <code>makepkg --printsrcinfo > .SRCINFO</code> is straightforward too. But doing that for a whole repository of AUR packages is going to be a little trickier. So let me build up the GitHub actions workflow step-by-step.</p><p>First, I only want to run this workflow on pull requests targeting the <code>main</code> branch.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#0550ae>on</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>pull_request</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#fff>    </span><span style=color:#0550ae>types</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fff>      </span>- opened<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#fff>      </span>- synchronize<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#fff>    </span><span style=color:#0550ae>branches</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#fff>      </span>- main<span style=color:#fff>
</span></span></span></code></pre></div><p>Next, I’m going to need to check out the entire history of the repository, so I can compare the files changed in the latest commit with the Git history.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#0550ae>jobs</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>updpkgsums</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#fff>    </span><span style=color:#0550ae>runs-on</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>ubuntu-latest<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fff>    </span><span style=color:#0550ae>steps</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#fff>      </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Checkout<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#fff>        </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c<span style=color:#fff> </span><span style=color:#57606a># v3.3.0</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#fff>        </span><span style=color:#0550ae>with</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#fff>          </span><span style=color:#0550ae>fetch-depth</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#fff>          </span><span style=color:#0550ae>ref</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ github.ref }}<span style=color:#fff>
</span></span></span></code></pre></div><p>Getting the package that changed in a pull request requires a little bit of shell magic.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Find updated package<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>run</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>|</span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#0a3069>    #!/usr/bin/env bash
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#0a3069>    set -euxo pipefail
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#0a3069>    echo &#34;pkgbuild=$(git diff --name-only origin/main origin/${GITHUB_HEAD_REF} &#34;*PKGBUILD&#34; | head -1 | xargs dirname)&#34; &gt;&gt; $GITHUB_ENV</span><span style=color:#fff>
</span></span></span></code></pre></div><p>Now I’ve found the package that changed in the Renovate pull request, I can update the files.</p><p>This step in the workflow uses a private GitHub Action that I have in my <code>aur-packages</code> repository. I’m not going to break it down here, but at its core it runs <code>updpkgsums</code> and <code>makepkg --printsrcinfo > .SRCINFO</code> with a little extra configuration required to run Arch Linux on GitHub Actions runners. You can <a href=https://github.com/JamieMagee/aur-packages/tree/main/.github/actions/aur>check out the full code on GitHub</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Validate package<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>if</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ env.pkgbuild != &#39;&#39; }}<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#fff>  </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>./.github/actions/aur<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fff>  </span><span style=color:#0550ae>with</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#fff>    </span><span style=color:#0550ae>action</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;updpkgsums&#39;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#fff>    </span><span style=color:#0550ae>pkgname</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ env.pkgbuild }}<span style=color:#fff>
</span></span></span></code></pre></div><p>Finally, once the <code>PKGBUILD</code> and <code>.SRCINFO</code> are updated I need to commit that change back to the pull request.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Commit<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>if</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ env.pkgbuild != &#39;&#39; }}<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#fff>  </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>stefanzweifel/git-auto-commit-action@3ea6ae190baf489ba007f7c92608f33ce20ef04a<span style=color:#fff> </span><span style=color:#57606a># v4.16.0</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fff>  </span><span style=color:#0550ae>with</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#fff>    </span><span style=color:#0550ae>file_pattern</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;*/PKGBUILD */.SRCINFO&#39;</span><span style=color:#fff>
</span></span></span></code></pre></div><p>Check out <a href=https://github.com/JamieMagee/aur-packages/pull/62>this pull request for <code>bicep-bin</code></a> where Renovate opened a pull request, and my GitHub Actions workflow updated the <code>b2sums</code> in the <code>PKGBUILD</code> and updated the <code>.SRCINFO</code>.</p><p>But why stop there? Let’s talk about publishing.</p><h2 id=publishing-to-the-aur>Publishing to the AUR</h2><p>Each AUR package is its own Git repository. So to update a package in the AUR, I only need to push a new commit with the updated <code>PKGBUILD</code> and <code>.SRCINFO</code>. Thankfully, <a href=https://github.com/KSXGitHub>KSXGitHub</a> created the <a href=https://github.com/KSXGitHub/github-actions-deploy-aur><code>github-actions-deploy-aur</code> GitHub Action</a> to streamline the whole process.</p><p>If I create a new GitHub Actions workflow to publish to the AUR, I can reuse the first two steps from my previous workflow to check out the repository and find the updated package. Then all I need to do is to use the <code>github-actions-deploy-aur</code> GitHub Action:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Publish package<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>KSXGitHub/github-actions-deploy-aur@065b6056b25bdd43830d5a3f01899d0ff7169819<span style=color:#fff> </span><span style=color:#57606a># v2.6.0</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#fff>  </span><span style=color:#0550ae>if</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ env.pkgbuild != &#39;&#39; }}<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fff>  </span><span style=color:#0550ae>with</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#fff>    </span><span style=color:#0550ae>pkgname</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ env.pkgbuild }}<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#fff>    </span><span style=color:#0550ae>pkgbuild</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ env.pkgbuild }}/PKGBUILD<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#fff>    </span><span style=color:#0550ae>commit_username</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ secrets.AUR_USERNAME }}<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#fff>    </span><span style=color:#0550ae>commit_email</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ secrets.AUR_EMAIL }}<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#fff>    </span><span style=color:#0550ae>ssh_private_key</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ secrets.AUR_SSH_PRIVATE_KEY }}<span style=color:#fff>
</span></span></span></code></pre></div><h3 id=all-together-now>All together now</h3><p>If you own any AUR packages and want to automate some of the maintenance burden, check out <a href=https://github.com/JamieMagee/aur-packages-template/>my AUR packages template GitHub repository</a>. It contains all of the steps I showed in this blog post. And if you want to see how it works in practice, check out <a href=https://github.com/JamieMagee/aur-packages>my AUR packages GitHub repository</a>.</p></div><div class=post><h1 class=post-title><a href=/blog/scanning-windows-container-images-is-surprisingly-easy/>Scanning Windows container images is (surprisingly) easy!</a></h1><span class=post-date>Jan 2, 2023 &#183; 5 minute read</span><p>When it comes to Linux containers, there are plenty of tools out there that can scan container images, generate Software Bill of Materials (SBOM), or list vulnerabilities. However, Windows container images are more like the forgotten stepchild in the container ecosystem. And that means we’re forgetting the countless developers using Windows containers, too.</p><p>I wanted to see what I’d need to make scanning tools for Windows container images. Turns out it’s pretty easy. So easy, in fact, I think the existing container tools should add support for Windows container images.</p><h2 id=what-version-of-windows-am-i-running>What version of Windows am I running?</h2><p>The first question I needed to answer was: what version of Windows was the container image based on? This tells me what date the container image is from, what updates are applicable, and what vulnerabilities it has.</p><p>Container images are really just <code>tar</code> files, and Windows container images are no different. So first I saved a Windows container image locally using skopeo:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ skopeo --insecure-policy --override-os windows copy docker://mcr.microsoft.com/windows/nanoserver:ltsc2022 dir:///tmp/nanoserver
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ ls /tmp/nanoserver
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>0db1879370e5c72dae7bff5d013772cbbfb95f30bfe1660dcef99e0176752f1c  7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858 manifest.json version
</span></span></code></pre></div><p>Next, I inspected the manifest using jq to find the layer that had the Windows files.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ jq . manifest.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#0a3069>&#34;schemaVersion&#34;</span>: 2,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#0a3069>&#34;mediaType&#34;</span>: <span style=color:#0a3069>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#0a3069>&#34;config&#34;</span>: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#0a3069>&#34;mediaType&#34;</span>: <span style=color:#0a3069>&#34;application/vnd.docker.container.image.v1+json&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#0a3069>&#34;size&#34;</span>: 638,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#0a3069>&#34;digest&#34;</span>: <span style=color:#0a3069>&#34;sha256:0db1879370e5c72dae7bff5d013772cbbfb95f30bfe1660dcef99e0176752f1c&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#0550ae>}</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#0a3069>&#34;layers&#34;</span>: <span style=color:#0550ae>[</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#0a3069>&#34;mediaType&#34;</span>: <span style=color:#0a3069>&#34;application/vnd.docker.image.rootfs.foreign.diff.tar&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#0a3069>&#34;size&#34;</span>: 304908800,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#0a3069>&#34;digest&#34;</span>: <span style=color:#0a3069>&#34;sha256:7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#0550ae>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#0550ae>}</span>
</span></span></code></pre></div><p>I then extracted the layer and fixed the permissions.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ mkdir layer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>$ tar -xf 7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858 -C ./layer/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>$ sudo find ./layer -type f -exec chmod <span style=color:#0550ae>0644</span> <span style=color:#0550ae>{}</span> <span style=color:#0a3069>\;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>$ sudo find ./layer -type d -exec chmod <span style=color:#0550ae>0755</span> <span style=color:#0550ae>{}</span> <span style=color:#0a3069>\;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>$ ls -lah layer/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>total 16K
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>drwxr-xr-x <span style=color:#0550ae>4</span> jamie users 4.0K Dec <span style=color:#0550ae>28</span> 15:05 .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>drwxr-xr-x <span style=color:#0550ae>3</span> jamie users 4.0K Dec <span style=color:#0550ae>28</span> 15:00 ..
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>drwxr-xr-x <span style=color:#0550ae>5</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:18 Files
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>drwxr-xr-x <span style=color:#0550ae>3</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:22 UtilityVM
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>$ ls -lah layer/Files/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>total 28K
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>drwxr-xr-x  <span style=color:#0550ae>5</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:18 .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>drwxr-xr-x  <span style=color:#0550ae>4</span> jamie users 4.0K Dec <span style=color:#0550ae>28</span> 15:05 ..
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>-rw-r--r--  <span style=color:#0550ae>1</span> jamie users 5.6K Dec  <span style=color:#0550ae>9</span> 01:18 License.txt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>drwxr-xr-x  <span style=color:#0550ae>4</span> jamie users 4.0K May  <span style=color:#0550ae>7</span>  <span style=color:#0550ae>2021</span> ProgramData
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>drwxr-xr-x  <span style=color:#0550ae>6</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:19 Users
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>drwxr-xr-x <span style=color:#0550ae>20</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:19 Windows
</span></span></code></pre></div><p>Inside the extracted layer there are two directories: <code>Files</code> and <code>UtilityVM</code>. <code>Files</code> had the filesystem of the Windows container image, while <code>UtilityVM</code> is used by Hyper-V behind the scenes. So I just needed to focus on <code>Files</code>.</p><p>How did I figure out the specific version of Windows the container is running? From the registry of course! The <code>SOFTWARE</code> registry hive contained information about installed software, including Windows itself, and was found at <code>Files/Windows/System32/config/SOFTWARE</code>.</p><p>Thankfully, there’s a great NuGet package called <a href=https://github.com/EricZimmerman/Registry>Registry</a> that let me easily load and parse the registry, but there are also packages for <a href=https://pkg.go.dev/golang.org/x/sys/windows/registry>Go</a>, <a href=https://github.com/bbqsrc/registry-rs>Rust</a>, and even <a href=https://github.com/ironSource/node-regedit>Node.js</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Registry</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#cf222e>var</span> registryHive <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> RegistryHive<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;/tmp/nanoserver/layer/Files/Windows/System32/config/SOFTWARE&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>registryHive<span style=color:#1f2328>.</span>ParseHive<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#cf222e>var</span> currentVersion <span style=color:#1f2328>=</span> registryHive<span style=color:#1f2328>.</span>GetKey<span style=color:#1f2328>(</span><span style=color:#0a3069>@&#34;Microsoft\Windows NT\CurrentVersion&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#cf222e>var</span> fullVersion <span style=color:#1f2328>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#0a3069>$&#34;{currentVersion.GetValue(&#34;</span>CurrentMajorVersionNumber<span style=color:#0a3069>&#34;)}.{currentVersion.GetValue(&#34;</span>CurrentMinorVersionNumber<span style=color:#0a3069>&#34;)}.{currentVersion.GetValue(&#34;</span>CurrentBuildNumber<span style=color:#0a3069>&#34;)}.{currentVersion.GetValue(&#34;</span>UBR<span style=color:#0a3069>&#34;)}&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>Console<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span>fullVersion<span style=color:#1f2328>);</span>
</span></span></code></pre></div><p>Running this code, I got version <code>10.0.20348.1366</code> which was <a href=https://twitter.com/ChangeWindows/status/1602752823116333056>apparently released on 13th December 2022</a>.</p><h2 id=what-about-windows-updates>What about Windows updates?</h2><p>The version of Windows doesn’t tell the whole story. There are also updates that can be applied on top. You might have seen them referred to by their KB number, for example KB1234567. Information on what updates have been applied is also stored in the registry.</p><p>By extending my earlier code, I can find out what updates this container image has.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>var</span> packages <span style=color:#1f2328>=</span> registryHive<span style=color:#1f2328>.</span>GetKey<span style=color:#1f2328>(</span><span style=color:#0a3069>@&#34;Microsoft\Windows\CurrentVersion\Component Based Servicing\Packages&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>var</span> updatePackageRegex <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Regex<span style=color:#1f2328>(</span><span style=color:#0a3069>@&#34;^Package_\d+_for_(KB\d+)~\w{16}~\w+~~((?:\d+\.){3}\d+)$&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#cf222e>var</span> updates <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Dictionary<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>string</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>string</span><span style=color:#1f2328>&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#cf222e>foreach</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> packageKey <span style=color:#cf222e>in</span> packages<span style=color:#1f2328>.</span>SubKeys<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(!</span>updatePackageRegex<span style=color:#1f2328>.</span>IsMatch<span style=color:#1f2328>(</span>packageKey<span style=color:#1f2328>.</span>KeyName<span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#cf222e>continue</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#cf222e>var</span> currentState <span style=color:#1f2328>=</span> packageKey<span style=color:#1f2328>.</span>Values<span style=color:#1f2328>.</span>Find<span style=color:#1f2328>(</span>v <span style=color:#1f2328>=&gt;</span> v<span style=color:#1f2328>.</span>ValueName <span style=color:#1f2328>==</span> <span style=color:#0a3069>&#34;CurrentState&#34;</span><span style=color:#1f2328>)?.</span>ValueData<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#57606a>// Installed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>currentState <span style=color:#1f2328>==</span> <span style=color:#0a3069>&#34;112&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#cf222e>var</span> groups <span style=color:#1f2328>=</span> updatePackageRegex<span style=color:#1f2328>.</span>Match<span style=color:#1f2328>(</span>packageKey<span style=color:#1f2328>.</span>KeyName<span style=color:#1f2328>).</span>Groups<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        updates<span style=color:#1f2328>[</span>groups<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>Value<span style=color:#1f2328>]</span> <span style=color:#1f2328>=</span> groups<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>Value<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#cf222e>foreach</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> update <span style=color:#cf222e>in</span> updates<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    Console<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span><span style=color:#0a3069>$&#34;{update.Key}: {update.Value}&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>Running this gave me a single update: <code>KB5020373: 20348.1300.1.0</code>. Searching online for <a href=https://support.microsoft.com/en-gb/topic/november-8-2022-kb5020613-cumulative-update-for-net-framework-3-5-and-4-8-for-windows-10-version-20h2-windows-10-version-21h1-windows-10-version-21h2-and-windows-10-version-22h2-3880a78d-3b33-429a-93fc-eeb0c40b4ad4>KB5020373</a> led me to the documentation for the update. It’s the November 2022 security update for .NET Framework and has a fix for <a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-41064>CVE-2022-41064</a>.</p><h2 id=done-now-what-if-we-scaled-this>Done! &mldr;Now what if we scaled this?</h2><p>It turns out it’s not that difficult to find out info about Windows container images. It took me a couple of hours to figure out, but that’s only because no one seems to have done this before. The actual code is only about 30 lines.</p><p>Windows containers are widely used for legacy applications, like .NET Framework applications, that haven’t been rewritten but could benefit from the cloud. All of the big three cloud providers offer managed Kubernetes services that support Windows nodes out of the box (yes, <a href=https://kubernetes.io/docs/concepts/windows/intro/#windows-os-version-support>Kubernetes supports Windows nodes</a>). There is clearly a demand for Windows containers, but there is a gap in the kind of container tooling that has sprung up for Linux containers.</p><p>Instead of allowing this gap to widen further, I think that container tool authors—especially SBOM tools and vulnerability scanners—should add support for Windows container images. These tools should then correlate the extracted information with the <a href=https://api.msrc.microsoft.com/cvrf/v2.0/swagger/index>Microsoft Security Research Center (MSRC) API</a>. MSRC publishes information every month on security updates. Comparing the Windows version from a container image with the fixed versions provided by the MSRC API, you could easily see your container image’s security vulnerabilities.</p><p>As my proof-of-concept has shown, it’s low-hanging fruit. A small addition that would have a big impact for the many forgotten developers and the applications they work on.</p></div><div class=post><h1 class=post-title><a href=/blog/making-the-most-of-github-rate-limits/>Making the most of GitHub rate limits</a></h1><span class=post-date>Jul 26, 2022 &#183; 6 minute read</span><p>The GitHub documentation has a lot of good advice about rate limits for its API, and how to make the most of them. However, since using the GitHub API, there are some things I’ve discovered that the documentation doesn’t cover, or doesn’t cover so well.</p><h2 id=conditional-requests>Conditional requests</h2><p>This topic is actually covered very well in <a href=https://docs.github.com/en/rest/overview/resources-in-the-rest-api#conditional-requests>the GitHub documentation</a>. To summarise, all REST API requests will return <code>ETag</code> headers, and most will return <code>Last-Modified</code>. You can make use of these by making subsequent requests with the <code>If-None-Match</code> and <code>If-Modified-Since</code> headers respectively. If the resource hasn’t been modified, you’ll get back a <code>304 Not Modified</code> response, and the request won&rsquo;t count against your rate limit.</p><p>To show you what I mean, here’s a short example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ curl -I -H <span style=color:#0a3069>&#34;Authorization: token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/user
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#0a3069>&lt; HTTP/2 200
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#0a3069>&lt; etag: &#34;</span>0c05f6422602a76a6671b28fc70af0ff9775ee41c80aca7d527814bb79a0fc2c<span style=color:#0a3069>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#0a3069>&lt; last-modified: Mon, 21 Feb 2022 17:25:59 GMT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#0a3069>&lt; x-ratelimit-limit: 5000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#0a3069>&lt; x-ratelimit-remaining: 4993
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#0a3069>&lt; x-ratelimit-reset: 1645482669
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#0a3069></span>$<span style=color:#0a3069> curl -I -H &#34;</span>If-None-Match: <span style=color:#0a3069>\&#34;</span>0c05f6422602a76a6671b28fc70af0ff9775ee41c80aca7d527814bb79a0fc2c<span style=color:#0a3069>\&#34;</span><span style=color:#0a3069>&#34; -H &#34;</span>Authorization: token ...<span style=color:#0a3069>&#34; &#34;</span>https://api.github.com/user<span style=color:#0a3069>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#0a3069>&lt; HTTP/2 304
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#0a3069>&lt; etag: &#34;</span>0c05f6422602a76a6671b28fc70af0ff9775ee41c80aca7d527814bb79a0fc2c<span style=color:#0a3069>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#0a3069>&lt; last-modified: Mon, 21 Feb 2022 17:25:59 GMT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#0a3069>&lt; x-ratelimit-limit: 5000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#0a3069>&lt; x-ratelimit-remaining: 4993
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#0a3069>&lt; x-ratelimit-reset: 1645482669
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#0a3069></span>$<span style=color:#0a3069> curl -I -H &#34;</span>If-Modified-Since: Mon, <span style=color:#0550ae>21</span> Feb <span style=color:#0550ae>2022</span> 17:25:59 GMT<span style=color:#0a3069>&#34; -H &#34;</span>Authorization: token ...<span style=color:#0a3069>&#34; &#34;</span>https://api.github.com/user<span style=color:#0a3069>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#0a3069>&lt; HTTP/2 304
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#0a3069>&lt; last-modified: Mon, 21 Feb 2022 17:25:59 GMT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#0a3069>&lt; x-ratelimit-limit: 5000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#0a3069>&lt; x-ratelimit-remaining: 4993
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#0a3069>&lt; x-ratelimit-reset: 1645482669
</span></span></span></code></pre></div><p>The first request uses one request of my rate limit, taking it from 4994 to 4993. But the next two requests use <code>If-None-Match</code> and <code>If-Modified-Since</code> headers, so my rate limit is still 4993.</p><p>Unfortunately, conditional requests are only available for the REST API. HTTP caching over GraphQL is <a href=https://www.apollographql.com/blog/backend/caching/graphql-caching-the-elephant-in-the-room/>not a simple problem</a>, and it’s unlikely that GitHub will ever support it.</p><h2 id=prefer-if-modified-since>Prefer <code>If-Modified-Since</code></h2><p>The GitHub REST API documentation covers conditional requests pretty well. The reason I&rsquo;m mentioning it? Well, the documentation says that you can use <code>ETag</code> or <code>If-Modified-Since</code> interchangeably—but they&rsquo;re not equivalent. Take a look at this example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -I -H <span style=color:#0a3069>&#34;Authorization:token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/repos/renovatebot/renovate/releases/latest&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>&lt; HTTP/2 <span style=color:#0550ae>200</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>&lt; etag: <span style=color:#0a3069>&#34;70eb55000ec3e69bc2d88079714612000a955d4afaf02643b6602d99fb60dd8d&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>&lt; last-modified: Mon, <span style=color:#0550ae>21</span> Feb <span style=color:#0550ae>2022</span> 21:47:30 GMT
</span></span></code></pre></div><p>And if I make the same request a little bit later…</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -I -H <span style=color:#0a3069>&#34;Authorization:token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/repos/renovatebot/renovate/releases/latest&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>&lt; HTTP/2 <span style=color:#0550ae>200</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>&lt; etag: <span style=color:#0a3069>&#34;85f04330d7bca80e6e0d62ac1b41b6d57e2ff11744565655e46732d44736dba6&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>&lt; last-modified: Mon, <span style=color:#0550ae>21</span> Feb <span style=color:#0550ae>2022</span> 21:47:30 GMT
</span></span></code></pre></div><p>The ETag is different but the Last-Modified time is still the same as before. Based on <a href=https://stackoverflow.com/questions/28060116/which-is-more-reliable-for-github-api-conditional-requests-etag-or-last-modifie/57309763#57309763>this StackOverflow question</a>, it appears as if this has been an issue for a while. So if a response has both an <code>ETag</code> and a <code>Last-Modified</code> time, I’d recommend using the <code>Last-Modified</code> time to make conditional requests.</p><h2 id=both-rest-and-graphql>Both REST and GraphQL</h2><p>Saying “rate limit” isn’t really accurate. What I actually mean is “rate limits”. GitHub actually has nine different rate limits. Some are for very specific use cases, like <a href=https://docs.github.com/en/developers/apps/building-github-apps/creating-a-github-app-from-a-manifest#3-you-exchange-the-temporary-code-to-retrieve-the-app-configuration><code>integration_manifest</code></a> for the GitHub App Manifest code conversion endpoint. But the two that are most useful are <code>core</code> (AKA REST) and <code>graphql</code>.</p><p>If I make a request to the <a href=https://docs.github.com/en/rest/rate-limit>rate limit endpoint</a>, you can see all the different rate limits.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#0550ae>&#34;resources&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#0550ae>&#34;core&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#0550ae>&#34;search&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>30</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>30</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656978223</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#0550ae>&#34;graphql&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>38</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>4962</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656979534</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#0550ae>&#34;integration_manifest&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#0550ae>&#34;source_import&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656978223</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    <span style=color:#0550ae>&#34;code_scanning_upload&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#0550ae>&#34;actions_runner_registration&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>10000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>10000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    <span style=color:#0550ae>&#34;scim&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>15000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>15000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#0550ae>&#34;dependency_snapshots&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656978223</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>  <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>  <span style=color:#0550ae>&#34;rate&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>    <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>The REST API has a rate limit of <a href=https://docs.github.com/en/rest/overview/resources-in-the-rest-api#rate-limiting>5000 requests per hour</a>. Separately, the GraphQL API has a rate limit of <a href=https://docs.github.com/en/graphql/overview/resource-limitations#rate-limit>5000 points per hour</a>.</p><p>Depending on what API calls you want to make, you can intelligently split them across the REST and GraphQL APIs to achieve a higher overall limit. For example, if a GraphQL call is going to cost a lower number of points than the number of REST calls required to get the same data, you should make those calls via the GraphQL API. You should also bear in mind that you can make conditional requests to the REST API, but not to the GraphQL API.</p><h2 id=maximise-page-size>Maximise page size</h2><p>Whenever you’re making a request to an endpoint with pagination, you should check what the maximum results per page are and set your query parameter to that size.</p><p>The default size for most endpoints is 30 results, but the maximum size is often 100. If you forget to set this you might need to make four times as many requests to get the same number of results.</p><h2 id=use-sorting>Use sorting</h2><p>Most API calls allow you to sort them based on a date field when querying an endpoint. If you use this—and do some caching on your end as well—you can avoid having to fetch all pages for a request whenever you have a cache request.</p><p>For example, if you need to fetch the most recently changed pull requests for a repository, you should be sorting by <code>updated</code> and storing a local cache of pull requests. That way a conditional request cache miss won’t require you to fetch all the pages of a request. You can compare each page to your local cache, and only fetch the next page if required.</p><h2 id=use-head-requests>Use <code>HEAD</code> requests</h2><p>This tip isn’t strictly about rate limits, but is useful when you’re eking out every last bit of performance. Nearly all GitHub REST API endpoints support <code>HEAD</code> requests, in addition to the other HTTP verbs. If you’re already using conditional requests, you can avoid having the body of a request sent over the wire by sending a <code>HEAD</code> request instead.</p><p>For example, here’s the header and body size for a <code>GET</code> request:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -w <span style=color:#0a3069>\%</span><span style=color:#0550ae>{</span>size_header<span style=color:#0550ae>}</span>:<span style=color:#0a3069>\%</span><span style=color:#0550ae>{</span>size_download<span style=color:#0550ae>}</span> -s -o /dev/null -H <span style=color:#0a3069>&#34;Authorization:token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/repos/renovatebot/renovate/releases&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1448:137229
</span></span></code></pre></div><p>And here’s the header and body size for the <code>HEAD</code> equivalent:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -w <span style=color:#0a3069>\%</span><span style=color:#0550ae>{</span>size_header<span style=color:#0550ae>}</span>:<span style=color:#0a3069>\%</span><span style=color:#0550ae>{</span>size_download<span style=color:#0550ae>}</span> -s -o /dev/null -H <span style=color:#0a3069>&#34;Authorization:token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/repos/renovatebot/renovate/releases&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1448:0
</span></span></code></pre></div><p>By making a <code>HEAD</code> request instead of a <code>GET</code> request, you can avoid being sent 137KB.</p><p>There is a trade-off, though. If you use conditional requests and have a cache miss, you’ll have to make the <code>GET</code> request anyway.</p><h2 id=summing-up>Summing up</h2><p>Using these methods I’ve managed to eke out every bit of performance of the GitHub API for my integrations. Let me know what methods you use, or if there’s anything I’ve missed.</p></div><div class=post><h1 class=post-title><a href=/blog/writing-github-bots-in-net/>Writing GitHub bots in .NET</a></h1><span class=post-date>Mar 4, 2022 &#183; 5 minute read</span><p>For a while now the Octokit libraries for .NET have lagged behind the JavaScript libraries, especially when it comes to webhooks. Unfortunately, I needed a GitHub webhook client for an internal project, so I had to write my own. It wasn’t too much extra effort to open source it, and thus <a href=https://github.com/octokit/webhooks.net>Octokit.Webhooks</a> was born!</p><p>I wanted to give a quick example of how to get up and running with <code>Octokit.Webhooks</code>, and what better way than to write a small GitHub bot?</p><h2 id=setup>Setup</h2><p>For this project, I’m going to be using <a href=https://dotnet.microsoft.com/en-us/download/dotnet/6.0>.NET 6.0</a> and <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis?view=aspnetcore-6.0">ASP.NET’s new minimal APIs</a> to simplify setup. From a terminal I’m going to create a new web API project:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dotnet new webapi --output octokit-webhooks-sample
</span></span></code></pre></div><p>The default template is set up to be a weather forecast API, but I can simplify it a bit more for this sample. My <code>Program.cs</code> looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>var</span> builder <span style=color:#1f2328>=</span> WebApplication<span style=color:#1f2328>.</span>CreateBuilder<span style=color:#1f2328>(</span>args<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#cf222e>var</span> app <span style=color:#1f2328>=</span> builder<span style=color:#1f2328>.</span>Build<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>app<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>();</span>
</span></span></code></pre></div><p>Next up I’m going to install the <a href=https://www.nuget.org/packages/Octokit.Webhooks.AspNetCore/>Octokit.Webhooks.AspNetCore</a> package:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dotnet add package Octokit.Webhooks.AspNetCore
</span></span></code></pre></div><p>This package consumes the Octokit.Webhooks package, which contains core functionality like deserializers and processors, and adds ASP.NET Core specific code, like automatic API endpoint mapping and shared secret verification.</p><h2 id=handling-webhooks>Handling webhooks</h2><p>Now that I’ve got my project set up, I need to create my own processor to handle incoming webhooks. <code>Octokit.Webhooks</code> ships with an abstract class called <code>WebhookEventProcessor</code> that does all the heavy lifting of deserializing incoming webhooks. All I need to do is to create my own class that inherits from it, and write some logic to act on the webhook events.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks.Events</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks.Events.IssueComment</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>sealed</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>MyWebhookEventProcessor</span> <span style=color:#1f2328>:</span> WebhookEventProcessor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> ILogger<span style=color:#1f2328>&lt;</span>MyWebhookEventProcessor<span style=color:#1f2328>&gt;</span> logger<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#cf222e>public</span> MyWebhookEventProcessor<span style=color:#1f2328>(</span>ILogger<span style=color:#1f2328>&lt;</span>MyWebhookEventProcessor<span style=color:#1f2328>&gt;</span> logger<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>logger <span style=color:#1f2328>=</span> logger<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#cf222e>protected</span> <span style=color:#cf222e>override</span> Task ProcessIssueCommentWebhookAsync<span style=color:#1f2328>(</span>WebhookHeaders headers<span style=color:#1f2328>,</span> IssueCommentEvent issueCommentEvent<span style=color:#1f2328>,</span> IssueCommentAction action<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>logger<span style=color:#1f2328>.</span>LogInformation<span style=color:#1f2328>(</span>issueCommentEvent<span style=color:#1f2328>.</span>Comment<span style=color:#1f2328>.</span>Body<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>CompletedTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>I created a small class <code>MyWebhookEventProcessor</code> that inherits from <code>WebhookEventProcessor</code>, and has an override for <code>ProcessIssueCommentWebhookAsync</code> that logs out the comment body. I also get the headers and the action passed to this method, so I could write a switch case and have different handling for created, edited, and deleted actions, but this is enough for now.</p><p>I also need to hook up <code>MyWebhookEventProcessor</code> in my startup class.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks.AspNetCore</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#cf222e>var</span> builder <span style=color:#1f2328>=</span> WebApplication<span style=color:#1f2328>.</span>CreateBuilder<span style=color:#1f2328>(</span>args<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>builder<span style=color:#1f2328>.</span>Services<span style=color:#1f2328>.</span>AddSingleton<span style=color:#1f2328>&lt;</span>WebhookEventProcessor<span style=color:#1f2328>,</span> MyWebhookEventProcessor<span style=color:#1f2328>&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#cf222e>var</span> app <span style=color:#1f2328>=</span> builder<span style=color:#1f2328>.</span>Build<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>app<span style=color:#1f2328>.</span>UseRouting<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>app<span style=color:#1f2328>.</span>UseEndpoints<span style=color:#1f2328>(</span>endpoints <span style=color:#1f2328>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  endpoints<span style=color:#1f2328>.</span>MapGitHubWebhooks<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>app<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>();</span>
</span></span></code></pre></div><p>This is enough to tell ASP.NET to hook up dependency injection for <code>MyWebhookEventProcessor</code>, enable routing. It will also automatically add a route to handle incoming GitHub webhooks. By default it’s exposed at <code>/api/github/webhooks</code>, but you can use any route you’d like. <code>MapGitHubWebhooks</code> also accepts a shared secret which allows you to verify the content signature of GitHub webhooks.</p><p>That’s all the code required on my side. Now I just need to expose my service to the internet, and configure GitHub to start sending me webhooks.</p><h2 id=github-webhook-configuration>GitHub webhook configuration</h2><p>For GitHub to be able to send me webhooks, my service needs to be publicly accessible to the internet. I recently discovered a neat little service to do this with nothing more than ssh: <a href=https://localhost.run/>localhost.run</a>.</p><p>If I run my app with <code>dotnet run</code> then I can find the port that it’s running on:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>info: Microsoft.Hosting.Lifetime[14]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>      Now listening on: http://localhost:5002
</span></span></code></pre></div><p>And using <a href=http://localhost.run>localhost.run</a> I can create a tunnel for that port:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ ssh -R 80:localhost:5002 nokey@localhost.run
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>b49b69845954b1.lhrtunnel.link tunneled with tls termination, https://b49b69845954b1.lhrtunnel.link
</span></span></code></pre></div><p>Now on GitHub if I visit the settings for a repository, and go to webhooks, I can create a new webhook configuration using that domain name.</p><p><img src=/img/github-new-webhook.png alt="Creating a new GitHub Webhook"></p><p>Now all I need to do is create a comment on an issue in the same repository&mldr;.</p><p><img src=/img/new-github-comment.png alt="A test issue comment"></p><p>And it’ll get logged in my terminal!</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>info: MyWebhookEventProcessor[0]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>      Test comment
</span></span></code></pre></div><h2 id=making-it-interactive>Making it interactive</h2><p>Logging things to the terminal is great and all, but to make it a bot it should really <em>do</em> something. For that I’ll need the <code>Octokit</code> package:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dotnet add package Octokit
</span></span></code></pre></div><p>And I’ll use it in <code>MyWebhookEventProcessor</code> :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> GitHubClient client<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>public</span> MyWebhookEventProcessor<span style=color:#1f2328>(</span>ILogger<span style=color:#1f2328>&lt;</span>MyWebhookEventProcessor<span style=color:#1f2328>&gt;</span> logger<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>logger <span style=color:#1f2328>=</span> logger<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>client <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> GitHubClient<span style=color:#1f2328>(</span><span style=color:#cf222e>new</span> ProductHeaderValue<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;octokit-webhooks-sample&#34;</span><span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    Credentials <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Credentials<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;...&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>For this example I’m using a personal access token. You can create your own <a href=https://github.com/settings/tokens>here</a>. If I were deploying this as a production service, I would probably use something a bit more robust, like a <a href=https://docs.github.com/en/developers/apps/building-github-apps/authenticating-with-github-apps>GitHub App</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>protected</span> <span style=color:#cf222e>override</span> <span style=color:#cf222e>async</span> Task ProcessIssueCommentWebhookAsync<span style=color:#1f2328>(</span>WebhookHeaders headers<span style=color:#1f2328>,</span> IssueCommentEvent issueCommentEvent<span style=color:#1f2328>,</span> IssueCommentAction action<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>logger<span style=color:#1f2328>.</span>LogInformation<span style=color:#1f2328>(</span>issueCommentEvent<span style=color:#1f2328>.</span>Comment<span style=color:#1f2328>.</span>Body<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#cf222e>await</span> <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>client<span style=color:#1f2328>.</span>Issue<span style=color:#1f2328>.</span>Comment<span style=color:#1f2328>.</span>Create<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    repositoryId<span style=color:#1f2328>:</span> issueCommentEvent<span style=color:#1f2328>.</span>Repository<span style=color:#1f2328>.</span>Id<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    number<span style=color:#1f2328>:</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>int</span><span style=color:#1f2328>)</span>issueCommentEvent<span style=color:#1f2328>.</span>Issue<span style=color:#1f2328>.</span>Number<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    newComment<span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Hello, world!&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  <span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>I need to do that cast from <code>long</code> to <code>int</code> because <code>Octokit</code> still has <a href=https://github.com/octokit/octokit.net/pull/2352>an open PR</a> to convert all its IDs to <code>long</code>. I’ve also got to add the <code>async</code> modifier to my method, so I can <code>await</code> the issue comment creation method in Octokit.</p><p>Once I’ve done all that, I can create an issue comment on my repository on GitHub and my “bot” will reply!</p><p><img src=/img/github-bot-reply.png alt="A reply from the bot"></p><h2 id=what-next>What next?</h2><p>If you find the library useful or interesting, give it <a href=https://github.com/octokit/webhooks.net>a star on GitHub</a>. And create an issue or pull request if you find find a bug or have a feature request.</p><p>If you want to create a fully-fledged bot, check out the GitHub documentation on creating a <a href=https://docs.github.com/en/developers/apps/building-github-apps/creating-a-github-app>GitHub app</a>. It’s the next progression from PATs, and allows you to more easily share your bot.</p></div><div class=post><h1 class=post-title><a href=/blog/netlify-billing-denial-of-service/>Netlify billing Denial-of-Service</a></h1><span class=post-date>Apr 11, 2021 &#183; 4 minute read</span><p>At its heart, <a href=https://www.netlify.com/>Netlify</a> is a platform for hosting static websites. I initially started using it as an alternative to <a href=https://pages.github.com/>GitHub Pages</a>, and features like <a href=https://www.netlifycms.org/>Netlify CMS</a> and <a href=https://www.netlify.com/blog/2016/07/20/introducing-deploy-previews-in-netlify/>preview deploys</a> really won me over. However, I recently got bit by preview deploys and the build minutes pricing.</p><p>I had a few GitHub repos set up to automatically deploy to Netlify previews from pull requests. I had also configured <a href=https://renovate.whitesourcesoftware.com/>Renovate</a> to automatically open pull requests for my dependencies. Javascript projects have a lot of dependencies, so there were more than a few pull requests!</p><p>Originally Netlify didn&rsquo;t charge for build minutes, but in October 2019 they introduced a cap of 300 minutes per month on the start plan, with the option to buy packs of 500 build minutes for $7. I&rsquo;m not criticising them for this change. I understand that they need to make money, and I think $7 for 500 minutes is a reasonable price. However, I don&rsquo;t think Netlify has put the necessary protections in place for their customers.</p><p><img src=/img/netlify-1.png alt></p><h2 id=saas-cost-attack>SaaS cost attack</h2><p>A quick Google search for &ldquo;huge bill&rdquo; for AWS, Azure, or GCP returns thousands of results. Stories of people who, at best, misconfigured their infrastructure or, at worst, were the target of a DDoS attack. Whatever the cause, the outcome is the same: a massive bill for thousands of dollars.</p><p>The big three cloud providers, and most other SaaS companies, offer some sort of protections or hard limits to prevent these sorts of surprises: Azure has <a href=https://azure.microsoft.com/en-us/services/cost-management/>Azure Cost Management + Billing</a>, AWS has <a href=https://aws.amazon.com/aws-cost-management/aws-budgets/>AWS Budget</a>, and GCP has <a href=https://cloud.google.com/billing/docs/how-to/budgets>Cloud Billing budgets</a>. Netlify has no such protections.</p><p><img src=/img/netlify-2.png alt></p><p>To me, this seems like a massive oversight and is a core feature that most users, and all business, would expect to have. Obviously the intention here is for Netlify to be able to charge customers when they exceed their build minutes. This also leaves open a massive opportunity for malicious actors to incur huge costs for Netlify customers with very little effort.</p><h2 id=proof-of-concept>Proof-of-concept</h2><p>Netlify allows you to configure your site&rsquo;s build using a <code>netlify.toml</code> stored in the root of your repository. Here&rsquo;s an excerpt taken from <a href=https://docs.netlify.com/configure-builds/file-based-configuration/#sample-file>their documentation</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># Settings in the [build] context are global and are applied to all contexts</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#fff></span><span style=color:#57606a># unless otherwise overridden by more specific contexts.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fff></span><span style=color:#1f2328>[</span>build]<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#fff>  </span><span style=color:#57606a># Directory to change to before starting a build.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#fff>  </span><span style=color:#57606a># This is where we will look for package.json/.nvmrc/etc.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#fff>  </span>base = &#34;project/&#34;<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#fff>  </span><span style=color:#57606a># Directory that contains the deploy-ready HTML files and assets generated by</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#fff>  </span><span style=color:#57606a># the build. This is relative to the base directory if one has been set, or the</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#fff>  </span><span style=color:#57606a># root directory if a base has not been set. This sample publishes the</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#fff>  </span><span style=color:#57606a># directory located at the absolute path &#34;root/project/build-output&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#fff>  </span>publish = &#34;build-output/&#34;<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#fff>  </span><span style=color:#57606a># Default build command.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#fff>  </span>command = &#34;echo &#39;default context&#39;&#34;<span style=color:#fff>
</span></span></span></code></pre></div><p>If I were to replace <code>command</code> with something like <code>sleep 120</code> and open a pull request that uses Netlify and has not explicitly disabled deploy previews, the Netlify build will happily build my pull request and sleep for two minutes.</p><p><img src=/img/netlify-3.png alt></p><p>A quick <a href="https://github.com/search?q=filename%3Anetlify.toml">search on GitHub</a> for <code>filename:netlify.toml</code> shows there are approximately forty thousand repositories that are potentially vulnerable to this style of attack.</p><p>One small mercy is the fact that Netlify limits builds to 15 minutes by default. So, to cost anyone any money, someone would have to open 20 pull requests with <code>command = "sleep 900"</code>. At that point, I hope either the repository owner would notice, GitHub would rate-limit you, or it would catch the attention of Netlify.</p><h2 id=what-next>What next?</h2><p>I was recently bitten by unexpected charges for build minutes. After contacting Netlify they, very kindly, forgave the charges. However, when I asked about billing protection for customers they replied:</p><blockquote><p>Our policy is to keep your website and builds running as you expect, rather than leaving things in an inconsistent state. I understand it is not what you prefer, but it is what our business prioritizes - expected behavior and continuous uptime for your website and build processes. I have however recorded your feedback for our billing team.</p></blockquote><p>Personally, I have disabled preview deploys on all my sites on Netlify and moved the builds to GitHub Actions. I still use Netlify for NetlifyCMS, but I might look into <a href=https://tylergaw.com/articles/netlify-cms-custom-oath-provider/>using NetlifyCMS with a custom OAuth provider</a> in the future.</p></div><div class=pagination><a class=pagination-item href=/>Newer</a>
<a class=pagination-item href=/page/3/>Older</a></div></div></div></body></html>