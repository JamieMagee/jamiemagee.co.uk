<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.149.0"><meta charset=utf-8><link href=https://gmpg.org/xfn/11 rel=profile><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Jamie Magee &#183; Programmer, Engineer, Problem Solver</title><link rel=preload href=/css/poole.css as=style><link rel=preload href=/css/hyde.css as=style><link rel=preload href=/css/poole-overrides.css as=style><link rel=preload href=/css/hyde-overrides.css as=style><link rel=preload href=/css/hyde-x.css as=style><link rel=preload href=/fonts/BerkeleyMono-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" as=style crossorigin><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css as=style crossorigin><link rel=preload href=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js as=script crossorigin><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/poole-overrides.css><link rel=stylesheet href=/css/hyde-overrides.css><link rel=stylesheet href=/css/hyde-x.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" crossorigin><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css crossorigin><style>@font-face{font-family:berkeley mono;src:url(/fonts/BerkeleyMono-Regular.woff2)format('woff2');font-display:swap}.lite-youtube-fallback{aspect-ratio:16/9;display:flex;justify-content:center;align-items:center;flex-direction:column;gap:1em;padding:1em;background-color:#000;color:#fff;text-decoration:none;border-radius:8px;transition:background-color .2s ease}.lite-youtube-fallback:hover{background-color:#333;color:#fff}.lite-youtube-fallback::before{display:block;content:'';border:solid transparent;border-width:2em 0 2em 3em;border-left-color:red;transition:border-left-color .2s ease}.lite-youtube-fallback:hover::before{border-left-color:#fff}.lite-youtube-fallback:focus{outline:2px solid red;outline-offset:2px}</style><link rel=stylesheet href=/css/jamie.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><link rel=alternate type=application/rss+xml href=/index.xml title="Jamie Magee"><meta name=description content><meta name=keywords content><meta name=author content="Jamie Magee"><meta name=robots content="index, follow"><link rel=canonical href=/><meta property="og:url" content="/"><meta property="og:site_name" content="Jamie Magee"><meta property="og:title" content="Jamie Magee"><meta property="og:locale" content="en_gb"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jamie Magee"><script type=module src=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js></script></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><div class=sidebar-head><h1><a href=/>Jamie Magee</a></h1></div><p class=lead>Programmer, Engineer, Problem Solver</p></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a></li><li class=sidebar-nav-item><a href=/about>About</a></li><li class=sidebar-nav-item><a href=/blog>Archive</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/JamieMagee><i class="fa-brands fa-github-square fa-3x"></i></a>
<a href=https://bsky.app/profile/jamiemagee.bsky.social><i class="fa-brands fa-square-bluesky fa-3x"></i></a>
<a href=https://www.linkedin.com/in/jamiemagee1/><i class="fa-brands fa-linkedin fa-3x"></i></a>
<a href=/index.xml type=application/rss+xml><i class="fa-solid fa-rss-square fa-3x"></i></a></li></ul><p>&copy; 2025. <a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></p></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=/blog/scanning-windows-container-images-is-surprisingly-easy/>Scanning Windows container images is (surprisingly) easy!</a></h1><span class=post-date>Jan 2, 2023 &#183; 5 minute read</span><p>When it comes to Linux containers, there are plenty of tools out there that can scan container images, generate Software Bill of Materials (SBOM), or list vulnerabilities. However, Windows container images are more like the forgotten stepchild in the container ecosystem. And that means we’re forgetting the countless developers using Windows containers, too.</p><p>I wanted to see what I’d need to make scanning tools for Windows container images. Turns out it’s pretty easy. So easy, in fact, I think the existing container tools should add support for Windows container images.</p><h2 id=what-version-of-windows-am-i-running>What version of Windows am I running?</h2><p>The first question I needed to answer was: what version of Windows was the container image based on? This tells me what date the container image is from, what updates are applicable, and what vulnerabilities it has.</p><p>Container images are really just <code>tar</code> files, and Windows container images are no different. So first I saved a Windows container image locally using skopeo:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ skopeo --insecure-policy --override-os windows copy docker://mcr.microsoft.com/windows/nanoserver:ltsc2022 dir:///tmp/nanoserver
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ ls /tmp/nanoserver
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>0db1879370e5c72dae7bff5d013772cbbfb95f30bfe1660dcef99e0176752f1c  7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858 manifest.json version
</span></span></code></pre></div><p>Next, I inspected the manifest using jq to find the layer that had the Windows files.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ jq . manifest.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#0a3069>&#34;schemaVersion&#34;</span>: 2,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#0a3069>&#34;mediaType&#34;</span>: <span style=color:#0a3069>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#0a3069>&#34;config&#34;</span>: <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#0a3069>&#34;mediaType&#34;</span>: <span style=color:#0a3069>&#34;application/vnd.docker.container.image.v1+json&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#0a3069>&#34;size&#34;</span>: 638,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#0a3069>&#34;digest&#34;</span>: <span style=color:#0a3069>&#34;sha256:0db1879370e5c72dae7bff5d013772cbbfb95f30bfe1660dcef99e0176752f1c&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#0550ae>}</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#0a3069>&#34;layers&#34;</span>: <span style=color:#0550ae>[</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#0550ae>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#0a3069>&#34;mediaType&#34;</span>: <span style=color:#0a3069>&#34;application/vnd.docker.image.rootfs.foreign.diff.tar&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#0a3069>&#34;size&#34;</span>: 304908800,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#0a3069>&#34;digest&#34;</span>: <span style=color:#0a3069>&#34;sha256:7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#0550ae>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#0550ae>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#0550ae>}</span>
</span></span></code></pre></div><p>I then extracted the layer and fixed the permissions.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ mkdir layer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>$ tar -xf 7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858 -C ./layer/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>$ sudo find ./layer -type f -exec chmod <span style=color:#0550ae>0644</span> <span style=color:#0550ae>{}</span> <span style=color:#0a3069>\;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>$ sudo find ./layer -type d -exec chmod <span style=color:#0550ae>0755</span> <span style=color:#0550ae>{}</span> <span style=color:#0a3069>\;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>$ ls -lah layer/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>total 16K
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>drwxr-xr-x <span style=color:#0550ae>4</span> jamie users 4.0K Dec <span style=color:#0550ae>28</span> 15:05 .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>drwxr-xr-x <span style=color:#0550ae>3</span> jamie users 4.0K Dec <span style=color:#0550ae>28</span> 15:00 ..
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>drwxr-xr-x <span style=color:#0550ae>5</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:18 Files
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>drwxr-xr-x <span style=color:#0550ae>3</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:22 UtilityVM
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>$ ls -lah layer/Files/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>total 28K
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>drwxr-xr-x  <span style=color:#0550ae>5</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:18 .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>drwxr-xr-x  <span style=color:#0550ae>4</span> jamie users 4.0K Dec <span style=color:#0550ae>28</span> 15:05 ..
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>-rw-r--r--  <span style=color:#0550ae>1</span> jamie users 5.6K Dec  <span style=color:#0550ae>9</span> 01:18 License.txt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>drwxr-xr-x  <span style=color:#0550ae>4</span> jamie users 4.0K May  <span style=color:#0550ae>7</span>  <span style=color:#0550ae>2021</span> ProgramData
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>drwxr-xr-x  <span style=color:#0550ae>6</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:19 Users
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>drwxr-xr-x <span style=color:#0550ae>20</span> jamie users 4.0K Dec  <span style=color:#0550ae>9</span> 01:19 Windows
</span></span></code></pre></div><p>Inside the extracted layer there are two directories: <code>Files</code> and <code>UtilityVM</code>. <code>Files</code> had the filesystem of the Windows container image, while <code>UtilityVM</code> is used by Hyper-V behind the scenes. So I just needed to focus on <code>Files</code>.</p><p>How did I figure out the specific version of Windows the container is running? From the registry of course! The <code>SOFTWARE</code> registry hive contained information about installed software, including Windows itself, and was found at <code>Files/Windows/System32/config/SOFTWARE</code>.</p><p>Thankfully, there’s a great NuGet package called <a href=https://github.com/EricZimmerman/Registry>Registry</a> that let me easily load and parse the registry, but there are also packages for <a href=https://pkg.go.dev/golang.org/x/sys/windows/registry>Go</a>, <a href=https://github.com/bbqsrc/registry-rs>Rust</a>, and even <a href=https://github.com/ironSource/node-regedit>Node.js</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Registry</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#cf222e>var</span> registryHive <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> RegistryHive<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;/tmp/nanoserver/layer/Files/Windows/System32/config/SOFTWARE&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>registryHive<span style=color:#1f2328>.</span>ParseHive<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#cf222e>var</span> currentVersion <span style=color:#1f2328>=</span> registryHive<span style=color:#1f2328>.</span>GetKey<span style=color:#1f2328>(</span><span style=color:#0a3069>@&#34;Microsoft\Windows NT\CurrentVersion&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#cf222e>var</span> fullVersion <span style=color:#1f2328>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#0a3069>$&#34;{currentVersion.GetValue(&#34;</span>CurrentMajorVersionNumber<span style=color:#0a3069>&#34;)}.{currentVersion.GetValue(&#34;</span>CurrentMinorVersionNumber<span style=color:#0a3069>&#34;)}.{currentVersion.GetValue(&#34;</span>CurrentBuildNumber<span style=color:#0a3069>&#34;)}.{currentVersion.GetValue(&#34;</span>UBR<span style=color:#0a3069>&#34;)}&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>Console<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span>fullVersion<span style=color:#1f2328>);</span>
</span></span></code></pre></div><p>Running this code, I got version <code>10.0.20348.1366</code> which was <a href=https://twitter.com/ChangeWindows/status/1602752823116333056>apparently released on 13th December 2022</a>.</p><h2 id=what-about-windows-updates>What about Windows updates?</h2><p>The version of Windows doesn’t tell the whole story. There are also updates that can be applied on top. You might have seen them referred to by their KB number, for example KB1234567. Information on what updates have been applied is also stored in the registry.</p><p>By extending my earlier code, I can find out what updates this container image has.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>var</span> packages <span style=color:#1f2328>=</span> registryHive<span style=color:#1f2328>.</span>GetKey<span style=color:#1f2328>(</span><span style=color:#0a3069>@&#34;Microsoft\Windows\CurrentVersion\Component Based Servicing\Packages&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>var</span> updatePackageRegex <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Regex<span style=color:#1f2328>(</span><span style=color:#0a3069>@&#34;^Package_\d+_for_(KB\d+)~\w{16}~\w+~~((?:\d+\.){3}\d+)$&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#cf222e>var</span> updates <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Dictionary<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>string</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>string</span><span style=color:#1f2328>&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#cf222e>foreach</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> packageKey <span style=color:#cf222e>in</span> packages<span style=color:#1f2328>.</span>SubKeys<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(!</span>updatePackageRegex<span style=color:#1f2328>.</span>IsMatch<span style=color:#1f2328>(</span>packageKey<span style=color:#1f2328>.</span>KeyName<span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#cf222e>continue</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#cf222e>var</span> currentState <span style=color:#1f2328>=</span> packageKey<span style=color:#1f2328>.</span>Values<span style=color:#1f2328>.</span>Find<span style=color:#1f2328>(</span>v <span style=color:#1f2328>=&gt;</span> v<span style=color:#1f2328>.</span>ValueName <span style=color:#1f2328>==</span> <span style=color:#0a3069>&#34;CurrentState&#34;</span><span style=color:#1f2328>)?.</span>ValueData<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#57606a>// Installed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>currentState <span style=color:#1f2328>==</span> <span style=color:#0a3069>&#34;112&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#cf222e>var</span> groups <span style=color:#1f2328>=</span> updatePackageRegex<span style=color:#1f2328>.</span>Match<span style=color:#1f2328>(</span>packageKey<span style=color:#1f2328>.</span>KeyName<span style=color:#1f2328>).</span>Groups<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        updates<span style=color:#1f2328>[</span>groups<span style=color:#1f2328>[</span><span style=color:#0550ae>1</span><span style=color:#1f2328>].</span>Value<span style=color:#1f2328>]</span> <span style=color:#1f2328>=</span> groups<span style=color:#1f2328>[</span><span style=color:#0550ae>2</span><span style=color:#1f2328>].</span>Value<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#cf222e>foreach</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> update <span style=color:#cf222e>in</span> updates<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    Console<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span><span style=color:#0a3069>$&#34;{update.Key}: {update.Value}&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>Running this gave me a single update: <code>KB5020373: 20348.1300.1.0</code>. Searching online for <a href=https://support.microsoft.com/en-gb/topic/november-8-2022-kb5020613-cumulative-update-for-net-framework-3-5-and-4-8-for-windows-10-version-20h2-windows-10-version-21h1-windows-10-version-21h2-and-windows-10-version-22h2-3880a78d-3b33-429a-93fc-eeb0c40b4ad4>KB5020373</a> led me to the documentation for the update. It’s the November 2022 security update for .NET Framework and has a fix for <a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-41064>CVE-2022-41064</a>.</p><h2 id=done-now-what-if-we-scaled-this>Done! &mldr;Now what if we scaled this?</h2><p>It turns out it’s not that difficult to find out info about Windows container images. It took me a couple of hours to figure out, but that’s only because no one seems to have done this before. The actual code is only about 30 lines.</p><p>Windows containers are widely used for legacy applications, like .NET Framework applications, that haven’t been rewritten but could benefit from the cloud. All of the big three cloud providers offer managed Kubernetes services that support Windows nodes out of the box (yes, <a href=https://kubernetes.io/docs/concepts/windows/intro/#windows-os-version-support>Kubernetes supports Windows nodes</a>). There is clearly a demand for Windows containers, but there is a gap in the kind of container tooling that has sprung up for Linux containers.</p><p>Instead of allowing this gap to widen further, I think that container tool authors—especially SBOM tools and vulnerability scanners—should add support for Windows container images. These tools should then correlate the extracted information with the <a href=https://api.msrc.microsoft.com/cvrf/v2.0/swagger/index>Microsoft Security Research Center (MSRC) API</a>. MSRC publishes information every month on security updates. Comparing the Windows version from a container image with the fixed versions provided by the MSRC API, you could easily see your container image’s security vulnerabilities.</p><p>As my proof-of-concept has shown, it’s low-hanging fruit. A small addition that would have a big impact for the many forgotten developers and the applications they work on.</p></div><div class=post><h1 class=post-title><a href=/blog/making-the-most-of-github-rate-limits/>Making the most of GitHub rate limits</a></h1><span class=post-date>Jul 26, 2022 &#183; 6 minute read</span><p>The GitHub documentation has a lot of good advice about rate limits for its API, and how to make the most of them. However, since using the GitHub API, there are some things I’ve discovered that the documentation doesn’t cover, or doesn’t cover so well.</p><h2 id=conditional-requests>Conditional requests</h2><p>This topic is actually covered very well in <a href=https://docs.github.com/en/rest/overview/resources-in-the-rest-api#conditional-requests>the GitHub documentation</a>. To summarise, all REST API requests will return <code>ETag</code> headers, and most will return <code>Last-Modified</code>. You can make use of these by making subsequent requests with the <code>If-None-Match</code> and <code>If-Modified-Since</code> headers respectively. If the resource hasn’t been modified, you’ll get back a <code>304 Not Modified</code> response, and the request won&rsquo;t count against your rate limit.</p><p>To show you what I mean, here’s a short example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ curl -I -H <span style=color:#0a3069>&#34;Authorization: token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/user
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#0a3069>&lt; HTTP/2 200
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#0a3069>&lt; etag: &#34;</span>0c05f6422602a76a6671b28fc70af0ff9775ee41c80aca7d527814bb79a0fc2c<span style=color:#0a3069>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#0a3069>&lt; last-modified: Mon, 21 Feb 2022 17:25:59 GMT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#0a3069>&lt; x-ratelimit-limit: 5000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#0a3069>&lt; x-ratelimit-remaining: 4993
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#0a3069>&lt; x-ratelimit-reset: 1645482669
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#0a3069></span>$<span style=color:#0a3069> curl -I -H &#34;</span>If-None-Match: <span style=color:#0a3069>\&#34;</span>0c05f6422602a76a6671b28fc70af0ff9775ee41c80aca7d527814bb79a0fc2c<span style=color:#0a3069>\&#34;</span><span style=color:#0a3069>&#34; -H &#34;</span>Authorization: token ...<span style=color:#0a3069>&#34; &#34;</span>https://api.github.com/user<span style=color:#0a3069>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#0a3069>&lt; HTTP/2 304
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#0a3069>&lt; etag: &#34;</span>0c05f6422602a76a6671b28fc70af0ff9775ee41c80aca7d527814bb79a0fc2c<span style=color:#0a3069>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#0a3069>&lt; last-modified: Mon, 21 Feb 2022 17:25:59 GMT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#0a3069>&lt; x-ratelimit-limit: 5000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#0a3069>&lt; x-ratelimit-remaining: 4993
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#0a3069>&lt; x-ratelimit-reset: 1645482669
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#0a3069></span>$<span style=color:#0a3069> curl -I -H &#34;</span>If-Modified-Since: Mon, <span style=color:#0550ae>21</span> Feb <span style=color:#0550ae>2022</span> 17:25:59 GMT<span style=color:#0a3069>&#34; -H &#34;</span>Authorization: token ...<span style=color:#0a3069>&#34; &#34;</span>https://api.github.com/user<span style=color:#0a3069>&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#0a3069>&lt; HTTP/2 304
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#0a3069>&lt; last-modified: Mon, 21 Feb 2022 17:25:59 GMT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#0a3069>&lt; x-ratelimit-limit: 5000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#0a3069>&lt; x-ratelimit-remaining: 4993
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#0a3069>&lt; x-ratelimit-reset: 1645482669
</span></span></span></code></pre></div><p>The first request uses one request of my rate limit, taking it from 4994 to 4993. But the next two requests use <code>If-None-Match</code> and <code>If-Modified-Since</code> headers, so my rate limit is still 4993.</p><p>Unfortunately, conditional requests are only available for the REST API. HTTP caching over GraphQL is <a href=https://www.apollographql.com/blog/backend/caching/graphql-caching-the-elephant-in-the-room/>not a simple problem</a>, and it’s unlikely that GitHub will ever support it.</p><h2 id=prefer-if-modified-since>Prefer <code>If-Modified-Since</code></h2><p>The GitHub REST API documentation covers conditional requests pretty well. The reason I&rsquo;m mentioning it? Well, the documentation says that you can use <code>ETag</code> or <code>If-Modified-Since</code> interchangeably—but they&rsquo;re not equivalent. Take a look at this example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -I -H <span style=color:#0a3069>&#34;Authorization:token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/repos/renovatebot/renovate/releases/latest&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>&lt; HTTP/2 <span style=color:#0550ae>200</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>&lt; etag: <span style=color:#0a3069>&#34;70eb55000ec3e69bc2d88079714612000a955d4afaf02643b6602d99fb60dd8d&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>&lt; last-modified: Mon, <span style=color:#0550ae>21</span> Feb <span style=color:#0550ae>2022</span> 21:47:30 GMT
</span></span></code></pre></div><p>And if I make the same request a little bit later…</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -I -H <span style=color:#0a3069>&#34;Authorization:token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/repos/renovatebot/renovate/releases/latest&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>&lt; HTTP/2 <span style=color:#0550ae>200</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>&lt; etag: <span style=color:#0a3069>&#34;85f04330d7bca80e6e0d62ac1b41b6d57e2ff11744565655e46732d44736dba6&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>&lt; last-modified: Mon, <span style=color:#0550ae>21</span> Feb <span style=color:#0550ae>2022</span> 21:47:30 GMT
</span></span></code></pre></div><p>The ETag is different but the Last-Modified time is still the same as before. Based on <a href=https://stackoverflow.com/questions/28060116/which-is-more-reliable-for-github-api-conditional-requests-etag-or-last-modifie/57309763#57309763>this StackOverflow question</a>, it appears as if this has been an issue for a while. So if a response has both an <code>ETag</code> and a <code>Last-Modified</code> time, I’d recommend using the <code>Last-Modified</code> time to make conditional requests.</p><h2 id=both-rest-and-graphql>Both REST and GraphQL</h2><p>Saying “rate limit” isn’t really accurate. What I actually mean is “rate limits”. GitHub actually has nine different rate limits. Some are for very specific use cases, like <a href=https://docs.github.com/en/developers/apps/building-github-apps/creating-a-github-app-from-a-manifest#3-you-exchange-the-temporary-code-to-retrieve-the-app-configuration><code>integration_manifest</code></a> for the GitHub App Manifest code conversion endpoint. But the two that are most useful are <code>core</code> (AKA REST) and <code>graphql</code>.</p><p>If I make a request to the <a href=https://docs.github.com/en/rest/rate-limit>rate limit endpoint</a>, you can see all the different rate limits.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#0550ae>&#34;resources&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#0550ae>&#34;core&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#0550ae>&#34;search&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>30</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>30</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656978223</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#0550ae>&#34;graphql&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>38</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>4962</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656979534</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#0550ae>&#34;integration_manifest&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#0550ae>&#34;source_import&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656978223</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    <span style=color:#0550ae>&#34;code_scanning_upload&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#0550ae>&#34;actions_runner_registration&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>10000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>10000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    <span style=color:#0550ae>&#34;scim&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>15000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>15000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#0550ae>&#34;dependency_snapshots&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>      <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>      <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>      <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>100</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>      <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656978223</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>  <span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>  <span style=color:#0550ae>&#34;rate&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#0550ae>&#34;limit&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    <span style=color:#0550ae>&#34;used&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    <span style=color:#0550ae>&#34;remaining&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>    <span style=color:#0550ae>&#34;reset&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0550ae>1656981763</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>The REST API has a rate limit of <a href=https://docs.github.com/en/rest/overview/resources-in-the-rest-api#rate-limiting>5000 requests per hour</a>. Separately, the GraphQL API has a rate limit of <a href=https://docs.github.com/en/graphql/overview/resource-limitations#rate-limit>5000 points per hour</a>.</p><p>Depending on what API calls you want to make, you can intelligently split them across the REST and GraphQL APIs to achieve a higher overall limit. For example, if a GraphQL call is going to cost a lower number of points than the number of REST calls required to get the same data, you should make those calls via the GraphQL API. You should also bear in mind that you can make conditional requests to the REST API, but not to the GraphQL API.</p><h2 id=maximise-page-size>Maximise page size</h2><p>Whenever you’re making a request to an endpoint with pagination, you should check what the maximum results per page are and set your query parameter to that size.</p><p>The default size for most endpoints is 30 results, but the maximum size is often 100. If you forget to set this you might need to make four times as many requests to get the same number of results.</p><h2 id=use-sorting>Use sorting</h2><p>Most API calls allow you to sort them based on a date field when querying an endpoint. If you use this—and do some caching on your end as well—you can avoid having to fetch all pages for a request whenever you have a cache request.</p><p>For example, if you need to fetch the most recently changed pull requests for a repository, you should be sorting by <code>updated</code> and storing a local cache of pull requests. That way a conditional request cache miss won’t require you to fetch all the pages of a request. You can compare each page to your local cache, and only fetch the next page if required.</p><h2 id=use-head-requests>Use <code>HEAD</code> requests</h2><p>This tip isn’t strictly about rate limits, but is useful when you’re eking out every last bit of performance. Nearly all GitHub REST API endpoints support <code>HEAD</code> requests, in addition to the other HTTP verbs. If you’re already using conditional requests, you can avoid having the body of a request sent over the wire by sending a <code>HEAD</code> request instead.</p><p>For example, here’s the header and body size for a <code>GET</code> request:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -w <span style=color:#0a3069>\%</span><span style=color:#0550ae>{</span>size_header<span style=color:#0550ae>}</span>:<span style=color:#0a3069>\%</span><span style=color:#0550ae>{</span>size_download<span style=color:#0550ae>}</span> -s -o /dev/null -H <span style=color:#0a3069>&#34;Authorization:token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/repos/renovatebot/renovate/releases&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1448:137229
</span></span></code></pre></div><p>And here’s the header and body size for the <code>HEAD</code> equivalent:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl -w <span style=color:#0a3069>\%</span><span style=color:#0550ae>{</span>size_header<span style=color:#0550ae>}</span>:<span style=color:#0a3069>\%</span><span style=color:#0550ae>{</span>size_download<span style=color:#0550ae>}</span> -s -o /dev/null -H <span style=color:#0a3069>&#34;Authorization:token ...&#34;</span> <span style=color:#0a3069>&#34;https://api.github.com/repos/renovatebot/renovate/releases&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>1448:0
</span></span></code></pre></div><p>By making a <code>HEAD</code> request instead of a <code>GET</code> request, you can avoid being sent 137KB.</p><p>There is a trade-off, though. If you use conditional requests and have a cache miss, you’ll have to make the <code>GET</code> request anyway.</p><h2 id=summing-up>Summing up</h2><p>Using these methods I’ve managed to eke out every bit of performance of the GitHub API for my integrations. Let me know what methods you use, or if there’s anything I’ve missed.</p></div><div class=post><h1 class=post-title><a href=/blog/writing-github-bots-in-net/>Writing GitHub bots in .NET</a></h1><span class=post-date>Mar 4, 2022 &#183; 5 minute read</span><p>For a while now the Octokit libraries for .NET have lagged behind the JavaScript libraries, especially when it comes to webhooks. Unfortunately, I needed a GitHub webhook client for an internal project, so I had to write my own. It wasn’t too much extra effort to open source it, and thus <a href=https://github.com/octokit/webhooks.net>Octokit.Webhooks</a> was born!</p><p>I wanted to give a quick example of how to get up and running with <code>Octokit.Webhooks</code>, and what better way than to write a small GitHub bot?</p><h2 id=setup>Setup</h2><p>For this project, I’m going to be using <a href=https://dotnet.microsoft.com/en-us/download/dotnet/6.0>.NET 6.0</a> and <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis?view=aspnetcore-6.0">ASP.NET’s new minimal APIs</a> to simplify setup. From a terminal I’m going to create a new web API project:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dotnet new webapi --output octokit-webhooks-sample
</span></span></code></pre></div><p>The default template is set up to be a weather forecast API, but I can simplify it a bit more for this sample. My <code>Program.cs</code> looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>var</span> builder <span style=color:#1f2328>=</span> WebApplication<span style=color:#1f2328>.</span>CreateBuilder<span style=color:#1f2328>(</span>args<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#cf222e>var</span> app <span style=color:#1f2328>=</span> builder<span style=color:#1f2328>.</span>Build<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>app<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>();</span>
</span></span></code></pre></div><p>Next up I’m going to install the <a href=https://www.nuget.org/packages/Octokit.Webhooks.AspNetCore/>Octokit.Webhooks.AspNetCore</a> package:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dotnet add package Octokit.Webhooks.AspNetCore
</span></span></code></pre></div><p>This package consumes the Octokit.Webhooks package, which contains core functionality like deserializers and processors, and adds ASP.NET Core specific code, like automatic API endpoint mapping and shared secret verification.</p><h2 id=handling-webhooks>Handling webhooks</h2><p>Now that I’ve got my project set up, I need to create my own processor to handle incoming webhooks. <code>Octokit.Webhooks</code> ships with an abstract class called <code>WebhookEventProcessor</code> that does all the heavy lifting of deserializing incoming webhooks. All I need to do is to create my own class that inherits from it, and write some logic to act on the webhook events.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks.Events</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks.Events.IssueComment</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>sealed</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>MyWebhookEventProcessor</span> <span style=color:#1f2328>:</span> WebhookEventProcessor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> ILogger<span style=color:#1f2328>&lt;</span>MyWebhookEventProcessor<span style=color:#1f2328>&gt;</span> logger<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#cf222e>public</span> MyWebhookEventProcessor<span style=color:#1f2328>(</span>ILogger<span style=color:#1f2328>&lt;</span>MyWebhookEventProcessor<span style=color:#1f2328>&gt;</span> logger<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>logger <span style=color:#1f2328>=</span> logger<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#cf222e>protected</span> <span style=color:#cf222e>override</span> Task ProcessIssueCommentWebhookAsync<span style=color:#1f2328>(</span>WebhookHeaders headers<span style=color:#1f2328>,</span> IssueCommentEvent issueCommentEvent<span style=color:#1f2328>,</span> IssueCommentAction action<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>logger<span style=color:#1f2328>.</span>LogInformation<span style=color:#1f2328>(</span>issueCommentEvent<span style=color:#1f2328>.</span>Comment<span style=color:#1f2328>.</span>Body<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>CompletedTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>I created a small class <code>MyWebhookEventProcessor</code> that inherits from <code>WebhookEventProcessor</code>, and has an override for <code>ProcessIssueCommentWebhookAsync</code> that logs out the comment body. I also get the headers and the action passed to this method, so I could write a switch case and have different handling for created, edited, and deleted actions, but this is enough for now.</p><p>I also need to hook up <code>MyWebhookEventProcessor</code> in my startup class.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>using</span> <span style=color:#24292e>Octokit.Webhooks.AspNetCore</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#cf222e>var</span> builder <span style=color:#1f2328>=</span> WebApplication<span style=color:#1f2328>.</span>CreateBuilder<span style=color:#1f2328>(</span>args<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>builder<span style=color:#1f2328>.</span>Services<span style=color:#1f2328>.</span>AddSingleton<span style=color:#1f2328>&lt;</span>WebhookEventProcessor<span style=color:#1f2328>,</span> MyWebhookEventProcessor<span style=color:#1f2328>&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#cf222e>var</span> app <span style=color:#1f2328>=</span> builder<span style=color:#1f2328>.</span>Build<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>app<span style=color:#1f2328>.</span>UseRouting<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>app<span style=color:#1f2328>.</span>UseEndpoints<span style=color:#1f2328>(</span>endpoints <span style=color:#1f2328>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  endpoints<span style=color:#1f2328>.</span>MapGitHubWebhooks<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>app<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>();</span>
</span></span></code></pre></div><p>This is enough to tell ASP.NET to hook up dependency injection for <code>MyWebhookEventProcessor</code>, enable routing. It will also automatically add a route to handle incoming GitHub webhooks. By default it’s exposed at <code>/api/github/webhooks</code>, but you can use any route you’d like. <code>MapGitHubWebhooks</code> also accepts a shared secret which allows you to verify the content signature of GitHub webhooks.</p><p>That’s all the code required on my side. Now I just need to expose my service to the internet, and configure GitHub to start sending me webhooks.</p><h2 id=github-webhook-configuration>GitHub webhook configuration</h2><p>For GitHub to be able to send me webhooks, my service needs to be publicly accessible to the internet. I recently discovered a neat little service to do this with nothing more than ssh: <a href=https://localhost.run/>localhost.run</a>.</p><p>If I run my app with <code>dotnet run</code> then I can find the port that it’s running on:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>info: Microsoft.Hosting.Lifetime[14]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>      Now listening on: http://localhost:5002
</span></span></code></pre></div><p>And using <a href=http://localhost.run>localhost.run</a> I can create a tunnel for that port:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ ssh -R 80:localhost:5002 nokey@localhost.run
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>b49b69845954b1.lhrtunnel.link tunneled with tls termination, https://b49b69845954b1.lhrtunnel.link
</span></span></code></pre></div><p>Now on GitHub if I visit the settings for a repository, and go to webhooks, I can create a new webhook configuration using that domain name.</p><p><img src=/img/github-new-webhook.png alt="Creating a new GitHub Webhook"></p><p>Now all I need to do is create a comment on an issue in the same repository&mldr;.</p><p><img src=/img/new-github-comment.png alt="A test issue comment"></p><p>And it’ll get logged in my terminal!</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>info: MyWebhookEventProcessor[0]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>      Test comment
</span></span></code></pre></div><h2 id=making-it-interactive>Making it interactive</h2><p>Logging things to the terminal is great and all, but to make it a bot it should really <em>do</em> something. For that I’ll need the <code>Octokit</code> package:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dotnet add package Octokit
</span></span></code></pre></div><p>And I’ll use it in <code>MyWebhookEventProcessor</code> :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> GitHubClient client<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>public</span> MyWebhookEventProcessor<span style=color:#1f2328>(</span>ILogger<span style=color:#1f2328>&lt;</span>MyWebhookEventProcessor<span style=color:#1f2328>&gt;</span> logger<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>logger <span style=color:#1f2328>=</span> logger<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>client <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> GitHubClient<span style=color:#1f2328>(</span><span style=color:#cf222e>new</span> ProductHeaderValue<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;octokit-webhooks-sample&#34;</span><span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    Credentials <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Credentials<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;...&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>For this example I’m using a personal access token. You can create your own <a href=https://github.com/settings/tokens>here</a>. If I were deploying this as a production service, I would probably use something a bit more robust, like a <a href=https://docs.github.com/en/developers/apps/building-github-apps/authenticating-with-github-apps>GitHub App</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>protected</span> <span style=color:#cf222e>override</span> <span style=color:#cf222e>async</span> Task ProcessIssueCommentWebhookAsync<span style=color:#1f2328>(</span>WebhookHeaders headers<span style=color:#1f2328>,</span> IssueCommentEvent issueCommentEvent<span style=color:#1f2328>,</span> IssueCommentAction action<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>logger<span style=color:#1f2328>.</span>LogInformation<span style=color:#1f2328>(</span>issueCommentEvent<span style=color:#1f2328>.</span>Comment<span style=color:#1f2328>.</span>Body<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#cf222e>await</span> <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span>client<span style=color:#1f2328>.</span>Issue<span style=color:#1f2328>.</span>Comment<span style=color:#1f2328>.</span>Create<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    repositoryId<span style=color:#1f2328>:</span> issueCommentEvent<span style=color:#1f2328>.</span>Repository<span style=color:#1f2328>.</span>Id<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    number<span style=color:#1f2328>:</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>int</span><span style=color:#1f2328>)</span>issueCommentEvent<span style=color:#1f2328>.</span>Issue<span style=color:#1f2328>.</span>Number<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    newComment<span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;Hello, world!&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  <span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>I need to do that cast from <code>long</code> to <code>int</code> because <code>Octokit</code> still has <a href=https://github.com/octokit/octokit.net/pull/2352>an open PR</a> to convert all its IDs to <code>long</code>. I’ve also got to add the <code>async</code> modifier to my method, so I can <code>await</code> the issue comment creation method in Octokit.</p><p>Once I’ve done all that, I can create an issue comment on my repository on GitHub and my “bot” will reply!</p><p><img src=/img/github-bot-reply.png alt="A reply from the bot"></p><h2 id=what-next>What next?</h2><p>If you find the library useful or interesting, give it <a href=https://github.com/octokit/webhooks.net>a star on GitHub</a>. And create an issue or pull request if you find find a bug or have a feature request.</p><p>If you want to create a fully-fledged bot, check out the GitHub documentation on creating a <a href=https://docs.github.com/en/developers/apps/building-github-apps/creating-a-github-app>GitHub app</a>. It’s the next progression from PATs, and allows you to more easily share your bot.</p></div><div class=post><h1 class=post-title><a href=/blog/netlify-billing-denial-of-service/>Netlify billing Denial-of-Service</a></h1><span class=post-date>Apr 11, 2021 &#183; 4 minute read</span><p>At its heart, <a href=https://www.netlify.com/>Netlify</a> is a platform for hosting static websites. I initially started using it as an alternative to <a href=https://pages.github.com/>GitHub Pages</a>, and features like <a href=https://www.netlifycms.org/>Netlify CMS</a> and <a href=https://www.netlify.com/blog/2016/07/20/introducing-deploy-previews-in-netlify/>preview deploys</a> really won me over. However, I recently got bit by preview deploys and the build minutes pricing.</p><p>I had a few GitHub repos set up to automatically deploy to Netlify previews from pull requests. I had also configured <a href=https://renovate.whitesourcesoftware.com/>Renovate</a> to automatically open pull requests for my dependencies. Javascript projects have a lot of dependencies, so there were more than a few pull requests!</p><p>Originally Netlify didn&rsquo;t charge for build minutes, but in October 2019 they introduced a cap of 300 minutes per month on the start plan, with the option to buy packs of 500 build minutes for $7. I&rsquo;m not criticising them for this change. I understand that they need to make money, and I think $7 for 500 minutes is a reasonable price. However, I don&rsquo;t think Netlify has put the necessary protections in place for their customers.</p><p><img src=/img/netlify-1.png alt></p><h2 id=saas-cost-attack>SaaS cost attack</h2><p>A quick Google search for &ldquo;huge bill&rdquo; for AWS, Azure, or GCP returns thousands of results. Stories of people who, at best, misconfigured their infrastructure or, at worst, were the target of a DDoS attack. Whatever the cause, the outcome is the same: a massive bill for thousands of dollars.</p><p>The big three cloud providers, and most other SaaS companies, offer some sort of protections or hard limits to prevent these sorts of surprises: Azure has <a href=https://azure.microsoft.com/en-us/services/cost-management/>Azure Cost Management + Billing</a>, AWS has <a href=https://aws.amazon.com/aws-cost-management/aws-budgets/>AWS Budget</a>, and GCP has <a href=https://cloud.google.com/billing/docs/how-to/budgets>Cloud Billing budgets</a>. Netlify has no such protections.</p><p><img src=/img/netlify-2.png alt></p><p>To me, this seems like a massive oversight and is a core feature that most users, and all business, would expect to have. Obviously the intention here is for Netlify to be able to charge customers when they exceed their build minutes. This also leaves open a massive opportunity for malicious actors to incur huge costs for Netlify customers with very little effort.</p><h2 id=proof-of-concept>Proof-of-concept</h2><p>Netlify allows you to configure your site&rsquo;s build using a <code>netlify.toml</code> stored in the root of your repository. Here&rsquo;s an excerpt taken from <a href=https://docs.netlify.com/configure-builds/file-based-configuration/#sample-file>their documentation</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># Settings in the [build] context are global and are applied to all contexts</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#fff></span><span style=color:#57606a># unless otherwise overridden by more specific contexts.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fff></span><span style=color:#1f2328>[</span>build]<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#fff>  </span><span style=color:#57606a># Directory to change to before starting a build.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#fff>  </span><span style=color:#57606a># This is where we will look for package.json/.nvmrc/etc.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#fff>  </span>base = &#34;project/&#34;<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#fff>  </span><span style=color:#57606a># Directory that contains the deploy-ready HTML files and assets generated by</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#fff>  </span><span style=color:#57606a># the build. This is relative to the base directory if one has been set, or the</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#fff>  </span><span style=color:#57606a># root directory if a base has not been set. This sample publishes the</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#fff>  </span><span style=color:#57606a># directory located at the absolute path &#34;root/project/build-output&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#fff>  </span>publish = &#34;build-output/&#34;<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#fff>  </span><span style=color:#57606a># Default build command.</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#fff>  </span>command = &#34;echo &#39;default context&#39;&#34;<span style=color:#fff>
</span></span></span></code></pre></div><p>If I were to replace <code>command</code> with something like <code>sleep 120</code> and open a pull request that uses Netlify and has not explicitly disabled deploy previews, the Netlify build will happily build my pull request and sleep for two minutes.</p><p><img src=/img/netlify-3.png alt></p><p>A quick <a href="https://github.com/search?q=filename%3Anetlify.toml">search on GitHub</a> for <code>filename:netlify.toml</code> shows there are approximately forty thousand repositories that are potentially vulnerable to this style of attack.</p><p>One small mercy is the fact that Netlify limits builds to 15 minutes by default. So, to cost anyone any money, someone would have to open 20 pull requests with <code>command = "sleep 900"</code>. At that point, I hope either the repository owner would notice, GitHub would rate-limit you, or it would catch the attention of Netlify.</p><h2 id=what-next>What next?</h2><p>I was recently bitten by unexpected charges for build minutes. After contacting Netlify they, very kindly, forgave the charges. However, when I asked about billing protection for customers they replied:</p><blockquote><p>Our policy is to keep your website and builds running as you expect, rather than leaving things in an inconsistent state. I understand it is not what you prefer, but it is what our business prioritizes - expected behavior and continuous uptime for your website and build processes. I have however recorded your feedback for our billing team.</p></blockquote><p>Personally, I have disabled preview deploys on all my sites on Netlify and moved the builds to GitHub Actions. I still use Netlify for NetlifyCMS, but I might look into <a href=https://tylergaw.com/articles/netlify-cms-custom-oath-provider/>using NetlifyCMS with a custom OAuth provider</a> in the future.</p></div><div class=post><h1 class=post-title><a href=/blog/tech-stack-10-year-challenge/>Tech stack #10YearChallenge</a></h1><span class=post-date>Dec 21, 2020 &#183; 5 minute read</span><p><a href="https://twitter.com/search?q=%2310yearchallenge">#10YearChallenge</a> has been trending for a while, so I thought it would be fun to do a 10 year challenge for programming and take a look at the technology I used back in 2010.</p><h2 id=2010>2010</h2><p>10 years ago covers my final year in high school, and my first year in university. Both used completely different programming languages and tech stacks, so it&rsquo;s an interesting place to look back at.</p><p>I was running Windows on my personal machine, but the computers in the engineering department at my university were running Linux (SUSE if I recall correctly). It wasn&rsquo;t my first exposure to Linux, but I was still more comfortable using Windows at this point.</p><h3 id=vbnet>VB.NET</h3><p>I started learning how to program in my final few years of high school. My computer science teacher started us off with Visual Basic .NET. We were actually the first year group to use this stack. Previously my school used Delpi and Pascal, so it was new to everyone.</p><p>For my final year project, I built a system for a hairdresser complete with appointment scheduling, customer database, and inventory management!</p><p><img src=/img/vb-net.png alt="A screenshot of my high school project"></p><h3 id=matlab>MATLAB</h3><p>The first week of university we got thrown into the deep end with a week-long Lego Mindstorms coursework project. There were no real limitations except for your imagination&mldr; and your MATLAB skills. In the end, our team built a robot with an automatic gearbox.</p><p><img src=/img/lego.png alt="A Lego Mindstorms car"></p><p>Despite MATLAB&rsquo;s reputation for not being a &lsquo;real&rsquo; programming language, I used it a lot throughout all four years at university, including for my Master&rsquo;s thesis! I&rsquo;d really recommend <a href=https://www.mathworks.com/matlabcentral/cody/>MATLAB Cody</a> if you&rsquo;re looking to improve your MATLAB skills.</p><h3 id=c>C++</h3><p>Still one of the favourite languages for teaching undergraduates. C++ was used extensively, but one of my proudest pieces of work in C++ is still the logic simulator I wrote for a coursework project.</p><p><img src=/img/logic-emulator.png alt="A screenshot of a logic simulator"></p><p>I really got to cut my teeth on C++ during my first ever internship, working on an H.265/HEVC video encoder at Cisco. To this day, it was some of the most challenging (in a good way) work I&rsquo;ve done. Or to use someone else&rsquo;s words <a href=https://sidbala.com/h-264-is-magic/>&ldquo;H.264 is Magic&rdquo;</a>.</p><h2 id=2020>2020</h2><p>Flash forward to 2020 and I&rsquo;ve been programming professionally for almost 6 years now. In that time, I&rsquo;ve used a lot of different languages including Java, Python, and even a year working in <a href=https://docs.microsoft.com/en-us/dynamics365/fin-ops-core/dev-itpro/dev-ref/xpp-language-reference>X++</a> (despite my attempts to forget it!).</p><p>Even though I work at Microsoft, I&rsquo;ve been running Arch Linux as my daily driver for over 3 years. Yes, I still need to use Windows in a VM from time to time, but the fact that I can achieve my developer workflow almost entirely from Linux just goes to show that Microsoft ♥ Linux isn&rsquo;t just an empty platitude.</p><h2 id=c-1>C#</h2><p>It&rsquo;s only in the last year or so that I&rsquo;ve come back to working on a .NET stack, but already I&rsquo;ve deployed applications on Azure Functions, <a href=http://asp.NET>ASP.NET</a> Core running in Kubernetes, and most recently Service Fabric. C# is a real breath of fresh air coming from 4 years of Java, and I am really excited to see where the language goes after C# 8 and .NET 5.</p><h2 id=typescript>TypeScript</h2><p>If you&rsquo;re doing front-end work nowadays, I think TypeScript is the best way to do it. It papers over the cracks of JavaScipt, and gives you much more confidence, especially when working in a large codebase. The most common stack I work in now is React + TypeScript, and it is a million times better than the jQuery days.</p><p>I&rsquo;ve also used TypeScript for some back-end work too – most notably for <a href=https://github.com/renovatebot/renovate>Renovate</a>. The type system really lends itself well to these sorts of back-end tasks, and I wouldn&rsquo;t discount it over some of the more conventional stacks.</p><h2 id=devops>DevOps</h2><p>Okay, so this one isn&rsquo;t a programming language, but it&rsquo;s definitely something that has changed the way I work. In this context, DevOps means a couple of things to me: testing, continuous integration/continuous delivery (CI/CD) and monitoring.</p><p>In 2010, testing meant manual testing. I remember for my hairdresser management system I had to document my manual test plan. It was a requirement of the marking scheme. Nowadays, it&rsquo;s easier to think of testing as a pyramid with unit tests at the base, integration tests and E2E tests in the middle, and a small number of manual tests at the top. <a href=https://twitter.com/hamvocke>Ham Vocke&rsquo;s</a> <a href=https://martinfowler.com/articles/practical-test-pyramid.html>The Practical Test Pyramid</a> is the definitive guide for testing in 2020.</p><p>CI/CD has been one of my favourite topics lately. Even though the <a href=https://agilemanifesto.org/>agile manifesto</a> talked about it almost 20 years ago, only recently has the barrier to entry gotten so low. Between Github Actions, Gitlab CI, Travis CI and all the rest it&rsquo;s a no-brainer. I use GitHub Actions in almost every side project I build.</p><p>Monitoring is such an important tool for running a successful service. You can use it to pre-emptively fix problems before they become problems or choose what areas to work on based on customer usage. Like CI/CD it&rsquo;s become so easy now. For most platforms all you need to do is include an SDK!</p><h2 id=2030>2030?</h2><p>Who knows what 2030 will bring? Maybe Rust will replace C++ everywhere? Maybe AI will have replaced programmers? Maybe Go will finally get generics?</p></div><div class=pagination><a class=pagination-item href=/>Newer</a>
<a class=pagination-item href=/page/3/>Older</a></div></div></div></body></html>