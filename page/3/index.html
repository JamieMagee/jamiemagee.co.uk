<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.149.0"><meta charset=utf-8><link href=https://gmpg.org/xfn/11 rel=profile><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Jamie Magee &#183; Programmer, Engineer, Problem Solver</title><link rel=preload href=/css/poole.css as=style><link rel=preload href=/css/hyde.css as=style><link rel=preload href=/css/poole-overrides.css as=style><link rel=preload href=/css/hyde-overrides.css as=style><link rel=preload href=/css/hyde-x.css as=style><link rel=preload href=/fonts/BerkeleyMono-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" as=style crossorigin><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css as=style crossorigin><link rel=preload href=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js as=script crossorigin><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/poole-overrides.css><link rel=stylesheet href=/css/hyde-overrides.css><link rel=stylesheet href=/css/hyde-x.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" crossorigin><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css crossorigin><style>@font-face{font-family:berkeley mono;src:url(/fonts/BerkeleyMono-Regular.woff2)format('woff2');font-display:swap}.lite-youtube-fallback{aspect-ratio:16/9;display:flex;justify-content:center;align-items:center;flex-direction:column;gap:1em;padding:1em;background-color:#000;color:#fff;text-decoration:none;border-radius:8px;transition:background-color .2s ease}.lite-youtube-fallback:hover{background-color:#333;color:#fff}.lite-youtube-fallback::before{display:block;content:'';border:solid transparent;border-width:2em 0 2em 3em;border-left-color:red;transition:border-left-color .2s ease}.lite-youtube-fallback:hover::before{border-left-color:#fff}.lite-youtube-fallback:focus{outline:2px solid red;outline-offset:2px}</style><link rel=stylesheet href=/css/jamie.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><link rel=alternate type=application/rss+xml href=/index.xml title="Jamie Magee"><meta name=description content><meta name=keywords content><meta name=author content="Jamie Magee"><meta name=robots content="index, follow"><link rel=canonical href=/><meta property="og:url" content="/"><meta property="og:site_name" content="Jamie Magee"><meta property="og:title" content="Jamie Magee"><meta property="og:locale" content="en_gb"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jamie Magee"><script type=module src=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js></script></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><div class=sidebar-head><h1><a href=/>Jamie Magee</a></h1></div><p class=lead>Programmer, Engineer, Problem Solver</p></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a></li><li class=sidebar-nav-item><a href=/about>About</a></li><li class=sidebar-nav-item><a href=/blog>Archive</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/JamieMagee><i class="fa-brands fa-github-square fa-3x"></i></a>
<a href=https://bsky.app/profile/jamiemagee.bsky.social><i class="fa-brands fa-square-bluesky fa-3x"></i></a>
<a href=https://www.linkedin.com/in/jamiemagee1/><i class="fa-brands fa-linkedin fa-3x"></i></a>
<a href=/index.xml type=application/rss+xml><i class="fa-solid fa-rss-square fa-3x"></i></a></li></ul><p>&copy; 2025. <a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></p></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=/blog/common-async-pitfalls-part-two/>Common async pitfalls—part two</a></h1><span class=post-date>Nov 28, 2020 &#183; 7 minute read</span><p>Following on from <a href=/blog/common-async-pitfalls-part-one/>part one</a>, here&rsquo;s some more of the most common pitfalls I&rsquo;ve come across—either myself, colleagues and friends, or examples in documentation—and how to avoid them.</p><h2 id=fake-sync-is-not-async>&lsquo;Fake&rsquo;-sync is not async</h2><p>If the method you are calling is synchronous, even in an async method, then call it like any other synchronous method. If you want to yield the thread, then you should use <code>Task.Yield</code> in most cases. For UI programming, see <a href=https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.yield>this note</a> about <code>Task.Yield</code> from the .NET API documentation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoStuffAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>await</span> SomeAsyncMethod<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#57606a>// BAD: This provides no benefit and incurs the overhead of a thread hop</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        SomeSyncMethod<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>CompletedTask
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#57606a>// GOOD: Just keep the synchronous call on the current thread</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    SomeSyncMethod<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#57606a>// GOOD: If you have a long-running loop, etc, then periodically yield for maximum thread sharing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> i <span style=color:#1f2328>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#1f2328>&lt;</span> <span style=color:#0550ae>1000</span><span style=color:#1f2328>;</span> i<span style=color:#1f2328>++)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>i <span style=color:#1f2328>%</span> <span style=color:#0550ae>100</span> <span style=color:#1f2328>==</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>Yield<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#57606a>// In some cases you will need to do CPU intensive work. This is ok but</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#57606a>// care should be taken to yield at regular intervals</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        AnExpensiveMethod<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=delegates>Delegates</h2><p>Here&rsquo;s a common pitfall when passing actions as method parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a>// A standard method which accepts a callback. The expectation is that</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#57606a>// all methods execute sequentially</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>void</span> DoSomething<span style=color:#1f2328>(</span>Action callback<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    First<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#cf222e>try</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        callback<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#cf222e>catch</span> <span style=color:#1f2328>(</span>Exception ex<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        Trace<span style=color:#1f2328>.</span>WriteException<span style=color:#1f2328>(</span>ex<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    Second<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#57606a>// GOOD: Invoked with an explicit action</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>DoSomething<span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span> Console<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Hello&#34;</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#57606a>// BAD: This delegate is convertible to an async void method, which is allowed to be passed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#57606a>// to a method which accepts an Action.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>DoSomething<span style=color:#1f2328>(</span><span style=color:#cf222e>async</span> <span style=color:#1f2328>()</span> <span style=color:#1f2328>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>Delay<span style=color:#1f2328>(</span><span style=color:#0550ae>5000</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#57606a>// UH-OH! This exception will not be observed by the catch handler in DoSomething above</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#57606a>// since the caller is not aware that this method is asynchronous</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#cf222e>throw</span> <span style=color:#cf222e>new</span> Exception<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;This will not be observed&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><p>The implicit type conversion from the async function to <code>Action</code> is, surprisingly, not a compiler error! This happens because the function doesn&rsquo;t have a return value, so it&rsquo;s converted to a method with an <code>async void</code> signature. In this example the side effects aren&rsquo;t bad, but in a real application this could be terrible as it violates the expected execution contract.</p><h2 id=synchronization>Synchronization</h2><p>Synchronizing asynchronous code is slightly more complicated than synchronizing synchronous code. Mostly, this is because awaiting a task will result in switching to a different thread. This means that the standard synchronization primitives, which require the same thread to acquire and release a lock, won&rsquo;t work when used in an async state machine.</p><p>Therefore, you must take care to use thread safe synchronization primitives in async methods. For example, using <code>lock</code>, will block the current thread while your code waits to gain exclusive access. In asynchronous code, threads should only block for a short amount of time.</p><p>In general, it&rsquo;s not a good idea to perform any I/O under a lock. There&rsquo;s usually a much better way to synchronize access in asynchronous programming.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>private</span> <span style=color:#cf222e>object</span> _lock <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> <span style=color:#cf222e>object</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#57606a>// GOOD: Don&#39;t do anything expensive inside a lock</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#cf222e>lock</span> <span style=color:#1f2328>(</span>_lock<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    _cache <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Cache<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#57606a>// BAD: This is performing unnecessary I/O under a lock</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#cf222e>lock</span> <span style=color:#1f2328>(</span>_lock<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    _cache <span style=color:#1f2328>=</span> Cache<span style=color:#1f2328>.</span>LoadFromDatabase<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h3 id=lazy-initialization>Lazy Initialization</h3><p>Imagine you need to lazy initialize some object under a lock.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>private</span> <span style=color:#cf222e>object</span> _lock <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> <span style=color:#cf222e>object</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>private</span> <span style=color:#cf222e>bool</span> _initialized <span style=color:#1f2328>=</span> <span style=color:#cf222e>false</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>private</span> <span style=color:#cf222e>int</span> _value<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#57606a>// BAD: This method performs blocking I/O under a lock</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>void</span> Initialize<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>_initialized<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#cf222e>return</span> _value<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#cf222e>lock</span> <span style=color:#1f2328>(</span>_lock<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(!</span>_initialized<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            _value <span style=color:#1f2328>=</span> RetrieveData<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            _initialized <span style=color:#1f2328>=</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#cf222e>return</span> _value<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>When converting <code>RetrieveData</code> to run asynchronously, you might try to rewrite <code>Initialize</code> a few different ways:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>// BAD: Performs I/O and blocks under a lock
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>lock (_lock)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    if (!_initialized)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        _value = RetrieveDataAsync().SyncResult();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        _initialized = true;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>// BAD: Fails at runtime since you cannot change threads under a lock
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>lock (_lock)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    if (!_initialized)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        _value = await RetrieveDataAsync();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        _initialized = true;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>}
</span></span></code></pre></div><p>But there are a few issues:</p><ol><li>You shouldn&rsquo;t call external code under a lock. The caller has no idea what work the external code will do, or what assumptions it has made.</li><li>You shouldn&rsquo;t perform I/O under a lock. Code sections under a lock should execute as quickly as possible, to reduce contention with other threads. As soon as you perform I/O under a lock, avoiding contention isn&rsquo;t possible.</li></ol><h3 id=semaphoreslim>SemaphoreSlim</h3><p>If you absolutely must perform asynchronous work which limits the number of callers, .NET provides <code>SemaphoreSlim</code> which support asynchronous, non-blocking, waiting.</p><p>You still need to take care when converting from a synchronous locking construct. Semaphores, unlike monitor locks, aren&rsquo;t re-entrant.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>private readonly SemaphoreSlim m_gate = new SemaphoreSlim(1, 1);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>public async Task DoThingAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    // Be careful, semaphores aren&#39;t re-entrant!
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    bool acquired = false;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    try
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        acquired = m_gate.WaitAsync(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        if (acquired)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            // Now that we have entered our mutex it is safe to work on shared data structures
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            await DoMyCriticalWorkAsync(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    finally
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        if (acquired)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            m_gate.Release();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>}
</span></span></code></pre></div><h2 id=idisposable>IDisposable</h2><p><code>IDisposible</code> is used to finalize acquired resources. In some cases, you need to dispose of these resources asynchronously, to avoid blocking. Unfortunately, you can&rsquo;t do this inside <code>Dispose()</code>.</p><p>Thankfully, .NET Core 3.0 provides the new <code>IAsyncDisposible</code> interface, which allows you to handle asynchronous finalization like so:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>class</span> <span style=color:#1f2328>Foo</span> <span style=color:#1f2328>:</span> IAsyncDisposable
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DisposeAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#cf222e>await</span> SomethingAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#cf222e>await</span> <span style=color:#cf222e>using</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> foo <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Foo<span style=color:#1f2328>())</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#cf222e>return</span> <span style=color:#cf222e>await</span> foo<span style=color:#1f2328>.</span>DoSomethingAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=ienumerable-and-ienumerator>IEnumerable and IEnumerator</h2><p>Usually you would implement <code>IEnumerable</code> or <code>IEnumerator</code> so you can use syntactic sugar, like <code>foreach</code> and LINQ-to-Objects. Unfortunately, these are synchronous interfaces that can only be used on synchronous data sources. If your underlying data source is actually asynchronous, you shouldn&rsquo;t expose it using these interfaces, as it will lead to blocking.</p><p>With the release of .NET Core 3.0 we got the <code>IAsyncEnumerable</code> and <code>IAsyncEnumerator</code> interfaces, which allow you to enumerate asynchronous data sources:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>await foreach <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> foo <span style=color:#0550ae>in</span> fooCollection<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    await foo<span style=color:#0550ae>.</span>DoSomethingAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=prefer-the-compiler-generated-state-machine>Prefer the compiler-generated state machine</h2><p>There are some valid cases for using <code>Task.ContinueWith</code>, but it can introduce some subtle bugs if not used carefully. It&rsquo;s much easier to avoid it, and just use <code>async</code> and <code>await</code> instead.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#0550ae>//</span> BAD<span style=color:#1f2328>:</span> This is using promise<span style=color:#0550ae>-</span>based constructs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>public Task DoThingAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#cf222e>return</span> DoMoreThingsAsync<span style=color:#1f2328>()</span><span style=color:#0550ae>.</span>ContinueWith<span style=color:#1f2328>((</span>t<span style=color:#1f2328>)</span> <span style=color:#0550ae>=&gt;</span> DoSomethingElse<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#0550ae>//</span> BAD<span style=color:#1f2328>:</span> A much worse version of the above
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>public Task<span style=color:#0550ae>&lt;</span>int<span style=color:#0550ae>&gt;</span> DoThingAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#cf222e>var</span> tcs <span style=color:#0550ae>=</span> new TaskCompletionSource<span style=color:#0550ae>&lt;</span>int<span style=color:#0550ae>&gt;</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    DoMoreThingsAsync<span style=color:#1f2328>()</span><span style=color:#0550ae>.</span>ContinueWith<span style=color:#1f2328>(</span>t <span style=color:#0550ae>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#cf222e>var</span> result <span style=color:#0550ae>=</span> t<span style=color:#0550ae>.</span>Result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#0550ae>//</span> UH<span style=color:#0550ae>-</span>OH<span style=color:#0550ae>!</span> The call to <span style=color:#0550ae>.</span>Result is valid<span style=color:#1f2328>,</span> however<span style=color:#1f2328>,</span> it doesn<span style=color:#0a3069>&#39;t properly handle exceptions</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#0550ae>//</span> which can lead to an async call chain which never completes<span style=color:#0550ae>.</span> This is an very difficult
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#0550ae>//</span> issue to debug as all evidence is garbage collected<span style=color:#0550ae>.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        tcs<span style=color:#0550ae>.</span>SetResult<span style=color:#1f2328>(</span>result<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#cf222e>return</span> tcs<span style=color:#0550ae>.</span>Task<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#0550ae>//</span> GOOD<span style=color:#1f2328>:</span> This is using await
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>public async Task DoThingAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>     await DoMoreThingsAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>     DoAnotherThing<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h3 id=taskcompletionsource>TaskCompletionSource</h3><p><code>TaskCompletionSourc&lt;T></code> allows you to support manual completion in asynchronous code. In general, this class should not be used&mldr; but when you have to use it you should be aware of the following behaviour:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>var</span> waiters <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> List<span style=color:#1f2328>&lt;</span>TaskCompletionSource<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#57606a>// BAD: This uses default continuation options which result in synchronous callbacks</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>Task SomeMethod<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#cf222e>var</span> tcs1 <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> TaskCompletionSource<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    waiters<span style=color:#1f2328>.</span>Add<span style=color:#1f2328>(</span>tcs1<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#cf222e>return</span> tcs1<span style=color:#1f2328>.</span>Task<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#57606a>// GOOD: This uses explicit asynchronous continuations</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>Task SomeMethod<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#cf222e>var</span> tcs2 <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> TaskCompletionSource<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;(</span>TaskCreationOptions<span style=color:#1f2328>.</span>RunContinuationsAsynchronously<span style=color:#1f2328>);</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    waiters<span style=color:#1f2328>.</span>Add<span style=color:#1f2328>(</span>tcs2<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#cf222e>return</span> tcs2<span style=color:#1f2328>.</span>Task<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#57606a>// The problem comes in when a caller awaits your task. The callee may have an expectation that the callbacks execute</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#57606a>// quickly, but in the example below this is only true for the implementation which specifies asynchronous continuation.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#57606a>// The reason is the caller of TaskCompletionSource&lt;T&gt;.SetResult will be blocked for the entire duration of the loop </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#57606a>// below when using the first implementation, while in the second implementation the loop will run on a different thread</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#57606a>// and the caller may continue execution quickly as expected.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#cf222e>async</span> Task SomeCaller<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#cf222e>var</span> foo <span style=color:#1f2328>=</span> <span style=color:#cf222e>await</span> SomeMethod<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#cf222e>for</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> i <span style=color:#1f2328>=</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span> i <span style=color:#1f2328>&lt;</span> <span style=color:#0550ae>10000</span><span style=color:#1f2328>;</span> i<span style=color:#1f2328>++)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#57606a>// Do something synchronous and expensive</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></div><div class=post><h1 class=post-title><a href=/blog/common-async-pitfalls-part-one/>Common async pitfalls—part one</a></h1><span class=post-date>Nov 17, 2020 &#183; 8 minute read</span><p>The .NET Framework provides a great programming model that enables high performance code using an easy to understand syntax. However, this can often give developers a false sense of security, and the language and runtime aren&rsquo;t without pitfalls. Ideally static analysers, like the <a href=https://www.nuget.org/packages/Microsoft.VisualStudio.Threading.Analyzers/>Microsoft.VisualStudio.Threading.Analyzers Roslyn analysers</a>, would catch all these issues at build time. While they do help catch a lot of mistakes, they can&rsquo;t catch everything, so it&rsquo;s important to understand the problems and how to avoid them.</p><p>Here&rsquo;s a collection of some of the most common pitfalls I&rsquo;ve come across—either myself, colleagues and friends, or examples in documentation—and how to avoid them.</p><h2 id=blocking-calls>Blocking calls</h2><p>The main benefit of asynchronous programming is that the thread pool can be smaller than a synchronous application while performing the same amount of work. However, once a piece of code begins to block threads, the resulting thread pool starvation can be ugly.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoStuffAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>bool</span><span style=color:#1f2328>&gt;</span> resultTask <span style=color:#1f2328>=</span> StuffAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#57606a>// BAD: These may deadlock depending on thread pool capacity or the presence of a sync context</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    resultTask<span style=color:#1f2328>.</span>Wait<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    resultTask<span style=color:#1f2328>.</span>Result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    resultTask<span style=color:#1f2328>.</span>GetAwaiter<span style=color:#1f2328>().</span>GetResult<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#57606a>// BAD: This blocks the thread</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    Thread<span style=color:#1f2328>.</span>Sleep<span style=color:#1f2328>(</span><span style=color:#0550ae>5000</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#57606a>// GOOD: Always await</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#cf222e>await</span> resultTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#57606a>// GOOD: This does not block and allows for maximum throughput</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>Delay<span style=color:#1f2328>(</span><span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span> cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>If I run a small test, which makes 5000 concurrent HTTP requests to a local server, there are dramatically different results depending on how many blocking calls are used.</p><p>% blocking shows the number of calls that use <code>Task.Result</code>, which blocks the thread. All other requests use <code>await</code>.</p><table><thead><tr><th>% Blocking</th><th>Threads</th><th>Total Duration</th><th>Avg. Duration</th></tr></thead><tbody><tr><td>0</td><td>24</td><td>00:00:11.961</td><td>0.0023923</td></tr><tr><td>5</td><td>268</td><td>00:02:16.574</td><td>0.0273148</td></tr></tbody></table><p>The increased total duration when using blocking calls is due to the thread pool growth, which happens slowly. You can always tune the thread pool settings to achieve better performance, but it will never match the performance you can achieve with non-blocking calls.</p><h3 id=streams>Streams</h3><p>Like all other blocking calls, any methods from <code>System.IO.Stream</code> should use their async equivalents: <code>Read</code> to <code>ReadAsync</code>, <code>Write</code> to <code>WriteAsync</code>, <code>Flush</code> to <code>FlushAsync</code>, etc. Also, after writing to a stream, you should call the <code>FlushAsync</code> method before disposing the stream. If not, the <code>Dispose</code> method may perform some blocking calls.</p><h2 id=cancellationtoken>CancellationToken</h2><p>You should always propagate cancellation tokens to the next caller in the chain. This is called a cooperative cancellation model. If not, you can end up with methods that run longer than expected, or even worse, never complete.</p><p>To indicate to the caller that cancellation is supported, the final parameter in the method signature should be a <code>CancellationToken</code> object.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoStuffAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#57606a>// BAD: This method does not accept a cancellation token. Cooperative cancellation is extremely important.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#cf222e>await</span> StuffAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoStuffAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#cf222e>var</span> httpClient <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> HttpClient<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#57606a>// BAD: The caller has provided a cancellation token for cooperative cancellation but it was not provided</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#57606a>// downstream. Regardless of the token being signaled the http client will not return until the</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#57606a>// operation completes.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#cf222e>await</span> httpClient<span style=color:#1f2328>.</span>GetAsync<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;http://example.com&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#57606a>// GOOD: Always propagate the token to the next caller in the chain</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>await</span> httpClient<span style=color:#1f2328>.</span>GetAsync<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;http://example.com&#34;</span><span style=color:#1f2328>,</span> cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h3 id=linked-tokens>Linked tokens</h3><p>If you need to put a timeout on an inner method call, you can link one cancellation token to another. For example, you want to make a service-to-service call, and you want to enforce a timeout, while still respecting the external cancellation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;</span> DoThingAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>using</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> cancelTokenSource <span style=color:#1f2328>=</span> CancellationTokenSource<span style=color:#1f2328>.</span>CreateLinkedTokenSource<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#57606a>// The cancellation token source will now manage a timer which automatically notifies the parent</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#57606a>// token.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        cancelTokenSource<span style=color:#1f2328>.</span>CancelAfter<span style=color:#1f2328>(</span>TimeSpan<span style=color:#1f2328>.</span>FromSeconds<span style=color:#1f2328>(</span><span style=color:#0550ae>10</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#57606a>// By linking the token source we will now cooperatively cancel. We have also</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		<span style=color:#57606a>// provided a time based auto-cancellation signal which only applies to the </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		<span style=color:#57606a>// the single method. This is how nested cancellation scopes may be used in circuit breakers.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#cf222e>await</span> GetAsync<span style=color:#1f2328>(</span>cancelTokenSource<span style=color:#1f2328>.</span>Token<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#57606a>// Other calls within the method may not need this restricted timeout so the original</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#57606a>// cancellation token is used instead.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>await</span> DoOtherThingAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h3 id=cancelling-uncancellable-operations>Cancelling uncancellable operations</h3><p>Sometimes you may find the need to call an API which does not accept a cancellation token, but your API receives a token and is expected to respect cancellation. In this case the typical pattern involves managing two tasks and effectively abandoning the un-cancellable operation after the token signals.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;</span> DoThingAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>var</span> tcs <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> TaskCompetionSource<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#cf222e>using</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> registration <span style=color:#1f2328>=</span> cancellationToken<span style=color:#1f2328>.</span>Register<span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span> tcs<span style=color:#1f2328>.</span>SetResult<span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>)))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         <span style=color:#cf222e>var</span> completedTask <span style=color:#1f2328>=</span> <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAny<span style=color:#1f2328>(</span>tcs<span style=color:#1f2328>.</span>Task<span style=color:#1f2328>,</span> DoNonCancellableCallAsync<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>         <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>completedTask <span style=color:#1f2328>==</span> tcs<span style=color:#1f2328>.</span>Task<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>         <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>             <span style=color:#57606a>// We have been cancelled, so take appropriate action here. At this point in time the non-cancellable call is</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>             <span style=color:#57606a>// still running. Once it completes everything will be properly garbage collected</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>             <span style=color:#cf222e>throw</span> <span style=color:#cf222e>new</span> OperationCanceledException<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>         <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#cf222e>return</span> <span style=color:#cf222e>await</span> completedTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=constructors>Constructors</h2><p>Occasionally, you may find yourself wanting to perform asynchronous work during initialization of a class instance. Unfortunately, there is no way to make constructors async.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>Foo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>public</span> Foo<span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> c<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        _a <span style=color:#1f2328>=</span> a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#57606a>// DON&#39;T DO THIS!</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        _b <span style=color:#1f2328>=</span> CallSomethingAsync<span style=color:#1f2328>().</span>SyncResult<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        _c <span style=color:#1f2328>=</span> c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>int</span> _a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>string</span> _b<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>int</span> _c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>There are a couple of different ways to solve this. Here&rsquo;s a pattern I like:</p><ol><li>A public static creator method, which publicly replaces the constructor</li><li>A private async member method, which does the work the constructor used to do</li><li>A private constructor, so callers can&rsquo;t directly instantiate the class by mistake</li></ol><p>So, if I apply the same pattern to the class above the class becomes:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>Foo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>public</span> <span style=color:#cf222e>static</span> <span style=color:#cf222e>async</span> Task<span style=color:#1f2328>&lt;</span>Foo<span style=color:#1f2328>&gt;</span> CreateAsync<span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> c<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        Foo instance <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Foo<span style=color:#1f2328>(</span>a<span style=color:#1f2328>,</span> c<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#cf222e>await</span> instance<span style=color:#1f2328>.</span>InitializeAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#cf222e>return</span> instance<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#cf222e>private</span> Foo<span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> c<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#57606a>// GOOD: readonly keyword is retained</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        _a <span style=color:#1f2328>=</span> a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        _c <span style=color:#1f2328>=</span> c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>async</span> Task InitializeAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#57606a>// GOOD: all async work is performed here</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#57606a>// NOTE: make sure initialization order is correct when porting existing code</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        _b <span style=color:#1f2328>=</span> <span style=color:#cf222e>await</span> CallSomethingAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>int</span> _a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>int</span> _c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#cf222e>string</span> _b<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>And we can instantiate the class by calling <code>var foo = await Foo.CreateAsync(1, 2);</code>.</p><p>In cases where the class is part of an inheritance hierarchy, the constructor can be made protected and <code>InitializeAsync</code> can be made protected virtual, so it can be overridden and called from derived classes. Each derived class will need to have its own <code>CreateAsync</code> method.</p><h2 id=parallelism>Parallelism</h2><h3 id=avoid-premature-optimization>Avoid premature optimization</h3><p>It might be very tempting to try to perform parallel work by not immediately awaiting tasks. In some cases, you can make significant performance improvements. However, if not used with care you can end up in debugging hell involving socket or port exhaustion, or database connection pool saturation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoTwoThingsAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#57606a>// Depending on what you are doing under the covers, this may cause unintended</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#57606a>// consequences such as exhaustion of outgoing sockets or database connections.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#cf222e>var</span> thing1Task <span style=color:#1f2328>=</span> FirstAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#cf222e>var</span> thing2Task <span style=color:#1f2328>=</span> SecondAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>thing1Task<span style=color:#1f2328>,</span> thing2Task<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#57606a>// Prefer sequential execution of asynchronous calls</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#cf222e>await</span> FirstAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#cf222e>await</span> SecondAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>Using async everywhere generally pays off without having to make any individual piece of code faster via parallelization. When threads aren&rsquo;t blocking you can achieve higher performance with the same amount of CPU.</p><h3 id=avoid-taskfactorystartnew-and-use-taskrun-only-when-needed>Avoid Task.Factory.StartNew, and use Task.Run only when needed</h3><p>Even in the cases where not immediately awaiting is safe, you should avoid <code>Task.Factory.StartNew</code>, and only use <code>Task.Run</code> when you need to run some CPU-bound code asynchronously.</p><p>The main way <code>Task.Factory.StartNew</code> is dangerous is that it can look like tasks are awaited when they aren&rsquo;t. For example, if you <code>async</code>-ify the following code:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>Task<span style=color:#1f2328>.</span>Factory<span style=color:#1f2328>.</span>StartNew<span style=color:#1f2328>(</span>Foo<span style=color:#1f2328>),</span> Task<span style=color:#1f2328>.</span>Factory<span style=color:#1f2328>.</span>StartNew<span style=color:#1f2328>(</span>Foo2<span style=color:#1f2328>)).</span>Wait<span style=color:#1f2328>();</span>
</span></span></code></pre></div><p>be careful because changing the delegate to one that returns <code>Task</code>, <code>Task.Factory.StartNew</code> will now return <code>Task&lt;Task></code>. Awaiting only the outer task will only wait until the actual task starts, not finishes.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// BAD: Only waits until all tasks have been scheduled, not until the actual work has completed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>Task<span style=color:#1f2328>.</span>Factory<span style=color:#1f2328>.</span>StartNew<span style=color:#1f2328>(</span>FooAsync<span style=color:#1f2328>),</span> Task<span style=color:#1f2328>.</span>Factory<span style=color:#1f2328>.</span>StartNew<span style=color:#1f2328>(</span>Foo2Async<span style=color:#1f2328>));</span>
</span></span></code></pre></div><p>Normally what you want to do, when you know delegates are not CPU-bound, is to just use the delegates themselves. This is almost always the right thing to do.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// GOOD: Will wait until the tasks have all completed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>FooAsync<span style=color:#1f2328>(),</span> Foo2Async<span style=color:#1f2328>());</span>
</span></span></code></pre></div><p>However, if you are certain the delegates are CPU-bound, and you want to offload this to the thread pool, you can use <code>Task.Run</code>. It&rsquo;s designed to support async delegates. I&rsquo;d still recommend reading <a href=https://blog.stephencleary.com/2013/10/taskrun-etiquette-and-proper-usage.html>Task.Run Etiquette and Proper Usage</a> for a more thorough explanation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#57606a>// Ok if FooAsync is known to be primarily CPU-bound (especially before going async).</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#57606a>// Will schedule the CPU-bound work like Task.Factory.StartNew does,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#57606a>// and automatically convert Task&lt;Task&gt; into a &#39;proxy&#39; Task that represents the actual work</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>Task<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>(</span>FooAsync<span style=color:#1f2328>),</span> Task<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>(</span>Foo2Async<span style=color:#1f2328>))</span>
</span></span></code></pre></div><p>If, for some extremely unlikely reason, you really do need to use <code>Task.Factory.StartNew</code> you can use <code>Unwrap()</code> or <code>await await</code> to convert a <code>Task&lt;Task></code> into a <code>Task</code> that represents the actual work. I&rsquo;d recommend reading <a href=https://devblogs.microsoft.com/pfxteam/task-run-vs-task-factory-startnew/>Task.Run vs Task.Factory.StartNew</a> for a deeper dive into the topic.</p><h2 id=null-conditionals>Null conditionals</h2><p>Using the null conditional operator with awaitables can be dangerous. Awaiting null throws a <code>NullReferenceException</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// BAD: Will throw NullReferenceException if foo is null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>await</span> foo<span style=color:#1f2328>?.</span>DoStuffAsync<span style=color:#1f2328>()</span>
</span></span></code></pre></div><p>Instead, you must do a manual check first.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// GOOD</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>foo <span style=color:#1f2328>!=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#cf222e>await</span> foo<span style=color:#1f2328>.</span>DoStuffAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>A <a href=https://github.com/dotnet/csharplang/issues/35>Null-conditional await</a> is currently under consideration for future versions of C#, but until then you&rsquo;re stuck with manually checking.</p></div><div class=post><h1 class=post-title><a href=/blog/zwift-on-linux/>Zwift on Linux</a></h1><span class=post-date>Apr 7, 2020 &#183; 2 minute read</span><p>Getting Zwift to run on Linux was a journey I started <a href="https://bugs.winehq.org/show_bug.cgi?id=46313">just over a year ago</a>. I didn&rsquo;t get very far with my effort, but since then a lot of progress has been made by the Wine developers and others in the community, and Zwift is now (mostly) playable on Linux. I&rsquo;ll admit there are some workarounds required. Like having to use the <a href=https://support.zwift.com/en_us/using-the-zwift-companion-app-Hybn8qzPr>Zwift companion app</a> to connect sensors. But on the whole, it works well. So I wanted to summarise the process for anyone who wants to try it for themselves.</p><p>I&rsquo;m using <a href=https://lutris.net/>Lutris</a>, a gaming client for Linux, to script out all the steps needed to make games playable on Linux. If you&rsquo;ve never used it before, I&rsquo;d really recommend it for gaming on Linux in general. First things first, you&rsquo;re going to have to download and install Lutris for your Linux distribution. Thankfully Lutris has a great <a href=https://lutris.net/downloads/>help page</a> explaining how to do this for most distributions.</p><h2 id=installation>Installation</h2><p>Once you&rsquo;ve got Lutris installed, installing Zwift is pretty easy. In Lutris search for Zwift, select the only result, and click the “Install” button to start the installation process. You can also start the installer from the command line by running <code>lutris install/zwift-windows</code>.</p><p><img src=/img/ZoL.png alt="Lutris Installer"></p><p>This might take a while, and depending on your internet speed could be anywhere from 10 minutes to around an hour.</p><p>Once the Zwift launcher has finished downloading and updating, we&rsquo;ve hit the first hurdle that can&rsquo;t be scripted with Lutris.</p><lite-youtube videoid=punu7GdyrsE videotitle="Zwift on Linux - Part Two" videoplay=Play posterquality=hqdefault posterloading=lazy><a class=lite-youtube-fallback href="https://www.youtube.com/watch?v=punu7GdyrsE">Watch on YouTube: "Zwift on Linux - Part Two"</a></lite-youtube><p>The launcher will appear as a blank white window. Actually, the launcher is displaying a web page, but Wine can&rsquo;t render properly. Thankfully all the files are already downloaded, so all you need to do is quit the launcher window, and exit Zwift from the Wine system menu. After that, the Lutris installer should complete.</p><h2 id=running-zwift>Running Zwift</h2><p>Zwift requires the Launcher to be running all the time while in-game. However, Lutris only allows 1 application to launch from the “Play” button. So before you hit the play button, first you need to click “Run EXE inside wine prefix” and browse to <code>drive_c\Program Files (x86)\Zwift\ZwiftLauncher</code>. You should see that familiar blank white screen.</p><p>Finally, you can hit the “Play” button and Ride On 👍</p><lite-youtube videoid=GhTK0sI1AXA videotitle="Zwift on Linux - Part Three" videoplay=Play posterquality=hqdefault posterloading=lazy><a class=lite-youtube-fallback href="https://www.youtube.com/watch?v=GhTK0sI1AXA">Watch on YouTube: "Zwift on Linux - Part Three"</a></lite-youtube></div><div class=post><h1 class=post-title><a href=/blog/how-to-host-your-helm-chart-repository-on-github/>How to host your Helm chart repository on GitHub</a></h1><span class=post-date>Apr 2, 2020 &#183; 8 minute read</span><p>Since the release of Helm 3, the official <a href=https://github.com/helm/charts>helm/charts</a> repository has been deprecated in favour of <a href=https://hub.helm.sh/>Helm Hub</a>. While it&rsquo;s great for decentralization and the long term sustainability of the project, I think there&rsquo;s a lot more that is lost. Where is the best place to go for of the expert advice now? Installing Helm now requires you to manually add each repository you use. And there&rsquo;s now some added friction to hosting your Helm charts.</p><p>Thankfully GitHub has all the tools required, in the form of <a href=https://pages.github.com/>GitHub Pages</a> and <a href=https://github.com/features/actions>GitHub Actions</a>, to host a fully automated build pipeline and to host a repository for your Helm charts. Also, we can use some of the tools from the community to ensure our charts are high quality.</p><h2 id=github-pages>GitHub Pages</h2><p>First you need to go ahead and create a <code>gh-pages</code> branch in your repository. As I&rsquo;m writing this there&rsquo;s <a href=https://github.com/helm/chart-releaser-action/issues/10>an issue</a> open to do this automatically, but to do it manually you can run the following:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>git checkout --orphan gh-pages
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>git rm -rf .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>git commit -m <span style=color:#0a3069>&#34;Initial commit&#34;</span> --allow-empty
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>git push
</span></span></code></pre></div><p>Once you&rsquo;ve done that, you need to enable GitHub Pages in your repository. Go to the settings page on your repository and set the source branch to the <code>gh-pages</code> branch you just created.</p><p><img src=/img/github-pages.png alt="GitHub Pages"></p><p>Now you&rsquo;ve configured GitHub Pages, it will act as your Helm repository. Next, you need to configure GitHub Actions to publish to there.</p><h2 id=github-actions>GitHub Actions</h2><p>You&rsquo;re going to use GitHub Actions to create two workflows: one for pull requests, and one for commits to master. Your pull request workflow will deal with linting and testing your chart using a collection of automated tooling. While this isn&rsquo;t a direct replacement for the expert advice offered by the Helm community, it&rsquo;s better than nothing. Your master branch workflow will deal with releasing your charts using GitHub pages, meaning you never have to do it manually.</p><p>First up let&rsquo;s look at the pull request workflow.</p><h2 id=pull-requests>Pull requests</h2><p>For each pull request in your chart repository, you want to run a series of different validation and linting tools to catch any avoidable mistakes in your Helm charts. To do that, go ahead and create a workflow in your repository by creating a file at <code>.github/workflows/ci.yaml</code> and add the following YAML to it:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Lint and Test Charts<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#fff></span><span style=color:#0550ae>on</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fff>  </span><span style=color:#0550ae>pull_request</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#fff>    </span><span style=color:#0550ae>paths</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#fff>      </span>- <span style=color:#0a3069>&#39;charts/**&#39;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#fff></span><span style=color:#0550ae>jobs</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span></code></pre></div><p>This will run the workflow on any pull request that changes files under the charts directory.</p><p>That&rsquo;s the skeleton of the workflow sorted, next onto the tools that you&rsquo;re going to use.</p><h3 id=chart-testing>Chart Testing</h3><p>The Helm project created Chart Testing, AKA <code>ct</code>, as a comprehensive linting tool for Helm charts. To use it in your pull request build, you&rsquo;ll go ahead and add the following job:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#0550ae>lint-chart</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>runs-on</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>ubuntu-latest<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fff>  </span><span style=color:#0550ae>steps</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Checkout<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#fff>      </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>actions/checkout@v1<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Run chart-testing (lint)<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#fff>      </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>helm/chart-testing-action@master<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#fff>      </span><span style=color:#0550ae>with</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#fff>        </span><span style=color:#0550ae>command</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>lint<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#fff>        </span><span style=color:#0550ae>config</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>.github/ct.yaml<span style=color:#fff>
</span></span></span></code></pre></div><p>Where <code>ct.yaml</code> is:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#0550ae>helm-extra-args</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>--timeout 600<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff></span><span style=color:#0550ae>check-version-increment</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#fff></span><span style=color:#0550ae>debug</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#cf222e>true</span><span style=color:#fff>
</span></span></span></code></pre></div><p>For a full list of configuration options check out this <a href=https://github.com/helm/chart-testing/blob/master/pkg/config/test_config.yaml>sample file</a>.</p><p>The <code>lint</code> action for Chart Testing is a bit of a catch-all that helps you prevent a lot of potential bugs or mistakes in your charts. That includes:</p><ul><li>Version checking</li><li>YAML schema validation on <code>Chart.yaml</code></li><li>YAML linting on <code>Chart.yaml</code> and <code>values.yaml</code></li><li>Maintainer validation on changed charts</li></ul><h3 id=helm-docs>Helm-docs</h3><p>Helm-docs isn&rsquo;t strictly a linting tool, but it makes sure that your documentation stays up-to-date with the current state of your chart. It requires that you create a <code>README.md.gotmpl</code> in each chart repository using the <a href=https://github.com/norwoodj/helm-docs#available-templates>available templates</a>, otherwise it will create a <code>README.md</code> for you using a default template.</p><p>To use it as part of your pull request build, you need to add the following job:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#0550ae>lint-docs</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>runs-on</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>ubuntu-latest<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#fff>  </span><span style=color:#0550ae>needs</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>lint-chart<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fff>  </span><span style=color:#0550ae>steps</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Checkout<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#fff>      </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>actions/checkout@v1<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Run helm-docs<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#fff>      </span><span style=color:#0550ae>run</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>.github/helm-docs.sh<span style=color:#fff>
</span></span></span></code></pre></div><p>Where <a href=http://helm-docs.sh><code>helm-docs.sh</code></a> is:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a>#!/bin/bash
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#57606a></span><span style=color:#6639ba>set</span> -euo pipefail
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#953800>HELM_DOCS_VERSION</span><span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;0.11.0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#57606a># install helm-docs</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>curl --silent --show-error --fail --location --output /tmp/helm-docs.tar.gz https://github.com/norwoodj/helm-docs/releases/download/v<span style=color:#0a3069>&#34;</span><span style=color:#0a3069>${</span><span style=color:#953800>HELM_DOCS_VERSION</span><span style=color:#0a3069>}</span><span style=color:#0a3069>&#34;</span>/helm-docs_<span style=color:#0a3069>&#34;</span><span style=color:#0a3069>${</span><span style=color:#953800>HELM_DOCS_VERSION</span><span style=color:#0a3069>}</span><span style=color:#0a3069>&#34;</span>_Linux_x86_64.tar.gz
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>tar -xf /tmp/helm-docs.tar.gz helm-docs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#57606a># validate docs</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>./helm-docs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>git diff --exit-code
</span></span></code></pre></div><p>This runs Helm-docs against each chart in your repository and generates the <code>README.md</code> for each one. Then, using git, you&rsquo;ll fail the build if there are any differences. This ensures that you can&rsquo;t check in any changes to your charts without also updating the documentation.</p><h3 id=kubeval>Kubeval</h3><p>Next up is Kubeval. It validates the output from Helm against schemas generated from the Kubernetes OpenAPI specification. You&rsquo;re going to add it to your pull request, and use it to validate across multiple different versions of Kubernetes. Add the following job:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#0550ae>kubeval-chart</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>runs-on</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>ubuntu-latest<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fff>  </span><span style=color:#0550ae>needs</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#fff>    </span>- lint-chart<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#fff>    </span>- lint-docs<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#fff>  </span><span style=color:#0550ae>strategy</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#fff>    </span><span style=color:#0550ae>matrix</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#fff>      </span><span style=color:#0550ae>k8s</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#fff>        </span>- v1.12.10<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#fff>        </span>- v1.13.12<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#fff>        </span>- v1.14.10<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#fff>        </span>- v1.15.11<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#fff>        </span>- v1.16.8<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#fff>        </span>- v1.17.4<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#fff>  </span><span style=color:#0550ae>steps</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Checkout<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#fff>      </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>actions/checkout@v1<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Run kubeval<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#fff>      </span><span style=color:#0550ae>env</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#fff>        </span><span style=color:#0550ae>KUBERNETES_VERSION</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>${{ matrix.k8s }}<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#fff>      </span><span style=color:#0550ae>run</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>.github/kubeval.sh<span style=color:#fff>
</span></span></span></code></pre></div><p>Where <a href=http://kubeval.sh><code>kubeval.sh</code></a> is:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a>#!/bin/bash
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#57606a></span><span style=color:#6639ba>set</span> -euo pipefail
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#953800>CHART_DIRS</span><span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;</span><span style=color:#cf222e>$(</span>git diff --find-renames --name-only <span style=color:#0a3069>&#34;</span><span style=color:#cf222e>$(</span>git rev-parse --abbrev-ref HEAD<span style=color:#cf222e>)</span><span style=color:#0a3069>&#34;</span> remotes/origin/master -- charts <span style=color:#1f2328>|</span> grep <span style=color:#0a3069>&#39;[cC]hart.yaml&#39;</span> <span style=color:#1f2328>|</span> sed -e <span style=color:#0a3069>&#39;s#/[Cc]hart.yaml##g&#39;</span><span style=color:#cf222e>)</span><span style=color:#0a3069>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#953800>KUBEVAL_VERSION</span><span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;0.14.0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#953800>SCHEMA_LOCATION</span><span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;https://raw.githubusercontent.com/instrumenta/kubernetes-json-schema/master/&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#57606a># install kubeval</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>curl --silent --show-error --fail --location --output /tmp/kubeval.tar.gz https://github.com/instrumenta/kubeval/releases/download/<span style=color:#0a3069>&#34;</span><span style=color:#0a3069>${</span><span style=color:#953800>KUBEVAL_VERSION</span><span style=color:#0a3069>}</span><span style=color:#0a3069>&#34;</span>/kubeval-linux-amd64.tar.gz
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>tar -xf /tmp/kubeval.tar.gz kubeval
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#57606a># validate charts</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#cf222e>for</span> CHART_DIR in <span style=color:#0a3069>${</span><span style=color:#953800>CHART_DIRS</span><span style=color:#0a3069>}</span><span style=color:#1f2328>;</span> <span style=color:#cf222e>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  helm template <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>${</span><span style=color:#953800>CHART_DIR</span><span style=color:#0a3069>}</span><span style=color:#0a3069>&#34;</span> <span style=color:#1f2328>|</span> ./kubeval --strict --ignore-missing-schemas --kubernetes-version <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>${</span><span style=color:#953800>KUBERNETES_VERSION</span><span style=color:#1f2328>#v</span><span style=color:#0a3069>}</span><span style=color:#0a3069>&#34;</span> --schema-location <span style=color:#0a3069>&#34;</span><span style=color:#0a3069>${</span><span style=color:#953800>SCHEMA_LOCATION</span><span style=color:#0a3069>}</span><span style=color:#0a3069>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#cf222e>done</span>
</span></span></code></pre></div><p>This script is a bit longer, but if you break it down step-by-step it&rsquo;s essentially:</p><ol><li>Get a list of charts that have been changed between this PR and master branch</li><li>Install Kubeval</li><li>For each chart:<ol><li>Generate the Kubernetes configuration using Helm</li><li>Validatate the configuration using Kubeval</li></ol></li></ol><p>You&rsquo;re doing this for each version of Kubernetes you&rsquo;ve defined in the job, so if you&rsquo;re using an API that isn&rsquo;t available in all versions, Kubeval will fail the build. This help keep backwards compatibility for all of your charts, and makes sure you&rsquo;re not releasing breaking changes accidentally.</p><p>This doesn&rsquo;t guarantee that the chart will actually install successfully on Kubernetes—but that&rsquo;s where Kubernetes in Docker comes in.</p><h3 id=kubernetes-in-docker-kind>Kubernetes in Docker (KIND)</h3><p>Finally you&rsquo;re going to use Chart Testing again to install your Helm charts on a Kubernetes cluster running in the GitHub Actions runner using Kubernetes in Docker (KIND). Like Kubeval, you can create clusters for different versions of Kubernetes.</p><p>KIND doesn&rsquo;t publish Docker images for each version of Kubernetes, so you need to look at the Docker <a href=https://hub.docker.com/r/kindest/node/tags>image tags</a>. That&rsquo;s why the Kubernetes versions in this job won&rsquo;t necessarily match the versions used for the Kubeval job.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#0550ae>install-chart</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#fff>  </span><span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>install-chart<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fff>  </span><span style=color:#0550ae>runs-on</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>ubuntu-latest<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#fff>  </span><span style=color:#0550ae>needs</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#fff>    </span>- lint-chart<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#fff>    </span>- lint-docs<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#fff>    </span>- kubeval-chart<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#fff>  </span><span style=color:#0550ae>strategy</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#fff>    </span><span style=color:#0550ae>matrix</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#fff>      </span><span style=color:#0550ae>k8s</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#fff>        </span>- v1.12.10<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#fff>        </span>- v1.13.12<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#fff>        </span>- v1.14.10<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#fff>        </span>- v1.15.7<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#fff>        </span>- v1.16.4<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#fff>        </span>- v1.17.2<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#fff>  </span><span style=color:#0550ae>steps</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Checkout<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#fff>      </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>actions/checkout@v1<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Create kind ${{ matrix.k8s }} cluster<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#fff>      </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>helm/kind-action@master<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#fff>      </span><span style=color:#0550ae>with</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#fff>        </span><span style=color:#0550ae>node_image</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>kindest/node:${{ matrix.k8s }}<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#fff>    </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Run chart-testing (install)<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#fff>      </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>helm/chart-testing-action@master<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#fff>      </span><span style=color:#0550ae>with</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#fff>        </span><span style=color:#0550ae>command</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>install<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#fff>        </span><span style=color:#0550ae>config</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>.github/ct.yaml<span style=color:#fff>
</span></span></span></code></pre></div><p>So you got a temporary Kubernetes cluster, installed your charts on it, and ran any <a href=https://helm.sh/docs/topics/chart_tests/>helm tests</a> (that you definitely wrote 🙄). This is the ultimate test of your Helm chart—installing and running it. If this passes, and you merge your pull request, you&rsquo;re ready to release!</p><h2 id=releasing>Releasing</h2><p>Remember that <code>gh-pages</code> branch you created earlier? Now you can use it to publish your fully tested Helm chart to.</p><p>You&rsquo;re going to create another GitHub workflow, this time at <code>.github/workflows/release.yaml</code>. This one is going to be significantly simpler:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Release Charts<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fff></span><span style=color:#0550ae>on</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#fff>  </span><span style=color:#0550ae>push</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#fff>    </span><span style=color:#0550ae>branches</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#fff>      </span>- master<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#fff>    </span><span style=color:#0550ae>paths</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#fff>      </span>- <span style=color:#0a3069>&#39;charts/**&#39;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#fff></span><span style=color:#0550ae>jobs</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#fff>  </span><span style=color:#0550ae>release</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#fff>    </span><span style=color:#0550ae>runs-on</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>ubuntu-latest<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#fff>    </span><span style=color:#0550ae>steps</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#fff>      </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Checkout<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#fff>        </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>actions/checkout@v1<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#fff>      </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Configure Git<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#fff>        </span><span style=color:#0550ae>run</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#1f2328>|</span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#0a3069>          git config user.name &#34;$GITHUB_ACTOR&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#0a3069>          git config user.email &#34;$GITHUB_ACTOR@users.noreply.github.com&#34;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#fff>      </span>- <span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Run chart-releaser<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#fff>        </span><span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>helm/chart-releaser-action@master<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#fff>        </span><span style=color:#0550ae>env</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#fff>          </span><span style=color:#0550ae>CR_TOKEN</span><span style=color:#1f2328>:</span><span style=color:#fff> </span><span style=color:#0a3069>&#39;${{ secrets.CR_TOKEN }}&#39;</span><span style=color:#fff>
</span></span></span></code></pre></div><p>It will check out the repository, set the configuration of Git to the user that kicked-off the workflow, and run the chart releaser action. The chart releaser action will package the chart, create a release from it, and update the <code>index.yaml</code> file in the <code>gh-pages</code> branch. Simple!</p><p>But one thing you still need to do is create a secret in your repository, <code>CR_TOKEN</code>, which contains a GitHub <a href=https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line#creating-a-token>personal access token</a> with <code>repo</code> scope. This is due to a <a href=https://github.community/t5/GitHub-Actions/Github-action-not-triggering-gh-pages-upon-push/m-p/31266/highlight/true#M743>GitHub Actions bug</a>, where GitHub Pages is not deployed when pushing from GitHub Actions.</p><p><img src=/img/github-secrets.png alt="GitHub Secrets"></p><p>Once that&rsquo;s all configured, any time a change under the charts directory is checked in, like from a pull request, your Github workflow will run and your charts will be available almost instantly!</p><h2 id=next-steps>Next steps</h2><p>From here you&rsquo;ll want to add your repository to Helm so you can use it, and share it on <a href=https://hub.helm.sh/>Helm Hub</a> so others can too. For the former, you&rsquo;ll need to run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>helm repo add renovate https://&lt;username&gt;.github.io/&lt;repository&gt;/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>helm repo update
</span></span></code></pre></div><p>And for the latter, the Helm project have written <a href=https://github.com/helm/hub/blob/master/Repositories.md>a comprehensive guide</a> that I couldn&rsquo;t possibly top.</p><p>If you want to see all these pieces working together checkout the <a href=https://github.com/renovatebot/helm-charts>renovatebot/helm-charts</a> repository, or our page on <a href=https://hub.helm.sh/charts/renovate/renovate>Helm Hub</a>. And if you would like some help please reach out to me on Twitter at <a href=https://twitter.com/Jamie_Magee>@Jamie_Magee</a>.</p></div><div class=post><h1 class=post-title><a href=/blog/7-tips-for-converting-csharp-code-to-async-await/>7 tips for converting C# code to async/await</a></h1><span class=post-date>Mar 16, 2020 &#183; 5 minute read</span><p>Over the past year I&rsquo;ve moved from working mainly in Java, to working mainly in C#. To be honest, Java and C# have more in common than not, but one of the major differences is async/await. It&rsquo;s a really powerful tool if used correctly, but also a very quick way to shoot yourself in the foot.</p><p>Asynchronous programming looks very similar to synchronous programming. However, there are some core concepts which need to be understood in order to form a proper mental model when converting between synchronous and asynchronous programming patterns.</p><p>Here are some of the most common ones I&rsquo;ve come across.</p><h2 id=naming>Naming</h2><p>Method names must use the suffix Async when returning a <code>Task</code> or <code>Task&lt;T></code>. Consistency is key as the <code>Async</code> suffix provides not only a mental signal to the caller that the await keyword should be used, but also provides a consistent naming convention.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// Synchronous method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>void</span> DoSomething<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span> <span style=color:#f6f8fa;background-color:#82071e>…</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#57606a>// Asynchronous method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoSomethingAsync<span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span> <span style=color:#f6f8fa;background-color:#82071e>…</span> <span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=return-types>Return types</h2><p>Every async method returns a <code>Task</code>. Use <code>Task</code> when there is no specific result for the method, which is synonymous with <code>void</code>. Use <code>Task&lt;T></code> when a return value is required.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a>// Original method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>void</span> DoSomething<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#cf222e>using</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> client <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> HttpClient<span style=color:#1f2328>())</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        client<span style=color:#1f2328>.</span>GetAsync<span style=color:#1f2328>().</span>Result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#57606a>// BAD: This utilizes an anti-pattern. async void provides no mechanism</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#57606a>// for the caller to observe the result, including exceptions.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> <span style=color:#cf222e>void</span> DoSomethingAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#cf222e>using</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> client <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> HttpClient<span style=color:#1f2328>())</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#cf222e>await</span> client<span style=color:#1f2328>.</span>GetAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#57606a>// GOOD: This provides proper access to the completion task. The caller may now</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#57606a>// await the method call and observe/handle results and exceptions correctly.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoSomethingAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#cf222e>using</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> client <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> HttpClient<span style=color:#1f2328>())</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#cf222e>await</span> client<span style=color:#1f2328>.</span>GetAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=parameters>Parameters</h2><p>There is not a way for the compiler to manage <code>ref</code> and <code>out</code> parameters. (That&rsquo;s a topic for another time.) When multiple values need to be returned you should either use custom objects or a <code>Tuple</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a>// Original method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>bool</span> TryGet<span style=color:#1f2328>(</span><span style=color:#cf222e>string</span> key<span style=color:#1f2328>,</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>string</span> <span style=color:#cf222e>value</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#cf222e>value</span> <span style=color:#1f2328>=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(!</span>m_cache<span style=color:#1f2328>.</span>TryGetValue<span style=color:#1f2328>(</span>key<span style=color:#1f2328>,</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>value</span><span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#cf222e>value</span> <span style=color:#1f2328>=</span> GetValueFromSource<span style=color:#1f2328>(</span>key<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#cf222e>return</span> <span style=color:#cf222e>value</span> <span style=color:#1f2328>!=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#57606a>// New method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task<span style=color:#1f2328>&lt;(</span><span style=color:#cf222e>bool</span> exists<span style=color:#1f2328>,</span> <span style=color:#cf222e>string</span> <span style=color:#cf222e>value</span><span style=color:#1f2328>)&gt;</span> TryGetAsync<span style=color:#1f2328>(</span><span style=color:#cf222e>string</span> key<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#cf222e>string</span> <span style=color:#cf222e>value</span> <span style=color:#1f2328>=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(!</span>m_cache<span style=color:#1f2328>.</span>TryGetValue<span style=color:#1f2328>(</span>key<span style=color:#1f2328>,</span> <span style=color:#cf222e>out</span> <span style=color:#cf222e>value</span><span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#cf222e>value</span> <span style=color:#1f2328>=</span> <span style=color:#cf222e>await</span> GetValueFromSourceAsync<span style=color:#1f2328>(</span>key<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#cf222e>return</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>value</span> <span style=color:#1f2328>!=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>value</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=delegates>Delegates</h2><p>Following up on the lack of the <code>void</code> return type, no async method should be defined as an <code>Action</code> variant. When accepting a delegate to an asynchronous method, the asynchronous pattern should be propagated by accepting <code>Func&lt;Task></code> or <code>Func&lt;Task&lt;T>></code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>void</span> TraceHelper<span style=color:#1f2328>(</span>Action action<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Trace<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;calling action&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    action<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    Trace<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;called action&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#57606a>// Action =&gt; Func&lt;Task&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#57606a>// Action&lt;T&gt; maps to Func&lt;T, Task&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#57606a>// etc.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task TraceHelperAsync<span style=color:#1f2328>(</span>Func<span style=color:#1f2328>&lt;</span>Task<span style=color:#1f2328>&gt;</span> action<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    Trace<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;calling action&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#cf222e>await</span> action<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    Trace<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;called action&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#57606a>// Example call to the method with a synchronous callback implementation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#cf222e>await</span> TraceHelperAsync<span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>{</span> Console<span style=color:#1f2328>.</span>WriteLine<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Called me&#34;</span><span style=color:#1f2328>);</span> <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>CompletedTask<span style=color:#1f2328>;</span> <span style=color:#1f2328>});</span>
</span></span></code></pre></div><h2 id=virtual-methods>Virtual methods</h2><p>In asynchronous programming there is no concept of a <code>void</code> return type, as the basis of the model is that each method returns a mechanism for signalling completion of the asynchronous work. When converting base classes which have empty implementations or return constant values, the framework provides methods and helpers to facilitate the pattern.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a>// The original synchronous version of the class</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>MyClass</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#cf222e>protected</span> <span style=color:#cf222e>virtual</span> <span style=color:#cf222e>void</span> DoStuff<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#57606a>// Do nothing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#cf222e>protected</span> <span style=color:#cf222e>virtual</span> <span style=color:#cf222e>int</span> GetValue<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#cf222e>return</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#57606a>// The converted asynchronous version of the class</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>MyClass</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#cf222e>protected</span> <span style=color:#cf222e>virtual</span> Task DoStuffAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#57606a>// This static accessor avoids new allocations for synchronous &#39;no-op&#39; methods such as this</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>CompletedTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#cf222e>protected</span> <span style=color:#cf222e>virtual</span> Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;</span> GetValueAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#57606a>// This factory method returns a completed task with the specified result</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>FromResult<span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=interfaces>Interfaces</h2><p>Like delegates, interfaces should always be declared async which ensures an async-aware model throughout the stack.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>interface</span> <span style=color:#1f2328>IMyPlugin</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Task DoStuffAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;</span> DoMoreAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>MyPluginImpl</span> <span style=color:#1f2328>:</span> IMyPlugin
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#57606a>// When the method does not have a result, use the static accessor</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#cf222e>public</span> Task DoStuffAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        DoSomething<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>CompletedTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#57606a>// When the method has a result, use the static factory function</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>public</span> Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;</span> DoMoreAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        DoSomething<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>FromResult<span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=mocks>Mocks</h2><p>In certain cases, mostly unit test mocks, you may find the need to implement interfaces without having any reason to actually perform any asynchronous calls. In these specific cases it is OK to feign asynchronous execution using <code>Task.CompletedTask</code> or <code>Task.FromResult&lt;T>(T result)</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a>// Example mock implementation for testing. Moq is not smart enough to generate a non-null completed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#57606a>// task by default, so you will need to explicitly mock out all methods</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>Mock<span style=color:#1f2328>&lt;</span>IMyPlugin<span style=color:#1f2328>&gt;</span> mockPlugin <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Mock<span style=color:#1f2328>&lt;</span>IMyPlugin<span style=color:#1f2328>&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#57606a>// When a constant value is returned</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>mockPlugin<span style=color:#1f2328>.</span>Setup<span style=color:#1f2328>(</span>x <span style=color:#1f2328>=&gt;</span> x<span style=color:#1f2328>.</span>DoStuffAsync<span style=color:#1f2328>(</span>It<span style=color:#1f2328>.</span>IsAny<span style=color:#1f2328>&lt;</span>CancellationToken<span style=color:#1f2328>&gt;()).</span>Returns<span style=color:#1f2328>(</span>Task<span style=color:#1f2328>.</span>CompletedTask<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>mockPlugin<span style=color:#1f2328>.</span>Setup<span style=color:#1f2328>(</span>x <span style=color:#1f2328>=&gt;</span> x<span style=color:#1f2328>.</span>DoMoreAsync<span style=color:#1f2328>(</span>It<span style=color:#1f2328>.</span>IsAny<span style=color:#1f2328>&lt;</span>CancellationToken<span style=color:#1f2328>&gt;()).</span>ReturnsAsync<span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#57606a>// When a dynamic value is returned</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>mockPlugin<span style=color:#1f2328>.</span>Setup<span style=color:#1f2328>(</span>x <span style=color:#1f2328>=&gt;</span> x<span style=color:#1f2328>.</span>DoStuffAsync<span style=color:#1f2328>(</span>It<span style=color:#1f2328>.</span>IsAny<span style=color:#1f2328>&lt;</span>CancellationToken<span style=color:#1f2328>&gt;()).</span>Returns<span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>     DoStuffImpl<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>     <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>CompletedTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>mockPlugin<span style=color:#1f2328>.</span>Setup<span style=color:#1f2328>(</span>x <span style=color:#1f2328>=&gt;</span> x<span style=color:#1f2328>.</span>DoMoreAsync<span style=color:#1f2328>(</span>It<span style=color:#1f2328>.</span>IsAny<span style=color:#1f2328>&lt;</span>CancellationToken<span style=color:#1f2328>&gt;()).</span>Returns<span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>     DoMoreImpl<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>     <span style=color:#cf222e>return</span> Task<span style=color:#1f2328>.</span>FromResult<span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><h2 id=summary>Summary</h2><p>Overall asynchronous programming is much better for performance, but requires a slightly different mental model. I hope these tips help!</p></div><div class=pagination><a class=pagination-item href=/page/2/>Newer</a>
<a class=pagination-item href=/page/4/>Older</a></div></div></div></body></html>