<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><link href=https://gmpg.org/xfn/11 rel=profile><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Common async pitfalls—part one &#183; Jamie Magee</title><link rel=preload href=/css/poole.css as=style><link rel=preload href=/css/hyde.css as=style><link rel=preload href=/css/poole-overrides.css as=style><link rel=preload href=/css/hyde-overrides.css as=style><link rel=preload href=/css/hyde-x.css as=style><link rel=preload href=/fonts/BerkeleyMono-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" as=style crossorigin><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css as=style crossorigin><link rel=preload href=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js as=script crossorigin><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/poole-overrides.css><link rel=stylesheet href=/css/hyde-overrides.css><link rel=stylesheet href=/css/hyde-x.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" crossorigin><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css crossorigin><style>@font-face{font-family:berkeley mono;src:url(/fonts/BerkeleyMono-Regular.woff2)format('woff2');font-display:swap}.lite-youtube-fallback{aspect-ratio:16/9;display:flex;justify-content:center;align-items:center;flex-direction:column;gap:1em;padding:1em;background-color:#000;color:#fff;text-decoration:none;border-radius:8px;transition:background-color .2s ease}.lite-youtube-fallback:hover{background-color:#333;color:#fff}.lite-youtube-fallback::before{display:block;content:'';border:solid transparent;border-width:2em 0 2em 3em;border-left-color:red;transition:border-left-color .2s ease}.lite-youtube-fallback:hover::before{border-left-color:#fff}.lite-youtube-fallback:focus{outline:2px solid red;outline-offset:2px}</style><link rel=stylesheet href=/css/jamie.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><meta name=description content><meta name=keywords content><meta name=author content="Jamie Magee"><meta name=robots content="index, follow"><link rel=canonical href=/blog/common-async-pitfalls-part-one/><meta property="og:url" content="/blog/common-async-pitfalls-part-one/"><meta property="og:site_name" content="Jamie Magee"><meta property="og:title" content="Common async pitfalls—part one"><meta property="og:description" content="The .NET Framework provides a great programming model that enables high performance code using an easy to understand syntax. However, this can often give developers a false sense of security, and the language and runtime aren’t without pitfalls. Ideally static analysers, like the Microsoft.VisualStudio.Threading.Analyzers Roslyn analysers, would catch all these issues at build time. While they do help catch a lot of mistakes, they can’t catch everything, so it’s important to understand the problems and how to avoid them."><meta property="og:locale" content="en_gb"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-11-17T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Common async pitfalls—part one"><meta name=twitter:description content="The .NET Framework provides a great programming model that enables high performance code using an easy to understand syntax. However, this can often give developers a false sense of security, and the language and runtime aren’t without pitfalls. Ideally static analysers, like the Microsoft.VisualStudio.Threading.Analyzers Roslyn analysers, would catch all these issues at build time. While they do help catch a lot of mistakes, they can’t catch everything, so it’s important to understand the problems and how to avoid them."><script type=module src=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js></script></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><div class=sidebar-head><h1><a href=/>Jamie Magee</a></h1></div><p class=lead>Programmer, Engineer, Problem Solver</p></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a></li><li class=sidebar-nav-item><a href=/about>About</a></li><li class=sidebar-nav-item><a href=/blog>Archive</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/JamieMagee><i class="fa-brands fa-github-square fa-3x"></i></a>
<a href=https://bsky.app/profile/jamiemagee.bsky.social><i class="fa-brands fa-square-bluesky fa-3x"></i></a>
<a href=https://www.linkedin.com/in/jamiemagee1/><i class="fa-brands fa-linkedin fa-3x"></i></a>
<a href=/index.xml type=application/rss+xml><i class="fa-solid fa-rss-square fa-3x"></i></a></li></ul><p>&copy; 2025. <a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></p></div></div><div class="content container"><div class=post><h1 class=post-title>Common async pitfalls—part one</h1><span class=post-date>Nov 17, 2020 &#183; 8 minute read</span><p>The .NET Framework provides a great programming model that enables high performance code using an easy to understand syntax. However, this can often give developers a false sense of security, and the language and runtime aren&rsquo;t without pitfalls. Ideally static analysers, like the <a href=https://www.nuget.org/packages/Microsoft.VisualStudio.Threading.Analyzers/>Microsoft.VisualStudio.Threading.Analyzers Roslyn analysers</a>, would catch all these issues at build time. While they do help catch a lot of mistakes, they can&rsquo;t catch everything, so it&rsquo;s important to understand the problems and how to avoid them.</p><p>Here&rsquo;s a collection of some of the most common pitfalls I&rsquo;ve come across—either myself, colleagues and friends, or examples in documentation—and how to avoid them.</p><h2 id=blocking-calls>Blocking calls</h2><p>The main benefit of asynchronous programming is that the thread pool can be smaller than a synchronous application while performing the same amount of work. However, once a piece of code begins to block threads, the resulting thread pool starvation can be ugly.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoStuffAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>bool</span><span style=color:#1f2328>&gt;</span> resultTask <span style=color:#1f2328>=</span> StuffAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#57606a>// BAD: These may deadlock depending on thread pool capacity or the presence of a sync context</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    resultTask<span style=color:#1f2328>.</span>Wait<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    resultTask<span style=color:#1f2328>.</span>Result<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    resultTask<span style=color:#1f2328>.</span>GetAwaiter<span style=color:#1f2328>().</span>GetResult<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#57606a>// BAD: This blocks the thread</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    Thread<span style=color:#1f2328>.</span>Sleep<span style=color:#1f2328>(</span><span style=color:#0550ae>5000</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#57606a>// GOOD: Always await</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#cf222e>await</span> resultTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#57606a>// GOOD: This does not block and allows for maximum throughput</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>Delay<span style=color:#1f2328>(</span><span style=color:#0550ae>5000</span><span style=color:#1f2328>,</span> cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>If I run a small test, which makes 5000 concurrent HTTP requests to a local server, there are dramatically different results depending on how many blocking calls are used.</p><p>% blocking shows the number of calls that use <code>Task.Result</code>, which blocks the thread. All other requests use <code>await</code>.</p><table><thead><tr><th>% Blocking</th><th>Threads</th><th>Total Duration</th><th>Avg. Duration</th></tr></thead><tbody><tr><td>0</td><td>24</td><td>00:00:11.961</td><td>0.0023923</td></tr><tr><td>5</td><td>268</td><td>00:02:16.574</td><td>0.0273148</td></tr></tbody></table><p>The increased total duration when using blocking calls is due to the thread pool growth, which happens slowly. You can always tune the thread pool settings to achieve better performance, but it will never match the performance you can achieve with non-blocking calls.</p><h3 id=streams>Streams</h3><p>Like all other blocking calls, any methods from <code>System.IO.Stream</code> should use their async equivalents: <code>Read</code> to <code>ReadAsync</code>, <code>Write</code> to <code>WriteAsync</code>, <code>Flush</code> to <code>FlushAsync</code>, etc. Also, after writing to a stream, you should call the <code>FlushAsync</code> method before disposing the stream. If not, the <code>Dispose</code> method may perform some blocking calls.</p><h2 id=cancellationtoken>CancellationToken</h2><p>You should always propagate cancellation tokens to the next caller in the chain. This is called a cooperative cancellation model. If not, you can end up with methods that run longer than expected, or even worse, never complete.</p><p>To indicate to the caller that cancellation is supported, the final parameter in the method signature should be a <code>CancellationToken</code> object.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoStuffAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#57606a>// BAD: This method does not accept a cancellation token. Cooperative cancellation is extremely important.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#cf222e>await</span> StuffAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoStuffAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#cf222e>var</span> httpClient <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> HttpClient<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#57606a>// BAD: The caller has provided a cancellation token for cooperative cancellation but it was not provided</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#57606a>// downstream. Regardless of the token being signaled the http client will not return until the</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#57606a>// operation completes.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#cf222e>await</span> httpClient<span style=color:#1f2328>.</span>GetAsync<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;http://example.com&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#57606a>// GOOD: Always propagate the token to the next caller in the chain</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>await</span> httpClient<span style=color:#1f2328>.</span>GetAsync<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;http://example.com&#34;</span><span style=color:#1f2328>,</span> cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h3 id=linked-tokens>Linked tokens</h3><p>If you need to put a timeout on an inner method call, you can link one cancellation token to another. For example, you want to make a service-to-service call, and you want to enforce a timeout, while still respecting the external cancellation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;</span> DoThingAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>using</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> cancelTokenSource <span style=color:#1f2328>=</span> CancellationTokenSource<span style=color:#1f2328>.</span>CreateLinkedTokenSource<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#57606a>// The cancellation token source will now manage a timer which automatically notifies the parent</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#57606a>// token.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        cancelTokenSource<span style=color:#1f2328>.</span>CancelAfter<span style=color:#1f2328>(</span>TimeSpan<span style=color:#1f2328>.</span>FromSeconds<span style=color:#1f2328>(</span><span style=color:#0550ae>10</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#57606a>// By linking the token source we will now cooperatively cancel. We have also</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		<span style=color:#57606a>// provided a time based auto-cancellation signal which only applies to the </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		<span style=color:#57606a>// the single method. This is how nested cancellation scopes may be used in circuit breakers.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#cf222e>await</span> GetAsync<span style=color:#1f2328>(</span>cancelTokenSource<span style=color:#1f2328>.</span>Token<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#57606a>// Other calls within the method may not need this restricted timeout so the original</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#57606a>// cancellation token is used instead.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>await</span> DoOtherThingAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h3 id=cancelling-uncancellable-operations>Cancelling uncancellable operations</h3><p>Sometimes you may find the need to call an API which does not accept a cancellation token, but your API receives a token and is expected to respect cancellation. In this case the typical pattern involves managing two tasks and effectively abandoning the un-cancellable operation after the token signals.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;</span> DoThingAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>var</span> tcs <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> TaskCompetionSource<span style=color:#1f2328>&lt;</span><span style=color:#cf222e>int</span><span style=color:#1f2328>&gt;();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#cf222e>using</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>var</span> registration <span style=color:#1f2328>=</span> cancellationToken<span style=color:#1f2328>.</span>Register<span style=color:#1f2328>(()</span> <span style=color:#1f2328>=&gt;</span> tcs<span style=color:#1f2328>.</span>SetResult<span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>)))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         <span style=color:#cf222e>var</span> completedTask <span style=color:#1f2328>=</span> <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAny<span style=color:#1f2328>(</span>tcs<span style=color:#1f2328>.</span>Task<span style=color:#1f2328>,</span> DoNonCancellableCallAsync<span style=color:#1f2328>());</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>         <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>completedTask <span style=color:#1f2328>==</span> tcs<span style=color:#1f2328>.</span>Task<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>         <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>             <span style=color:#57606a>// We have been cancelled, so take appropriate action here. At this point in time the non-cancellable call is</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>             <span style=color:#57606a>// still running. Once it completes everything will be properly garbage collected</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>             <span style=color:#cf222e>throw</span> <span style=color:#cf222e>new</span> OperationCanceledException<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>         <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#cf222e>return</span> <span style=color:#cf222e>await</span> completedTask<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=constructors>Constructors</h2><p>Occasionally, you may find yourself wanting to perform asynchronous work during initialization of a class instance. Unfortunately, there is no way to make constructors async.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>Foo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>public</span> Foo<span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> c<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        _a <span style=color:#1f2328>=</span> a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#57606a>// DON&#39;T DO THIS!</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        _b <span style=color:#1f2328>=</span> CallSomethingAsync<span style=color:#1f2328>().</span>SyncResult<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        _c <span style=color:#1f2328>=</span> c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>int</span> _a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>string</span> _b<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>int</span> _c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>There are a couple of different ways to solve this. Here&rsquo;s a pattern I like:</p><ol><li>A public static creator method, which publicly replaces the constructor</li><li>A private async member method, which does the work the constructor used to do</li><li>A private constructor, so callers can&rsquo;t directly instantiate the class by mistake</li></ol><p>So, if I apply the same pattern to the class above the class becomes:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>class</span> <span style=color:#1f2328>Foo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#cf222e>public</span> <span style=color:#cf222e>static</span> <span style=color:#cf222e>async</span> Task<span style=color:#1f2328>&lt;</span>Foo<span style=color:#1f2328>&gt;</span> CreateAsync<span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> c<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        Foo instance <span style=color:#1f2328>=</span> <span style=color:#cf222e>new</span> Foo<span style=color:#1f2328>(</span>a<span style=color:#1f2328>,</span> c<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#cf222e>await</span> instance<span style=color:#1f2328>.</span>InitializeAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#cf222e>return</span> instance<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#cf222e>private</span> Foo<span style=color:#1f2328>(</span><span style=color:#cf222e>int</span> a<span style=color:#1f2328>,</span> <span style=color:#cf222e>int</span> c<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#57606a>// GOOD: readonly keyword is retained</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        _a <span style=color:#1f2328>=</span> a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        _c <span style=color:#1f2328>=</span> c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>async</span> Task InitializeAsync<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#57606a>// GOOD: all async work is performed here</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#57606a>// NOTE: make sure initialization order is correct when porting existing code</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        _b <span style=color:#1f2328>=</span> <span style=color:#cf222e>await</span> CallSomethingAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>int</span> _a<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#cf222e>private</span> <span style=color:#cf222e>readonly</span> <span style=color:#cf222e>int</span> _c<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#cf222e>string</span> _b<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>And we can instantiate the class by calling <code>var foo = await Foo.CreateAsync(1, 2);</code>.</p><p>In cases where the class is part of an inheritance hierarchy, the constructor can be made protected and <code>InitializeAsync</code> can be made protected virtual, so it can be overridden and called from derived classes. Each derived class will need to have its own <code>CreateAsync</code> method.</p><h2 id=parallelism>Parallelism</h2><h3 id=avoid-premature-optimization>Avoid premature optimization</h3><p>It might be very tempting to try to perform parallel work by not immediately awaiting tasks. In some cases, you can make significant performance improvements. However, if not used with care you can end up in debugging hell involving socket or port exhaustion, or database connection pool saturation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>public</span> <span style=color:#cf222e>async</span> Task DoTwoThingsAsync<span style=color:#1f2328>(</span>CancellationToken cancellationToken<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#57606a>// Depending on what you are doing under the covers, this may cause unintended</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#57606a>// consequences such as exhaustion of outgoing sockets or database connections.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#cf222e>var</span> thing1Task <span style=color:#1f2328>=</span> FirstAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#cf222e>var</span> thing2Task <span style=color:#1f2328>=</span> SecondAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>thing1Task<span style=color:#1f2328>,</span> thing2Task<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#57606a>// Prefer sequential execution of asynchronous calls</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#cf222e>await</span> FirstAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#cf222e>await</span> SecondAsync<span style=color:#1f2328>(</span>cancellationToken<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>Using async everywhere generally pays off without having to make any individual piece of code faster via parallelization. When threads aren&rsquo;t blocking you can achieve higher performance with the same amount of CPU.</p><h3 id=avoid-taskfactorystartnew-and-use-taskrun-only-when-needed>Avoid Task.Factory.StartNew, and use Task.Run only when needed</h3><p>Even in the cases where not immediately awaiting is safe, you should avoid <code>Task.Factory.StartNew</code>, and only use <code>Task.Run</code> when you need to run some CPU-bound code asynchronously.</p><p>The main way <code>Task.Factory.StartNew</code> is dangerous is that it can look like tasks are awaited when they aren&rsquo;t. For example, if you <code>async</code>-ify the following code:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>Task<span style=color:#1f2328>.</span>Factory<span style=color:#1f2328>.</span>StartNew<span style=color:#1f2328>(</span>Foo<span style=color:#1f2328>),</span> Task<span style=color:#1f2328>.</span>Factory<span style=color:#1f2328>.</span>StartNew<span style=color:#1f2328>(</span>Foo2<span style=color:#1f2328>)).</span>Wait<span style=color:#1f2328>();</span>
</span></span></code></pre></div><p>be careful because changing the delegate to one that returns <code>Task</code>, <code>Task.Factory.StartNew</code> will now return <code>Task&lt;Task></code>. Awaiting only the outer task will only wait until the actual task starts, not finishes.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// BAD: Only waits until all tasks have been scheduled, not until the actual work has completed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>Task<span style=color:#1f2328>.</span>Factory<span style=color:#1f2328>.</span>StartNew<span style=color:#1f2328>(</span>FooAsync<span style=color:#1f2328>),</span> Task<span style=color:#1f2328>.</span>Factory<span style=color:#1f2328>.</span>StartNew<span style=color:#1f2328>(</span>Foo2Async<span style=color:#1f2328>));</span>
</span></span></code></pre></div><p>Normally what you want to do, when you know delegates are not CPU-bound, is to just use the delegates themselves. This is almost always the right thing to do.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// GOOD: Will wait until the tasks have all completed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>FooAsync<span style=color:#1f2328>(),</span> Foo2Async<span style=color:#1f2328>());</span>
</span></span></code></pre></div><p>However, if you are certain the delegates are CPU-bound, and you want to offload this to the thread pool, you can use <code>Task.Run</code>. It&rsquo;s designed to support async delegates. I&rsquo;d still recommend reading <a href=https://blog.stephencleary.com/2013/10/taskrun-etiquette-and-proper-usage.html>Task.Run Etiquette and Proper Usage</a> for a more thorough explanation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#57606a>// Ok if FooAsync is known to be primarily CPU-bound (especially before going async).</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#57606a>// Will schedule the CPU-bound work like Task.Factory.StartNew does,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#57606a>// and automatically convert Task&lt;Task&gt; into a &#39;proxy&#39; Task that represents the actual work</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#cf222e>await</span> Task<span style=color:#1f2328>.</span>WhenAll<span style=color:#1f2328>(</span>Task<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>(</span>FooAsync<span style=color:#1f2328>),</span> Task<span style=color:#1f2328>.</span>Run<span style=color:#1f2328>(</span>Foo2Async<span style=color:#1f2328>))</span>
</span></span></code></pre></div><p>If, for some extremely unlikely reason, you really do need to use <code>Task.Factory.StartNew</code> you can use <code>Unwrap()</code> or <code>await await</code> to convert a <code>Task&lt;Task></code> into a <code>Task</code> that represents the actual work. I&rsquo;d recommend reading <a href=https://devblogs.microsoft.com/pfxteam/task-run-vs-task-factory-startnew/>Task.Run vs Task.Factory.StartNew</a> for a deeper dive into the topic.</p><h2 id=null-conditionals>Null conditionals</h2><p>Using the null conditional operator with awaitables can be dangerous. Awaiting null throws a <code>NullReferenceException</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// BAD: Will throw NullReferenceException if foo is null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>await</span> foo<span style=color:#1f2328>?.</span>DoStuffAsync<span style=color:#1f2328>()</span>
</span></span></code></pre></div><p>Instead, you must do a manual check first.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a>// GOOD</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span>foo <span style=color:#1f2328>!=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#cf222e>await</span> foo<span style=color:#1f2328>.</span>DoStuffAsync<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>A <a href=https://github.com/dotnet/csharplang/issues/35>Null-conditional await</a> is currently under consideration for future versions of C#, but until then you&rsquo;re stuck with manually checking.</p></div></div></body></html>