<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.152.2"><meta charset=utf-8><link href=https://gmpg.org/xfn/11 rel=profile><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Jamie Magee &#183; Programmer, Engineer, Problem Solver</title><link rel=preload href=/css/poole.css as=style><link rel=preload href=/css/hyde.css as=style><link rel=preload href=/css/poole-overrides.css as=style><link rel=preload href=/css/hyde-overrides.css as=style><link rel=preload href=/css/hyde-x.css as=style><link rel=preload href=/fonts/BerkeleyMono-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" as=style crossorigin><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css as=style crossorigin><link rel=preload href=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js as=script crossorigin><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/poole-overrides.css><link rel=stylesheet href=/css/hyde-overrides.css><link rel=stylesheet href=/css/hyde-x.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" crossorigin><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css crossorigin><style>@font-face{font-family:berkeley mono;src:url(/fonts/BerkeleyMono-Regular.woff2)format('woff2');font-display:swap}.lite-youtube-fallback{aspect-ratio:16/9;display:flex;justify-content:center;align-items:center;flex-direction:column;gap:1em;padding:1em;background-color:#000;color:#fff;text-decoration:none;border-radius:8px;transition:background-color .2s ease}.lite-youtube-fallback:hover{background-color:#333;color:#fff}.lite-youtube-fallback::before{display:block;content:'';border:solid transparent;border-width:2em 0 2em 3em;border-left-color:red;transition:border-left-color .2s ease}.lite-youtube-fallback:hover::before{border-left-color:#fff}.lite-youtube-fallback:focus{outline:2px solid red;outline-offset:2px}</style><link rel=stylesheet href=/css/jamie.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><link rel=alternate type=application/rss+xml href=/index.xml title="Jamie Magee"><meta name=description content><meta name=keywords content><meta name=author content="Jamie Magee"><meta name=robots content="index, follow"><link rel=canonical href=/><meta property="og:url" content="/"><meta property="og:site_name" content="Jamie Magee"><meta property="og:title" content="Jamie Magee"><meta property="og:locale" content="en_gb"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jamie Magee"><script type=module src=https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1/lite-youtube.min.js></script></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><div class=sidebar-head><h1><a href=/>Jamie Magee</a></h1></div><p class=lead>Programmer, Engineer, Problem Solver</p></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a></li><li class=sidebar-nav-item><a href=/about>About</a></li><li class=sidebar-nav-item><a href=/blog>Archive</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/JamieMagee><i class="fa-brands fa-github-square fa-3x"></i></a>
<a href=https://bsky.app/profile/jamiemagee.bsky.social><i class="fa-brands fa-square-bluesky fa-3x"></i></a>
<a href=https://www.linkedin.com/in/jamiemagee1/><i class="fa-brands fa-linkedin fa-3x"></i></a>
<a href=/index.xml type=application/rss+xml><i class="fa-solid fa-rss-square fa-3x"></i></a></li></ul><p>&copy; 2025. <a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></p></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=/blog/wombat-dressing-room-meets-its-match/>Wombat Dressing Room meets its match</a></h1><span class=post-date>Nov 10, 2025 &#183; 4 minute read</span><p>Back in January 2020, Google <a href=https://opensource.googleblog.com/2020/01/wombat-dressing-room-npm-publication_10.html>open sourced Wombat Dressing Room</a>, an npm proxy that solved a fundamental problem: how do you maintain two-factor authentication for npm packages while still using automation? For teams managing dozens or hundreds of packages, manually entering 2FA codes for every publish wasn&rsquo;t just inconvenient‚Äîit was a dealbreaker. Fast forward to 2025, and npm has finally introduced native support for trusted publishing using OIDC. Which begs the question: is Wombat Dressing Room still necessary?</p><h2 id=the-problem-wombat-dressing-room-solved>The problem Wombat Dressing Room solved</h2><p>npm has supported two-factor authentication for a long time. But 2FA presents a fundamental challenge for automation. You need &ldquo;something you know&rdquo; (a password) and &ldquo;something you have&rdquo; (a code from an authenticator app). That second factor is difficult to automate, leading many teams to simply disable 2FA in their CI/CD pipelines.</p><p>Wombat Dressing Room took a different approach. Rather than bypassing 2FA, it created a shared proxy server that managed 2FA centrally and provided three key security features:</p><h3 id=per-package-tokens>Per-package tokens</h3><p>The proxy could generate authentication tokens tied to specific GitHub repositories. If a token leaked, an attacker could only compromise the single package associated with that token‚Äînot your entire npm account.</p><h3 id=limited-lifetime-tokens>Limited lifetime tokens</h3><p>Tokens could be configured with a 24 hour lifespan. Even if compromised, the window of vulnerability was limited.</p><h3 id=github-releases-as-2fa>GitHub Releases as 2FA</h3><p>This was the clever bit. Packages could only be published if a corresponding GitHub release with a matching tag existed. This introduced a true &ldquo;second factor&rdquo;, proving access to both the proxy and the GitHub repository.</p><h2 id=enter-npm-trusted-publishing>Enter npm trusted publishing</h2><p>In 2025, npm rolled out <a href=https://docs.npmjs.com/trusted-publishers/>trusted publishing</a>, implementing the <a href=https://repos.openssf.org/trusted-publishers-for-all-package-repositories>OpenSSF trusted publishers standard</a>. It uses OpenID Connect (OIDC) to create a trust relationship between npm and your CI/CD provider. When configured, npm accepts publishes from authorized workflows without requiring long-lived tokens.</p><p>The security benefits are immediately obvious. Traditional npm tokens can be accidentally exposed in CI logs, require manual rotation, and provide persistent access until revoked. Trusted publishing eliminates all of this by using short-lived tokens that are specific to your workflow and can&rsquo;t be extracted or reused.</p><h2 id=setting-it-up>Setting it up</h2><p>The setup process is pretty straightforward. First, you configure a trusted publisher on npmjs.com by specifying your GitHub organization, repository, and workflow filename. Then you update your workflow to request the necessary OIDC permissions:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#0550ae>name</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>Publish Package<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#fff></span><span style=color:#0550ae>on</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fff>  </span><span style=color:#0550ae>push</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#fff>    </span><span style=color:#0550ae>tags</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#fff>      </span>- <span style=color:#0a3069>&#39;v*&#39;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#fff></span><span style=color:#0550ae>permissions</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#fff>  </span><span style=color:#0550ae>id-token</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>write <span style=color:#fff> </span><span style=color:#57606a># Required for OIDC</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#fff>  </span><span style=color:#0550ae>contents</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>read<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#fff></span><span style=color:#0550ae>jobs</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#fff>  </span><span style=color:#0550ae>publish</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#fff>    </span><span style=color:#0550ae>runs-on</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>ubuntu-latest<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#fff>    </span><span style=color:#0550ae>steps</span><span style=color:#1f2328>:</span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#fff>      </span>- <span style=color:#0550ae>uses</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>actions/checkout@v4<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#fff>      </span>- <span style=color:#0550ae>run</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>npm ci<span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#fff>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#fff>      </span>- <span style=color:#0550ae>run</span><span style=color:#1f2328>:</span><span style=color:#fff> </span>npm publish<span style=color:#fff>
</span></span></span></code></pre></div><p>That&rsquo;s it. No more <code>NPM_TOKEN</code> secrets, no more token rotation, no more worrying about accidentally leaking credentials. The npm CLI automatically detects the OIDC environment and handles authentication.</p><p>There&rsquo;s one critical requirement: you need npm CLI version 11.5.1 or later. But if you&rsquo;re using a reasonably recent version of Node.js, you&rsquo;re already covered.</p><h2 id=automatic-provenance-generation>Automatic provenance generation</h2><p>One bonus feature of trusted publishing deserves special mention: automatic provenance generation. When you publish using OIDC from a public repository, npm automatically generates and publishes <a href=https://docs.npmjs.com/generating-provenance-statements>provenance attestations</a> for your package. You don&rsquo;t need to add the <code>--provenance</code> flag‚Äîit just happens.</p><p>Provenance provides cryptographic proof of where and how your package was built, allowing users to verify its authenticity. This transparency is becoming increasingly important as supply chain attacks grow more sophisticated.</p><h2 id=looking-ahead>Looking ahead</h2><p>The introduction of trusted publishing represents a significant maturation of the npm ecosystem. By implementing the OpenSSF standard, npm joins PyPI, RubyGems, and other major package registries in offering OIDC-based publishing. This standardisation makes it easier for developers working across multiple ecosystems to apply consistent security practices.</p><p>Wombat Dressing Room served the community well for over five years, bridging the gap between security requirements and automation needs. Now that npm has addressed those needs natively, the project&rsquo;s retirement feels less like an ending and more like a success story. The best infrastructure tools are those that eventually become unnecessary because their functionality gets absorbed into the platform itself.</p><p>If you&rsquo;re still using long-lived npm tokens in your CI/CD pipelines, trusted publishing is worth the upgrade. The setup is straightforward, the security benefits are substantial, and you&rsquo;ll never have to worry about token rotation again. And if you need any additional validation beyond what trusted publishing provides, you can always implement those checks directly in your workflow.</p></div><div class=post><h1 class=post-title><a href=/blog/understanding-dotnet-base-class-library-vulnerabilities/>Understanding .NET Base Class Library Vulnerabilities</a></h1><span class=post-date>Jul 17, 2025 &#183; 5 minute read</span><p>When you create a new .NET project and start writing code, you might find yourself using classes like <code>System.Text.Json.JsonSerializer</code> without ever explicitly adding a reference to <code>System.Text.Json</code> in your <code>.csproj</code> file. This isn&rsquo;t magic‚Äîit&rsquo;s because these Base Class Libraries (BCLs) are shipped as part of the .NET runtime itself, making them implicit references that are automatically available to your application.</p><p>But this convenience comes with a hidden security implication that many developers don&rsquo;t realize: when a vulnerability is discovered in one of these implicit dependencies, patching it isn&rsquo;t as straightforward as updating a NuGet package reference.</p><h2 id=the-invisible-dependency-problem>The invisible dependency problem</h2><p>Let&rsquo;s start with a real-world example. In October 2024, Microsoft disclosed <a href=https://github.com/advisories/GHSA-8g4q-xg66-9fp4>CVE-2024-43485</a>, a high-severity denial of service vulnerability in <code>System.Text.Json</code>. The vulnerability affects applications that deserialize input to a model with a <code>[JsonExtensionData]</code> property.</p><p>Here&rsquo;s the catch: if you look at your <code>.csproj</code> file, you probably won&rsquo;t see any explicit reference to <code>System.Text.Json</code>. Yet your application might still be vulnerable. This is because <code>System.Text.Json</code> is part of the .NET runtime&rsquo;s Base Class Library, making it an implicit dependency that&rsquo;s automatically available to all .NET applications.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#0550ae>&lt;Project</span> <span style=color:#1f2328>Sdk=</span><span style=color:#0a3069>&#34;Microsoft.NET.Sdk&#34;</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#0550ae>&lt;PropertyGroup&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#0550ae>&lt;TargetFramework&gt;</span>net8.0<span style=color:#0550ae>&lt;/TargetFramework&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#0550ae>&lt;/PropertyGroup&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#57606a>&lt;!-- No explicit System.Text.Json reference, but you can still use it --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#0550ae>&lt;/Project&gt;</span>
</span></span></code></pre></div><h2 id=two-paths-to-patching>Two paths to patching</h2><p>When facing a vulnerability in an implicit dependency like this, you have two main options to ensure your application is secure:</p><h3 id=option-1-add-an-explicit-reference>Option 1: Add an explicit reference</h3><p>The most obvious solution is to add an explicit package reference to the vulnerable library:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#0550ae>&lt;Project</span> <span style=color:#1f2328>Sdk=</span><span style=color:#0a3069>&#34;Microsoft.NET.Sdk&#34;</span><span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#0550ae>&lt;PropertyGroup&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#0550ae>&lt;TargetFramework&gt;</span>net8.0<span style=color:#0550ae>&lt;/TargetFramework&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#0550ae>&lt;/PropertyGroup&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#0550ae>&lt;PackageReference</span> <span style=color:#1f2328>Include=</span><span style=color:#0a3069>&#34;System.Text.Json&#34;</span> <span style=color:#1f2328>Version=</span><span style=color:#0a3069>&#34;8.0.5&#34;</span> <span style=color:#0550ae>/&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#0550ae>&lt;/Project&gt;</span>
</span></span></code></pre></div><p>This approach leverages NuGet&rsquo;s <a href=https://learn.microsoft.com/en-us/nuget/concepts/dependency-resolution#direct-dependency-wins>&ldquo;direct dependency wins&rdquo;</a> rule. When your application has both an implicit dependency (from the runtime) and an explicit dependency (from your <code>.csproj</code>), the explicit one takes precedence, but only if the explicit version is equal to or higher than the BCL version in the runtime.</p><p>Here&rsquo;s the crucial detail: if you specify a lower version than what&rsquo;s bundled with the runtime, .NET will still use the runtime version. For example, if your runtime includes <code>System.Text.Json</code> version 8.0.4 and you explicitly reference version 8.0.2, the runtime version (8.0.4) will be used. This means you can&rsquo;t accidentally downgrade to a vulnerable version, but it also means your explicit reference must be at least as recent as the runtime version to take effect.</p><p>While this works, it&rsquo;s not a scalable long-term solution. The .NET runtime includes hundreds of libraries, and making all implicit references explicit would significantly clutter your project files and create a maintenance burden.</p><h3 id=option-2-set-a-minimum-sdk-version-with-globaljson>Option 2: Set a minimum SDK version with global.json</h3><p>A more sustainable approach is to use <code>global.json</code> to specify a minimum .NET SDK version that includes the patched libraries:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#0550ae>&#34;sdk&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#0550ae>&#34;version&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;8.0.110&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#0550ae>&#34;rollForward&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;latestFeature&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>This ensures that anyone building your project‚Äîwhether locally, in CI/CD, or when deploying‚Äîuses at least the specified SDK version, which includes the security patches for all Base Class Libraries.</p><h2 id=the-self-contained-deployment-consideration>The self-contained deployment consideration</h2><p>This distinction becomes even more critical if you&rsquo;re shipping <a href=https://learn.microsoft.com/en-us/dotnet/core/deploying/#publish-self-contained>self-contained applications</a>. When you publish a self-contained app, the .NET runtime is bundled with your application, including all the Base Class Libraries. If you build your self-contained app with an older SDK that contains vulnerable libraries, those vulnerabilities get shipped with your application.</p><p>For self-contained deployments, ensuring you&rsquo;re building with an up-to-date SDK isn&rsquo;t just about development convenience‚Äîit&rsquo;s a security requirement. A <code>global.json</code> file becomes essential for maintaining a security baseline across your entire deployment pipeline.</p><h2 id=the-current-developer-experience-pain>The current developer experience pain</h2><p>Currently, if you don&rsquo;t have the correct SDK version installed and try to build a project with a <code>global.json</code> requirement, you&rsquo;ll encounter an often inscrutable error message.</p><p>The good news is that the .NET team is aware of the problem. There&rsquo;s an ongoing effort tracked in <a href=https://github.com/dotnet/cli-lab/issues/390>dotnet/cli-lab#390</a> to create a .NET bootstrapper that will improve SDK acquisition and provide better error messages. This work aims to make .NET 10 much more user-friendly when dealing with SDK version mismatches.</p><h2 id=a-familiar-challenge-in-other-runtimes>A familiar challenge in other runtimes</h2><p>This pattern of implicit runtime dependencies isn&rsquo;t unique to .NET. Java developers face a remarkably similar challenge with the Java standard library. When a vulnerability is discovered in a core Java package like <code>java.util</code> or <code>java.security</code>, the remediation path typically involves updating the entire Java Runtime Environment (JRE) or Java Development Kit (JDK).</p><p>For example, when CVE-2022-21449 was discovered in Java&rsquo;s elliptic curve signature verification, applications using ECDSA signatures were vulnerable regardless of whether they explicitly imported the affected classes. The fix required updating to a patched version of the JRE.</p><p>However, Java&rsquo;s ecosystem has traditionally been more rigid in this regard. While .NET allows you to override BCL versions with explicit NuGet references (leveraging the &ldquo;direct dependency wins&rdquo; rule), Java applications are typically bound to whatever version of the standard library comes with their runtime. This makes the <code>global.json</code> approach even more critical in the .NET world, as it&rsquo;s often your most practical option.</p><p>The key difference is that .NET&rsquo;s package management system provides more flexibility‚Äîyou can sometimes work around runtime library issues with explicit package references, whereas Java applications usually have no choice but to update their entire runtime environment.</p><h2 id=the-path-forward>The path forward</h2><p>The implicit nature of .NET&rsquo;s Base Class Libraries provides excellent developer productivity, but it also creates a unique security challenge. Unlike traditional NuGet dependencies that appear in your project file, BCL vulnerabilities require a different approach to remediation.</p><p>By understanding this distinction and adopting <code>global.json</code> as part of your security strategy, you can ensure your applications stay protected against vulnerabilities in both explicit and implicit dependencies. And with the improvements coming in .NET 10, this process should become much more seamless for developers.</p></div><div class=post><h1 class=post-title><a href=/blog/honey-i-shrunk-the-npm-package/>Honey, I shrunk the npm package</a></h1><span class=post-date>Sep 27, 2023 &#183; 11 minute read</span><p>Have you ever wondered what lies beneath the surface of an npm package? At its heart, it‚Äôs nothing more than a gzipped tarball. Working in software development, source code and binary artifacts are nearly always shipped as <code>.tar.gz</code> or <code>.tgz</code> files. And gzip compression is supported by every HTTP server and web browser out there. <a href=http://caniuse.com>caniuse.com</a> doesn‚Äôt even give statistics for support, it just says ‚Äú<a href=https://caniuse.com/sr_content-encoding-gzip>supported in effectively all browsers</a>‚Äù. But here&rsquo;s the kicker: gzip is starting to show its age, making way for newer, more modern compression algorithms like Brotli and ZStandard. Now, imagine a world where npm embraces one of these new algorithms. In this blog post, I&rsquo;ll dive into the realm of compression and explore the possibilities of modernising npm&rsquo;s compression strategy.</p><h2 id=whats-the-competition>What‚Äôs the competition?</h2><p>The two major players in this space are Brotli and ZStandard (or zstd for short). Brotli was released by Google in 2013 and zstd was released by Facebook in 2016. They‚Äôve since been standardised, in <a href=https://datatracker.ietf.org/doc/html/rfc7932>RFC 7932</a> and <a href=https://datatracker.ietf.org/doc/html/rfc8478>RFC 8478</a> respectively, and have seen widespread use all over the software industry. It was actually <a href=https://archlinux.org/news/now-using-zstandard-instead-of-xz-for-package-compression/>the announcement</a> by Arch Linux that they were going to start compressing their packages with zstd by default that made think about this in the first place. Arch Linux was by no means the first project, nor is it the only one. But to find out if it makes sense for the Node ecosystem, I need to do some benchmarks. And that means breaking out <code>tar</code>.</p><h2 id=benchmarking-part-1>Benchmarking part 1</h2><figure><img src=/img/xkcd-1168.png alt=https://xkcd.com/1168/ title="I don't know what's worse--the fact that after 15 years of using tar I still can't keep the flags straight, or that after 15 years of technological advancement I'm still mucking with tar flags that were 15 years old when I started."><figcaption>https://xkcd.com/1168</figcaption></figure><p>I‚Äôm going to start with <code>tar</code> and see what sort of comparisons I can get by switching gzip, Brotli, and zstd. I‚Äôll test with <a href=https://www.npmjs.com/package/npm>the npm package of npm itself</a> as it‚Äôs a pretty popular package, averaging over 4 million downloads a week, while also being quite large at around 11MB unpacked.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl --remote-name https://registry.npmjs.org/npm/-/npm-9.7.1.tgz
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ ls -l --human npm-9.7.1.tgz 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>-rw-r--r-- <span style=color:#0550ae>1</span> jamie users 2.6M Jun <span style=color:#0550ae>16</span> 20:30 npm-9.7.1.tgz 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>$ tar --extract --gzip --file npm-9.7.1.tgz
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>$ du --summarize --human --apparent-size package
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>11M	package
</span></span></code></pre></div><p>gzip is already giving good results, compressing 11MB to 2.6MB for a compression ratio of around 0.24. But what can the contenders do? I‚Äôm going to stick with the default options for now:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ brotli --version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>brotli 1.0.9
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>$ tar --use-compress-program brotli --create --file npm-9.7.1.tar.br package
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>$ zstd --version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>*** Zstandard CLI <span style=color:#0550ae>(</span>64-bit<span style=color:#0550ae>)</span> v1.5.5, by Yann Collet ***
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>$ tar --use-compress-program zstd --create --file npm-9.7.1.tar.zst package
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>$ ls -l --human npm-9.7.1.tgz npm-9.7.1.tar.br npm-9.7.1.tar.zst 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>-rw-r--r-- <span style=color:#0550ae>1</span> jamie users 1.6M Jun <span style=color:#0550ae>16</span> 21:14 npm-9.7.1.tar.br
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>-rw-r--r-- <span style=color:#0550ae>1</span> jamie users 2.3M Jun <span style=color:#0550ae>16</span> 21:14 npm-9.7.1.tar.zst
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>-rw-r--r-- <span style=color:#0550ae>1</span> jamie users 2.6M Jun <span style=color:#0550ae>16</span> 20:30 npm-9.7.1.tgz 
</span></span></code></pre></div><p>Wow! With no configuration both Brotli and zstd come out ahead of gzip, but Brotli is the clear winner here. It manages a compression ratio of 0.15 versus zstd‚Äôs 0.21. In real terms that means a saving of around 1MB. That doesn‚Äôt sound like much, but at 4 million weekly downloads, that would save 4TB of bandwidth per week.</p><h2 id=benchmarking-part-2-electric-boogaloo>Benchmarking part 2: Electric boogaloo</h2><p>The compression ratio is only telling half of the story. Actually, it‚Äôs a third of the story, but compression speed isn‚Äôt really a concern. Compression of a package only happens once, when a package is published, but decompression happens every time you run <code>npm install</code>. So any time saved decompressing packages means quicker install or build steps.</p><p>To test this, I‚Äôm going to use <a href=https://github.com/sharkdp/hyperfine>hyperfine</a>, a command-line benchmarking tool. Decompressing each of the packages I created earlier 100 times should give me a good idea of the relative decompression speed.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ hyperfine --runs <span style=color:#0550ae>100</span> --export-markdown hyperfine.md <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#0a3069></span>  <span style=color:#0a3069>&#39;tar --use-compress-program brotli --extract --file npm-9.7.1.tar.br --overwrite&#39;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#0a3069></span>  <span style=color:#0a3069>&#39;tar --use-compress-program zstd --extract --file npm-9.7.1.tar.zst --overwrite&#39;</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#0a3069></span>  <span style=color:#0a3069>&#39;tar --use-compress-program gzip --extract --file npm-9.7.1.tgz --overwrite&#39;</span>
</span></span></code></pre></div><table><thead><tr><th>Command</th><th>Mean [ms]</th><th>Min [ms]</th><th>Max [ms]</th><th>Relative</th></tr></thead><tbody><tr><td>tar &ndash;use-compress-program brotli &ndash;extract &ndash;file npm-9.7.1.tar.br &ndash;overwrite</td><td>51.6 ¬± 3.0</td><td>47.9</td><td>57.3</td><td>1.31 ¬± 0.12</td></tr><tr><td>tar &ndash;use-compress-program zstd &ndash;extract &ndash;file npm-9.7.1.tar.zst &ndash;overwrite</td><td>39.5 ¬± 3.0</td><td>33.5</td><td>51.8</td><td>1.00</td></tr><tr><td>tar &ndash;use-compress-program gzip &ndash;extract &ndash;file npm-9.7.1.tgz &ndash;overwrite</td><td>47.0 ¬± 1.7</td><td>44.0</td><td>54.9</td><td>1.19 ¬± 0.10</td></tr></tbody></table><p>This time zstd comes out in front, followed by gzip and Brotli. This makes sense, as ‚Äúreal-time compression‚Äù is one of the big features that is touted in <a href=https://facebook.github.io/zstd/>zstd‚Äôs documentation</a>. While Brotli is 31% slower compared to zstd, in real terms it&rsquo;s only 12ms. And compared to gzip, it‚Äôs only 5ms slower. To put that into context, you‚Äôd need a more than 1Gbps connection to make up for the 5ms loss it has in decompression compared with the 1MB it saves in package size.</p><h2 id=benchmarking-part-3-this-time-its-serious>Benchmarking part 3: This time it‚Äôs serious</h2><p>Up until now I‚Äôve just been looking at Brotli and zstd‚Äôs default settings, but both have a lot of knobs and dials that you can adjust to change the compression ratio and compression or decompression speed. Thankfully, the industry standard <a href=https://github.com/inikep/lzbench>lzbench</a> has got me covered. It can run through all of the different quality levels for each compressor, and spit out a nice table with all the data at the end.</p><p>But before I dive in, there are a few caveats I should point out. The first is that lzbench isn‚Äôt able to compress an entire directory like <code>tar</code> , so I opted to use <code>lib/npm.js</code> for this test. The second is that lzbench doesn‚Äôt include the gzip tool. Instead it uses zlib, the underlying gzip library. The last is that the versions of each compressor aren‚Äôt quite current. The latest version of zstd is 1.5.5, released on April 4th 2023, whereas lzbench uses version 1.4.5, released on May 22nd 2020. The latest version of Brotli is 1.0.9, released on August 27th 2020, whereas lzbench uses a version released on October 1st 2019.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ lzbench -o1 -ezlib/zstd/brotli package/lib/npm.js
</span></span></code></pre></div><details><summary>Click to expand results</summary><table><thead><tr><th>Compressor name</th><th>Compression</th><th>Decompress.</th><th>Compr. size</th><th>Ratio</th><th>Filename</th></tr></thead><tbody><tr><td>memcpy</td><td>117330 MB/s</td><td>121675 MB/s</td><td>13141</td><td>100.00</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -1</td><td>332 MB/s</td><td>950 MB/s</td><td>5000</td><td>38.05</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -2</td><td>382 MB/s</td><td>965 MB/s</td><td>4876</td><td>37.11</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -3</td><td>304 MB/s</td><td>986 MB/s</td><td>4774</td><td>36.33</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -4</td><td>270 MB/s</td><td>1009 MB/s</td><td>4539</td><td>34.54</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -5</td><td>204 MB/s</td><td>982 MB/s</td><td>4452</td><td>33.88</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -6</td><td>150 MB/s</td><td>983 MB/s</td><td>4425</td><td>33.67</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -7</td><td>125 MB/s</td><td>983 MB/s</td><td>4421</td><td>33.64</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -8</td><td>92 MB/s</td><td>989 MB/s</td><td>4419</td><td>33.63</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -9</td><td>95 MB/s</td><td>986 MB/s</td><td>4419</td><td>33.63</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -1</td><td>594 MB/s</td><td>1619 MB/s</td><td>4793</td><td>36.47</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -2</td><td>556 MB/s</td><td>1423 MB/s</td><td>4881</td><td>37.14</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -3</td><td>510 MB/s</td><td>1560 MB/s</td><td>4686</td><td>35.66</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -4</td><td>338 MB/s</td><td>1584 MB/s</td><td>4510</td><td>34.32</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -5</td><td>275 MB/s</td><td>1647 MB/s</td><td>4455</td><td>33.90</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -6</td><td>216 MB/s</td><td>1656 MB/s</td><td>4439</td><td>33.78</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -7</td><td>140 MB/s</td><td>1665 MB/s</td><td>4422</td><td>33.65</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -8</td><td>101 MB/s</td><td>1714 MB/s</td><td>4416</td><td>33.60</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -9</td><td>97 MB/s</td><td>1673 MB/s</td><td>4410</td><td>33.56</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -10</td><td>97 MB/s</td><td>1672 MB/s</td><td>4410</td><td>33.56</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -11</td><td>37 MB/s</td><td>1665 MB/s</td><td>4371</td><td>33.26</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -12</td><td>27 MB/s</td><td>1637 MB/s</td><td>4336</td><td>33.00</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -13</td><td>20 MB/s</td><td>1601 MB/s</td><td>4310</td><td>32.80</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -14</td><td>18 MB/s</td><td>1582 MB/s</td><td>4309</td><td>32.79</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -15</td><td>18 MB/s</td><td>1582 MB/s</td><td>4309</td><td>32.79</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -16</td><td>9.03 MB/s</td><td>1556 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -17</td><td>8.86 MB/s</td><td>1559 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -18</td><td>8.86 MB/s</td><td>1558 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -19</td><td>8.86 MB/s</td><td>1559 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -20</td><td>8.85 MB/s</td><td>1558 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -21</td><td>8.86 MB/s</td><td>1559 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -22</td><td>8.86 MB/s</td><td>1589 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -0</td><td>604 MB/s</td><td>813 MB/s</td><td>5182</td><td>39.43</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -1</td><td>445 MB/s</td><td>775 MB/s</td><td>5148</td><td>39.18</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -2</td><td>347 MB/s</td><td>947 MB/s</td><td>4727</td><td>35.97</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -3</td><td>266 MB/s</td><td>936 MB/s</td><td>4645</td><td>35.35</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -4</td><td>164 MB/s</td><td>930 MB/s</td><td>4559</td><td>34.69</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -5</td><td>135 MB/s</td><td>944 MB/s</td><td>4276</td><td>32.54</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -6</td><td>129 MB/s</td><td>949 MB/s</td><td>4257</td><td>32.39</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -7</td><td>103 MB/s</td><td>953 MB/s</td><td>4244</td><td>32.30</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -8</td><td>84 MB/s</td><td>919 MB/s</td><td>4240</td><td>32.27</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -9</td><td>7.74 MB/s</td><td>958 MB/s</td><td>4237</td><td>32.24</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -10</td><td>4.35 MB/s</td><td>690 MB/s</td><td>3916</td><td>29.80</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -11</td><td>1.59 MB/s</td><td>761 MB/s</td><td>3808</td><td>28.98</td><td>package/lib/npm.js</td></tr></tbody></table></details><p>This pretty much confirms what I‚Äôve shown up to now. zstd is able to provide faster decompression speed than either gzip or Brotli, and slightly edge out gzip in compression ratio. Brotli, on the other hand, has comparable decompression speeds and compression ratio with gzip at lower quality levels, but at levels 10 and 11 it‚Äôs able to edge out both gzip and zstd‚Äôs compression ratio.</p><h2 id=everything-is-derivative>Everything is derivative</h2><p>Now that I‚Äôve finished with benchmarking, I need to step back and look at my original idea of replacing gzip as npm‚Äôs compression standard. As it turns out, Evan Hahn had a similar idea in 2022 and proposed <a href=https://github.com/npm/rfcs/pull/595>an npm RFC</a>. He proposed using Zopfli, a backwards-compatible gzip compression library, and Brotli‚Äôs older (and cooler üòé) sibling. Zopfli is able to produce smaller artifacts with the trade-off of a much slower compression speed. In theory an easy win for the npm ecosystem. And if you watch <a href="https://www.youtube.com/watch?v=sDsq_i1Q4Lc&amp;t=170s">the RFC meeting recording</a> or read <a href=https://github.com/npm/rfcs/blob/main/meetings/2022-06-01.md#pr-595-propose-backwards-compatible-improvements-to-compression---evanhahn>the meeting notes</a>, everyone seems hugely in favour of the proposal. However, the one big roadblock that prevents this RFC from being immediately accepted, and ultimately results in it being abandoned, is the lack of a native JavaScript implementation.</p><p>Learning from this earlier RFC and my results from benchmarking Brotli and zstd, what would it take to build a strong RFC of my own?</p><h2 id=putting-it-all-together>Putting it all together</h2><p>Both Brotli and zstd‚Äôs reference implementations are written in C. And while there are a lot of ports on the npm registry using Emscripten or WASM, Brotli has an implementation in <a href=https://nodejs.org/api/zlib.html>Node.js‚Äôs zlib module</a>, and has done <a href=https://nodejs.org/en/blog/release/v10.16.0>since Node.js 10.16.0</a>, released in May 2019. I opened <a href=https://github.com/nodejs/node/issues/48412>an issue in Node.js‚Äôs GitHub repo</a> to add support for zstd, but it‚Äôll take a long time to make its way into an LTS release, nevermind the rest of npm‚Äôs dependency chain. I was already leaning towards Brotli, but this just seals the deal.</p><p>Deciding on an algorithm is one thing, but implementing it is another. npm‚Äôs current support for gzip compression ultimately comes from Node.js itself. But the dependency chain between npm and Node.js is long and slightly different depending on if you‚Äôre packing or unpacking a package.</p><p>The dependency chain for packing, as in <code>npm pack</code> or <code>npm publish</code>, is:</p><p><a href=https://www.npmjs.com/package/npm>npm</a> ‚Üí <a href=https://www.npmjs.com/package/libnpmpack>libnpmpack</a> ‚Üí <a href=https://www.npmjs.com/package/pacote>pacote</a> ‚Üí <a href=https://www.npmjs.com/package/tar>tar</a> ‚Üí <a href=https://www.npmjs.com/package/minizlib>minizlib</a> ‚Üí <a href=https://nodejs.org/api/zlib.html>zlib</a> (Node.js)</p><p>But the dependency chain for unpacking (or ‚Äòreifying‚Äô as npm calls it), as in <code>npm install</code> or <code>npm ci</code> is:</p><p><a href=https://www.npmjs.com/package/npm>npm</a> ‚Üí <a href=https://www.npmjs.com/package/@npmcli/arborist>@npmcli/arborist</a> ‚Üí <a href=https://www.npmjs.com/package/pacote>pacote</a> ‚Üí <a href=https://www.npmjs.com/package/tar>tar</a> ‚Üí <a href=https://www.npmjs.com/package/minizlib>minizlib</a> ‚Üí <a href=https://nodejs.org/api/zlib.html>zlib</a> (Node.js)</p><p>That‚Äôs quite a few packages that need to be updated, but thankfully the first steps have already been taken. Support for Brotli was added to minizlib 1.3.0 back in September 2019. I built on top of that and <a href=https://github.com/isaacs/node-tar/pull/391>contributed Brotil support</a> to <code>tar</code>. That is now <a href=https://github.com/isaacs/node-tar/blob/main/CHANGELOG.md#62>available in version 6.2.0</a>. It may take a while, but I can see a clear path forward.</p><p>The final issue is backwards compatibility. This wasn‚Äôt a concern with Evan Hahn‚Äôs RFC, as Zopfli generates backwards-compatible gzip files. However, Brotli is an entirely new compression format, so I&rsquo;ll need to propose a very careful adoption plan. The process I can see is:</p><ol><li>Support for packing and unpacking is added in a minor release of the current version of npm<ol><li>Unpacking using Brotli is handled transparently</li><li>Packing using Brotli is disabled by default and only enabled if one of the following are true:<ol><li>The <code>engines</code> field in <code>package.json</code> is set to a version of npm that supports Brotli</li><li>The <code>engines</code> field in <code>package.json</code> is set to a version of node that bundles a version of npm that supports Brotli</li><li>Brotli support is explicitly enabled in <code>.npmrc</code></li></ol></li></ol></li><li>Packing using Brotli is enabled by default in the next major release of npm after the LTS version of Node.js that bundles it goes out of support</li></ol><p>Let‚Äôs say that Node.js 22 comes with npm 10, which has Brotli support. Node.js 22 will stop getting LTS updates in April 2027. Then, the next major version of npm after that date should enable Brotli packing by default.</p><p>I admit that this is an <em>incredibly</em> long transition period. However, it will guarantee that if you‚Äôre using a version of Node.js that is still being supported, there will be no visible impact to you. And it still allows early adopters to opt-in to Brotli support. But if anyone has other ideas about how to do this transition, I am open to suggestions.</p><h2 id=whats-next>What‚Äôs next?</h2><p>As I wrap up my exploration into npm compression, I must admit that my journey has only just begun. To push the boundaries further, there are a lot more steps. First and foremost, I need to do some more extensive benchmarking with <a href=https://socket.dev/npm/category/popular>the top 250 most downloaded npm packages</a>, instead of focusing on a single package. Once that‚Äôs complete, I need to draft an npm RFC and seek feedback from the wider community. If you&rsquo;re interested in helping out, or just want to see how it&rsquo;s going, you can follow me on Mastodon at <a href=https://infosec.exchange/@JamieMagee>@JamieMagee@infosec.exchange</a>, or on Twitter at <a href=https://twitter.com/Jamie_Magee>@Jamie_Magee</a>.</p></div><div class=post><h1 class=post-title><a href=/blog/container-plumbing-days-2023-windows-containers/>Container Plumbing Days 2023‚ÄîWindows containers: The forgotten stepchild</a></h1><span class=post-date>May 5, 2023 &#183; 1 minute read</span><p>When it comes to Linux containers, there are plenty of tools out there that can scan container images, generate Software Bill of Materials (SBOM), or list vulnerabilities. However, Windows container images are more like the forgotten stepchild in the container ecosystem. And that means we‚Äôre forgetting the countless developers using Windows containers, too.</p><p>Instead of allowing this gap to widen further, container tool authors‚Äîespecially SBOM tools and vulnerability scanners‚Äîneed to add support for Windows container images.</p><p>In my presentation at <a href=https://containerplumbing.org/>Container Plumbing Days 2023</a> I showed how to extract version information from Windows containers images that can be used to generate SBOMs, as well as how to integrate with the Microsoft Security Updates API which can provide detailed vulnerability information.</p><lite-youtube videoid=RZ4PBDjtrc0 videotitle="Container Plumbing Days 2023: Windows Containers" videoplay=Play posterquality=hqdefault posterloading=lazy><a class=lite-youtube-fallback href="https://www.youtube.com/watch?v=RZ4PBDjtrc0">Watch on YouTube: "Container Plumbing Days 2023: Windows Containers"</a></lite-youtube></div><div class=post><h1 class=post-title><a href=/blog/your-jest-tests-might-be-wrong/>Your Jest tests might be wrong</a></h1><span class=post-date>May 4, 2023 &#183; 7 minute read</span><p>Is your Jest test suite failing you? You might not be using the testing framework&rsquo;s full potential, especially when it comes to preventing state leakage between tests. The Jest settings <a href=https://jestjs.io/docs/configuration#clearmocks-boolean><code>clearMocks</code></a>, <a href=https://jestjs.io/docs/configuration#resetmocks-boolean><code>resetMocks</code></a>, <a href=https://jestjs.io/docs/configuration#restoremocks-boolean><code>restoreMocks</code></a>, and <a href=https://jestjs.io/docs/configuration#resetmodules-boolean><code>resetModules</code></a> are set to <code>false</code> by default. If you haven‚Äôt changed these defaults, your tests might be fragile, order-dependent, or just downright wrong. In this blog post, I‚Äôll dig into what each setting does, and how you can fix your tests.</p><h2 id=clearmocks><code>clearMocks</code></h2><p>First up is <code>clearMocks</code>:</p><blockquote><p>Automatically clear mock calls, instances, contexts and results before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestclearallmocks><code>jest.clearAllMocks()</code></a> before each test. This does not remove any mock implementation that may have been provided.</p></blockquote><p>Every Jest mock has some context associated with it. It‚Äôs how you‚Äôre able to call functions like <code>mockReturnValueOnce</code> instead of only <code>mockReturnValue</code>. But if <code>clearMocks</code> is false by default, then that context can be carried between tests.</p><p>Take this example function:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>export</span> <span style=color:#cf222e>function</span> <span style=color:#1f2328>randomNumber() {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#cf222e>return</span> <span style=color:#6639ba>Math</span><span style=color:#1f2328>.</span><span style=color:#1f2328>random</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>And this simple test for it:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#1f2328>jest</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mock</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;.&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>randomNumber</span> <span style=color:#1f2328>}</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>require</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;.&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>describe</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;tests&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mockReturnValue</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><p>The test passes and works as expected. However, if we add another test to our test suite:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#1f2328>jest</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mock</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;.&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>randomNumber</span> <span style=color:#1f2328>}</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>require</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;.&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>describe</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;tests&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mockReturnValue</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return same number&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random1</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random2</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random1</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random2</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>2</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><p>Our second test fails with the error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#0550ae>(</span>jest.fn<span style=color:#0550ae>())</span>.toBeCalledTimes<span style=color:#0550ae>(</span>expected<span style=color:#0550ae>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Expected number of calls: <span style=color:#0550ae>2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>Received number of calls: <span style=color:#0550ae>3</span>
</span></span></code></pre></div><p>And even worse, if we change the order of our tests:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#1f2328>jest</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mock</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;.&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>randomNumber</span> <span style=color:#1f2328>}</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>require</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;.&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>describe</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;tests&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mockReturnValue</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return same number&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random1</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random2</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random1</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random2</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>2</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><p>We get the same error as before, but this time for <code>should return 42</code> instead of <code>should return same number</code>.</p><p>Enabling <code>clearMocks</code> in your Jest configuration ensures that every mock‚Äôs context is reset between tests. You can achieve the same result by adding <code>jest.clearAllMocks()</code> to your <code>beforeEach()</code> functions. But this isn‚Äôt a great idea as it means you have to remember to add it to each test file to make your tests safe, instead of using <code>clearMocks</code> to make them all safe by default.</p><h2 id=resetmocks><code>resetMocks</code></h2><p>Next up is <code>resetMocks</code>:</p><blockquote><p>Automatically reset mock state before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestresetallmocks><code>jest.resetAllMocks()</code></a> before each test. This will lead to any mocks having their fake implementations removed but does not restore their initial implementation.</p></blockquote><p><code>resetMocks</code> takes <code>clearMocks</code> a step further, by clearing the implementation of any mocks. However, you need to use it in addition to <code>clearMocks</code>.</p><p>Going back to my first example again, I‚Äôm going to move the mock setup inside the first test case <code>randomNumber.mockReturnValue(42);</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#1f2328>describe</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;tests&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mockReturnValue</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42 twice&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random1</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random2</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random1</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random2</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>2</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><p>Logically, you might expect this to fail, but it passes! Jest mocks are global to the file they‚Äôre in. It doesn‚Äôt matter what <code>describe</code>, <code>it</code>, or <code>test</code> scope you use. And if I change the order of tests again, they fail. This makes it very easy to write tests that leak state and are order-dependent.</p><p>Enabling <code>resetMocks</code> in your Jest context ensures that every mock implementation is reset between tests. Like before, you can also add <code>jest.resetAllMocks()</code> to <code>beforeEach()</code> in every test file. But it‚Äôs a much better idea to make your tests safe by default instead of having to opt-in to safe tests.</p><h2 id=restoremocks><strong><code>restoreMocks</code></strong></h2><p>Next is <code>restoreMocks</code>:</p><blockquote><p>Automatically restore mock state and implementation before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestrestoreallmocks><code>jest.restoreAllMocks()</code></a> before each test. This will lead to any mocks having their fake implementations removed and restores their initial implementation.</p></blockquote><p><code>restoreMocks</code> takes test isolation and safety to the next level.</p><p>Let me rewrite my example a little bit, so instead of mocking the function directly, I‚Äôm mocking <code>Math.random()</code> instead.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>randomNumber</span> <span style=color:#1f2328>}</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>require</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;.&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>spy</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>jest</span><span style=color:#1f2328>.</span><span style=color:#1f2328>spyOn</span><span style=color:#1f2328>(</span><span style=color:#6639ba>Math</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#39;random&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>describe</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;tests&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#1f2328>spy</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mockReturnValue</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>spy</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42 twice&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#1f2328>spy</span><span style=color:#1f2328>.</span><span style=color:#1f2328>mockReturnValue</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random1</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random2</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random1</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random2</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>spy</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>2</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><p>With <code>clearMocks</code> and <code>resetMocks</code> enabled, and <code>restoreMocks</code> disabled, my tests pass. But if I enable <code>restoreMocks</code> both tests fail with an error message like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#0550ae>(</span>received<span style=color:#0550ae>)</span>.toBe<span style=color:#0550ae>(</span>expected<span style=color:#0550ae>)</span> // Object.is equality
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Expected: <span style=color:#0550ae>42</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>Received: 0.503533695686772
</span></span></code></pre></div><p><code>restoreMocks</code> has restored the original implementation of <code>Math.random()</code> before each test, so now I‚Äôm getting an actual random number instead of my mocked return value of <code>42</code>. This forces me to be explicit about not only the mocked return values I‚Äôm expecting, but the mocks themselves.</p><p>To fix my tests I can set up my Jest mocks in each individual test.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#1f2328>describe</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;tests&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>spy</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>jest</span><span style=color:#1f2328>.</span><span style=color:#1f2328>spyOn</span><span style=color:#1f2328>(</span><span style=color:#6639ba>Math</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#39;random&#39;</span><span style=color:#1f2328>).</span><span style=color:#1f2328>mockReturnValue</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>spy</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;should return 42 twice&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>spy</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>jest</span><span style=color:#1f2328>.</span><span style=color:#1f2328>spyOn</span><span style=color:#1f2328>(</span><span style=color:#6639ba>Math</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#39;random&#39;</span><span style=color:#1f2328>).</span><span style=color:#1f2328>mockReturnValue</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random1</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#cf222e>const</span> <span style=color:#1f2328>random2</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random1</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>random2</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBe</span><span style=color:#1f2328>(</span><span style=color:#0550ae>42</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(</span><span style=color:#1f2328>spy</span><span style=color:#1f2328>).</span><span style=color:#1f2328>toBeCalledTimes</span><span style=color:#1f2328>(</span><span style=color:#0550ae>2</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><h2 id=resetmodules><code>resetModules</code></h2><p>Finally, we have <code>resetModules</code>:</p><blockquote><p>By default, each test file gets its own independent module registry. Enabling <code>resetModules</code> goes a step further and resets the module registry before running each individual test. This is useful to isolate modules for every test so that the local module state doesn&rsquo;t conflict between tests. This can be done programmatically using <a href=https://jestjs.io/docs/jest-object#jestresetmodules><code>jest.resetModules()</code></a>.</p></blockquote><p>Again, this builds on top of <code>clearMocks</code>, <code>resetMocks</code>, and <code>restoreMocks</code>. I don‚Äôt think this level of isolation is required for most tests, but I‚Äôm a completionist.</p><p>Let‚Äôs take my example from above and expand it to include some initialization that needs to happen before I can call <code>randomNumber</code>. Maybe I need to make sure there‚Äôs enough entropy to generate random numbers? My module might look something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>let</span> <span style=color:#1f2328>isInitialized</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>false</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>export</span> <span style=color:#cf222e>function</span> <span style=color:#1f2328>initialize() {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>isInitialized</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#cf222e>export</span> <span style=color:#cf222e>function</span> <span style=color:#1f2328>randomNumber() {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#0550ae>!</span><span style=color:#1f2328>isInitialized</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#cf222e>throw</span> <span style=color:#cf222e>new</span> <span style=color:#6639ba>Error</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#cf222e>return</span> <span style=color:#6639ba>Math</span><span style=color:#1f2328>.</span><span style=color:#1f2328>random</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>I also want to write some tests to make sure that this works as expected:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>random</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>require</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;.&#39;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#1f2328>describe</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;tests&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;does not throw when initialized&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>random</span><span style=color:#1f2328>.</span><span style=color:#1f2328>initialize</span><span style=color:#1f2328>()).</span><span style=color:#1f2328>not</span><span style=color:#1f2328>.</span><span style=color:#1f2328>toThrow</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>it</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;throws when not initialized&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#1f2328>expect</span><span style=color:#1f2328>(()</span> <span style=color:#0550ae>=&gt;</span> <span style=color:#1f2328>random</span><span style=color:#1f2328>.</span><span style=color:#1f2328>randomNumber</span><span style=color:#1f2328>()).</span><span style=color:#1f2328>toThrow</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><p><code>initialize</code> shouldn‚Äôt throw an error, but <code>randomNumber</code> should throw an error if <code>initialize</code> isn‚Äôt called first. Great! Except it doesn‚Äôt work. Instead I get:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#0550ae>(</span>received<span style=color:#0550ae>)</span>.toThrow<span style=color:#0550ae>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Received <span style=color:#cf222e>function</span> did not throw
</span></span></code></pre></div><p>That‚Äôs because without enabling <code>resetModules</code>, the module is shared between all tests in the file. So when I called <code>random.initialize()</code> in my first test, <code>isInitialized</code> is still true for my second test. But once again, if I were to switch the order of my tests in the file, they would both pass. So my tests are order-dependent again!</p><p>Enabling <code>resetModules</code> will give each test in the file a fresh version of the module for each test. Though, this might actually be a case where you want to use <code>jest.resetAllModules()</code> in your <code>beforeEach()</code> instead of enabling it globally. This kind of isolation isn‚Äôt required for every test. And if you‚Äôre using <code>import</code> instead of <code>require</code>, the syntax can get very awkward very quickly if you‚Äôre trying to avoid an <code>'import' and 'export' may only appear at the top level</code> error.</p><h2 id=tldr-reset-all-of-the-things>TL;DR reset all of the things</h2><p>By default, Jest tests are only isolated at the file level. If you really want to make sure your tests are safe and isolated, add this to your Jest config:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#1f2328>clearMocks</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#1f2328>resetMocks</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#1f2328>restoreMocks</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  <span style=color:#1f2328>resetModules</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>true</span> <span style=color:#57606a>// It depends
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>There is <a href=https://github.com/facebook/jest/issues/10242>a suggestion</a> to make this part of the default configuration. But until then, you‚Äôll have to do it yourself.</p></div><div class=pagination><span class=pagination-item>Newer</span>
<a class=pagination-item href=/page/2/>Older</a></div></div></div></body></html>